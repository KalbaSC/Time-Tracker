<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</title>

  <!-- Tajawal Font -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0b0b; --card:#111213; --accent:#f6c21a; --accent-2:#1f1f1f;
      --text:#f2f2f2; --muted:#aaaaaa;
      --radius:18px; --shadow:0 6px 20px rgba(0,0,0,.25);
      font-family:"Tajawal",sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);padding:20px}
    .container{max-width:900px;margin:auto}

    .card{
      background:linear-gradient(180deg,#141515,#0f0f0f);
      border:1px solid #1f1f1f;
      border-radius:var(--radius);
      padding:20px;
      box-shadow:var(--shadow);
      margin-bottom:20px;
    }

    h2{margin-bottom:14px;color:var(--accent)}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
    input,select,button{
      width:100%;padding:12px;border-radius:12px;
      border:1px solid #2a2a2a;background:#0f0f0f;color:var(--text);
      margin-bottom:10px;font-size:15px;
    }
    button{cursor:pointer;background:var(--accent);color:#111;font-weight:800;border:none}
    button:hover{background:#ffda41}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #222;text-align:right}

    .badge{
      display:inline-block;padding:4px 10px;
      border-radius:999px;background:#1f1f1f;color:#aaa;
      font-size:13px;margin-bottom:10px;
    }

    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 220px}
  </style>
</head>
<body>

<div class="container">

  <div id="loginBox" class="card">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>

    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
    <input id="loginUser" placeholder="Username">

    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input id="loginPass" type="password" placeholder="password">

    <button id="btnLogin">Ø¯Ø®ÙˆÙ„</button>

    <p id="loginMsg" style="color:#aaa;margin-top:8px"></p>
  </div>

  <div id="adminBox" class="card" style="display:none;">
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>

    <span class="badge">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: <span id="userCount">0</span></span>

    <div class="flex">
      <div class="col">
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input id="empName" placeholder="Ø§Ù„Ø§Ø³Ù… ">
      </div>
      <div class="col">
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
        <input id="empId" placeholder="Ù…Ø«Ø§Ù„: 1">
      </div>
      <div class="col">
        <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ PIN</label>
        <input id="empPin" type="password" placeholder="4 Ø£Ø±Ù‚Ø§Ù…">
      </div>
    </div>
<div id="leaveBox" class="card">
  <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</h2>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
        <th>Ø§Ù„Ø±Ù‚Ù…</th>
        <th>Ø§Ù„Ù†ÙˆØ¹</th>
        <th>Ù…Ù†</th>
        <th>Ø¥Ù„Ù‰</th>
        <th>Ø§Ù„Ù…Ø±ÙÙ‚</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody id="leaveTable">
      <tr><td colspan="7" style="text-align:center;color:#777">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</td></tr>
    </tbody>
  </table>
</div>

    <div class="flex">
      <button id="btnAdd" style="flex:1">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>PIN</th><th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="empTable">
        <tr><td colspan="4" style="text-align:center;color:#777">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykiqXB3d-qAQuUEw2PUg2_95LoMwa-BdJ6Ote7PiNXXOh4PlfVdOmIZpL8K0BZ4wJr/exec"; 

const $ = id => document.getElementById(id);

window.onload = () => {
  if (sessionStorage.getItem("adminLogged") === "1") {
    $("loginBox").style.display = "none";
    $("adminBox").style.display = "block";
    loadEmployees();
  }
};
  
$("btnLogin").onclick = () => {
  let u = $("loginUser").value.trim();
  let p = $("loginPass").value.trim();

  if (u === "eman" && p === "eman123") {
    sessionStorage.setItem("adminLogged", "1");
    loadEmployees();
    $("loginBox").style.display = "none";
    $("adminBox").style.display = "block";
  } else {
    $("loginMsg").textContent = "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
  }
};
document.getElementById("loginPass").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    $("btnLogin").click();
  }
});

document.getElementById("loginUser").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    $("btnLogin").click();
  }
});

async function loadEmployees() {
  await fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      action: "getEmployees",
      payload: {}
    })
  });

  loadEmployeesFromCSV();
}

$("btnAdd").onclick = async () => {
  let name = $("empName").value.trim();
  let id = $("empId").value.trim();
  let pin = $("empPin").value.trim();

  if (!name || !id || !pin) return alert("âš ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");

  await fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      action: "addEmployee",
      payload: { name, id, pin }
    })
  });

  alert("âœ” ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  loadEmployees();
};
async function loadEmployeesFromCSV() {
  const url ="https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?gid=0&single=true&output=csv";

  const res = await fetch(url);
  const text = await res.text();

  const rows = text
    .split("\n")
    .map(r => r.split(","))
    .filter(r => r[0] && r[0] !== "ID");

  let html = "";
  rows.forEach(r => {
    const id = r[0].trim();
    const name = r[1].trim();
    const pin = r[2].trim();

    html += `
      <tr>
        <td>${name}</td>
        <td>${id}</td>
        <td>${pin}</td>
        <td>
          <button class="delRowBtn" data-id="${id}" style="
            background:#771a1a;color:white;
            padding:6px 10px;border-radius:8px;
            border:none;cursor:pointer;
          ">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
  });

  $("empTable").innerHTML = html;
  $("userCount").textContent = rows.length;

  // attach delete handlers
  document.querySelectorAll(".delRowBtn").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      if (!confirm("Are you sure you want to delete this employee?")) return;

      await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({
          action: "deleteEmployee",
          payload: { id }
        })
      });

      btn.closest("tr").remove();
      $("userCount").textContent =
        document.querySelectorAll("#empTable tr").length;
    };
  });
}

async function loadLeaves(){
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "getLeavesAll",
      payload: {}
    })
  });

  const text = await res.text();
  let data;
  try {
    data = JSON.parse(text);
  } catch(e) {
    console.log("Cannot parse leaves JSON", text);
    return;
  }
  if (!data.ok) return;

  const leaves = data.leaves;
  if (!leaves.length){
    $("leaveTable").innerHTML =
      `<tr><td colspan="7" style="text-align:center;color:#777">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</td></tr>`;
    return;
  }

  let html = "";
leaves.forEach((lv, index) => {

  let actionsHtml = "";
  if (lv.status === "Pending") {
    actionsHtml = `
      <button class="btn-yellow" onclick="setLeaveStatus(${index+2}, 'Approved')">âœ” Ù‚Ø¨ÙˆÙ„</button>
      <button class="btn-yellow" onclick="setLeaveStatus(${index+2}, 'Rejected')">âœ– Ø±ÙØ¶</button>
    `;
  } else {
    actionsHtml = `<span style="color:#888">â€”</span>`;
  }

  const attachHtml = lv.fileUrl
    ? `<a href="${lv.fileUrl}" target="_blank" style="color:#ffd21f;text-decoration:underline;">Ø¹Ø±Ø¶</a>`
    : `<span style="color:#777">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`;

  html += `
    <tr>
      <td>${lv.name || "-"}</td>
      <td>${lv.id}</td>
      <td>${lv.type}</td>
      <td>${lv.fromDate}</td>
      <td>${lv.toDate}</td>
      <td>${attachHtml}</td>
      <td>${lv.status}</td>
      <td>${actionsHtml}</td>
    </tr>`;
});

  $("leaveTable").innerHTML = html;
}
async function setLeaveStatus(row, status){
  if (!confirm("ØªØ£ÙƒÙŠØ¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;

  await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "updateLeaveStatus",
      payload: { row, status }
    })
  });

  alert("âœ” ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
  loadLeaves();
}

window.onload = () => {
  if (sessionStorage.getItem("adminLogged") === "1") {
    $("loginBox").style.display = "none";
    $("adminBox").style.display = "block";
    loadEmployees();
    loadLeaves();
  }
};

$("btnLogin").onclick = () => {
  let u = $("loginUser").value.trim();
  let p = $("loginPass").value.trim();

  if (u === "eman" && p === "eman123") {
    sessionStorage.setItem("adminLogged", "1");
    $("loginBox").style.display = "none";
    $("adminBox").style.display = "block";
    loadEmployees();
    loadLeaves();
  } else {
    $("loginMsg").textContent = "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
  }
};
  
</script>

</body>
</html>
