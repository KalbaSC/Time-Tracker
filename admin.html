<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>نظام البصمة - نادي كلباء | الموظف</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg: #0a0a0a;
      --card: #121212;
      --accent: #f6c21a;
      --accent-soft: #ffd24a;
      --text: #f5f5f5;
      --muted: #b7b7b7;
      --line: #202020;
      --ok: #22c55e;
      --bad: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --radius: 18px;
      --radius-lg: 22px;
      --shadow: 0 8px 25px rgba(0,0,0,.45);
      font-family: "Tajawal", sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body { background: var(--bg); color: var(--text); min-height: 100vh; }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .uae-header {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px 20px;
      margin-bottom: 15px;
      display: none;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .uae-header .location { display: flex; align-items: center; gap: 8px; color: var(--accent); font-weight: 800; }
    .uae-header .time { display: flex; align-items: center; gap: 8px; color: var(--muted); font-weight: 600; }

    .login-card {
      max-width: 480px;
      margin: 40px auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 22px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .login-card h2 { color: var(--accent); font-weight: 900; margin-bottom: 20px; font-size: 22px; }

    .login-card .uae-info {
      background: rgba(246, 194, 26, 0.1);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(246, 194, 26, 0.3);
      color: var(--accent);
      font-size: 14px;
    }

    label {
      color: var(--muted);
      display: block;
      text-align: right;
      margin-bottom: 6px;
      font-weight: 800;
    }

    input, select {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid #2a2a2a;
      background: #0e0e0e;
      color: #fff;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(246, 194, 26, 0.1);
    }

    .btn-yellow {
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      background: var(--accent);
      color: #111;
      font-weight: 900;
      font-size: 17px;
      border: none;
      cursor: pointer;
      transition: .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: var(--shadow);
    }

    .btn-yellow:hover { background: var(--accent-soft); transform: translateY(-2px); }
    .btn-yellow:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn-punch { padding: 18px; font-size: 18px; margin: 10px 0; }

    .msg {
      margin-top: 10px;
      font-size: 14px;
      font-weight: 800;
      padding: 12px;
      border-radius: 10px;
      display: none;
    }
    .msg.ok { display: block; background: rgba(34, 197, 94, .12); color: var(--ok); border: 1px solid rgba(34, 197, 94, .4); }
    .msg.err { display: block; background: rgba(239, 68, 68, .12); color: var(--bad); border: 1px solid rgba(239, 68, 68, .4); }
    .msg.warning { display: block; background: rgba(245, 158, 11, .12); color: var(--warning); border: 1px solid rgba(245, 158, 11, .4); }

    .toast {
      position: fixed;
      top: 20px;
      left: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--radius);
      background: var(--card);
      border-right: 4px solid var(--accent);
      box-shadow: var(--shadow);
      transform: translateY(-150%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 500px;
      margin: 0 auto;
    }
    .toast.show { transform: translateY(0); }
    .toast.success { border-right-color: var(--ok); }
    .toast.error { border-right-color: var(--bad); }
    .toast.warning { border-right-color: var(--warning); }

    #dash { display: none; }

    .logout-btn {
      background: var(--accent);
      color: #111;
      font-weight: 900;
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: var(--shadow);
      transition: .2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .logout-btn:hover { background: var(--accent-soft); transform: translateY(-2px); }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 15px;
    }

    .card {
      background: linear-gradient(180deg, #151515, #0f0f0f);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
    }
    .card:hover { transform: translateY(-3px); }

    .label {
      color: #d7d7d7;
      font-size: 14px;
      font-weight: 800;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .value { font-size: 28px; font-weight: 900; }
    .card .subtext { font-size: 12px; color: var(--muted); margin-top: 5px; }

    .section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-top: 25px;
    }
    .section h3 { color: var(--accent); font-weight: 900; margin-bottom: 15px; display:flex; align-items:center; gap:8px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 14px; border-bottom: 1px solid var(--line); text-align: right; }
    th { background: rgba(32, 32, 32, 0.5); color: var(--accent); font-weight: 800; }

    .punch-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }

    .leave-status {
      background: rgba(59, 130, 246, 0.1);
      border-radius: var(--radius);
      padding: 15px;
      margin: 15px 0;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .loader { display: none; text-align: center; padding: 20px; color: var(--muted); }
    .loader::after {
      content: "";
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--muted);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .location-status {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 900;
      margin-bottom: 15px;
    }
    .location-status.in { background: rgba(34, 197, 94, 0.1); color: var(--ok); }
    .location-status.out { background: rgba(239, 68, 68, 0.1); color: var(--bad); }

    @media (max-width: 768px) {
      .punch-buttons { grid-template-columns: 1fr; }
      .header-bar { flex-direction: column; align-items: flex-start; }
      th, td { padding: 10px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div id="toast" class="toast"></div>

  <div class="wrap">

    <div id="uaeHeader" class="uae-header">
      <div class="location">
        <i class="fas fa-map-marker-alt"></i>
        <span>نادي كلباء - الإمارات العربية المتحدة</span>
      </div>
      <div class="time">
        <i class="fas fa-clock"></i>
        <span id="uaeTime">--:--</span>
      </div>
    </div>

    <div id="loginBox" class="login-card">
      <h2>تسجيل الدخول</h2>
      <div class="uae-info">
        <i class="fas fa-map-marker-alt"></i>
        <span>نادي كلباء - الإمارات العربية المتحدة</span>
        <div style="margin-top: 5px;">
          <i class="fas fa-clock"></i>
          <span id="loginUaeTime">--:--</span>
        </div>
      </div>

      <label><i class="fas fa-id-card"></i> الرقم الوظيفي</label>
      <input id="empId" placeholder="مثال: 1001" autocomplete="off">

      <label><i class="fas fa-lock"></i> الرمز السري (PIN)</label>
      <input id="empPin" type="password" inputmode="numeric" placeholder="4 أرقام" maxlength="4" autocomplete="off">

      <button class="btn-yellow" onclick="login()">
        <i class="fas fa-sign-in-alt"></i> دخول
      </button>

      <div class="loader" id="loginLoader"></div>
      <div id="loginMsg" class="msg"></div>
    </div>

    <div id="dash">
      <div class="header-bar">
        <div>
          <h1 style="color: var(--accent); margin: 0;">مرحباً <span id="employeeName">...</span></h1>
          <p style="color: var(--muted); margin-top: 5px;">الرقم الوظيفي: <span id="employeeId">...</span></p>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> تسجيل خروج
        </button>
      </div>

      <div class="punch-buttons">
        <button class="btn-yellow btn-punch" onclick="punch('IN')" id="punchInBtn" disabled>
          <i class="fas fa-sign-in-alt"></i> بصمة دخول
        </button>
        <button class="btn-yellow btn-punch" onclick="punch('OUT')" id="punchOutBtn" disabled>
          <i class="fas fa-sign-out-alt"></i> بصمة خروج
        </button>
      </div>

      <div class="grid">
        <div class="card">
          <div class="label"><i class="fas fa-clock"></i> ساعات العمل اليوم</div>
          <div id="sToday" class="value">00:00</div>
          <div class="subtext" id="todayProgress">0% من الوقت المطلوب</div>
        </div>

        <div class="card">
          <div class="label"><i class="fas fa-hourglass-half"></i> المتبقي اليوم</div>
          <div id="sLeft" class="value">00:00</div>
          <div class="subtext">لإكمال اليوم العمل</div>
        </div>

        <div class="card">
          <div class="label"><i class="fas fa-calendar-week"></i> ساعات الأسبوع</div>
          <div id="sWeek" class="value">00:00</div>
          <div class="subtext" id="weekProgress">0 ساعة يومياً</div>
        </div>

        <div class="card">
          <div class="label"><i class="fas fa-history"></i> آخر حركة</div>
          <div id="sLast" class="value">—</div>
          <div class="subtext" id="lastType">—</div>
        </div>
      </div>

      <div id="locationStatus" class="location-status">
        <i class="fas fa-map-marker-alt"></i>
        <span>جاري التحقق من الموقع...</span>
      </div>

      <div id="punchMsg" class="msg"></div>
      <div class="loader" id="punchLoader"></div>

      <div class="section">
        <h3><i class="fas fa-calendar-plus"></i> طلب إجازة</h3>

        <div class="leave-status">
          <h4 style="color: var(--info); margin-bottom: 8px;">
            <i class="fas fa-info-circle"></i> معلومات الإجازة
          </h4>
          <p style="color: var(--muted); font-size: 14px;">
            سيتم مراجعة الطلب من قبل الإدارة.
          </p>
        </div>

        <form id="leaveForm" onsubmit="return submitLeaveForm(event);">
          <input type="hidden" name="id" id="leaveEmpId">

          <label><i class="fas fa-calendar-alt"></i> نوع الإجازة</label>
          <select id="leaveType" name="type">
            <option value="مرضية">مرضية</option>
            <option value="سنوية">سنوية</option>
            <option value="بدون راتب">بدون راتب</option>
            <option value="أخرى">أخرى</option>
          </select>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label><i class="fas fa-calendar-day"></i> من تاريخ</label>
              <input id="leaveFrom" name="fromDate" type="date">
            </div>
            <div>
              <label><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
              <input id="leaveTo" name="toDate" type="date">
            </div>
          </div>

          <label><i class="fas fa-paperclip"></i> ملف الإجازة (اختياري)</label>
          <input type="file" id="leaveFile" name="leaveFile" accept=".pdf,.jpg,.jpeg,.png" />

          <label><i class="fas fa-comment-alt"></i> السبب</label>
          <input id="leaveReason" name="reason" placeholder="اكتب سبب الإجازة">

          <button type="submit" class="btn-yellow" id="submitLeaveBtn">
            <i class="fas fa-paper-plane"></i> إرسال طلب الإجازة
          </button>
        </form>

        <div class="loader" id="leaveLoader"></div>
        <div id="leaveMsg" class="msg"></div>
      </div>

      <div class="section">
        <h3><i class="fas fa-list-alt"></i> بصمات اليوم</h3>
        <table>
          <thead>
            <tr><th>الوقت</th><th>النوع</th><th>الحالة</th></tr>
          </thead>
          <tbody id="todayTable">
            <tr><td colspan="3" style="text-align:center;color:#777">لا يوجد سجلات.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const SCRIPT_URL = "PASTE_YOUR_WEBAPP_URL_HERE";

// Keep your current login CSV approach:
const EMP_CSV = "PASTE_YOUR_PUBLISHED_EMPLOYEES_CSV_HERE";

// IMPORTANT: set this correctly (your file was truncated)
const PUNCH_CSV = "PASTE_YOUR_PUBLISHED_PUNCHES_CSV_HERE";

const UAE_TIMEZONE = "Asia/Dubai";

// expected hours
const EXPECTED_DAY_SEC = 8 * 3600; // 8 hours
const EXPECTED_WEEK_SEC = 40 * 3600; // 40 hours

const $ = id => document.getElementById(id);
const nowHHMM = () => new Date().toTimeString().slice(0,5);

function showToast(message, type='success', duration=3000) {
  const toast = $('toast');
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), duration);
}

function showLoader(id){ const el=$(id); if(el) el.style.display='block'; }
function hideLoader(id){ const el=$(id); if(el) el.style.display='none'; }

function updateUaeTimeUI() {
  const now = new Date();
  const opt = { timeZone: UAE_TIMEZONE, hour:'2-digit', minute:'2-digit', second:'2-digit' };
  const t = new Intl.DateTimeFormat('en-GB', opt).format(now);
  $('uaeTime').textContent = t;
  $('loginUaeTime').textContent = t;
}

function ymd(d){ return d.toISOString().slice(0,10); }

function timeToSec(hhmm) {
  const [h,m] = hhmm.split(":").map(Number);
  return (h||0)*3600 + (m||0)*60;
}
function secToHHMM(sec) {
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  return String(h).padStart(2,'0')+":"+String(m).padStart(2,'0');
}

async function login() {
  const id = $('empId').value.trim();
  const pin = $('empPin').value.trim();
  const msg = $('loginMsg');
  msg.style.display = "none";
  showLoader('loginLoader');

  if (!id || !pin) {
    hideLoader('loginLoader');
    msg.className = "msg err";
    msg.style.display = "block";
    msg.textContent = "❌ يرجى إدخال البيانات";
    showToast('يرجى إدخال البيانات', 'error');
    return;
  }

  if (!/^\d{4}$/.test(pin)) {
    hideLoader('loginLoader');
    msg.className = "msg err";
    msg.style.display = "block";
    msg.textContent = "❌ الرمز السري يجب أن يكون 4 أرقام";
    showToast('الرمز السري يجب أن يكون 4 أرقام', 'error');
    return;
  }

  try {
    const csv = await (await fetch(EMP_CSV)).text();
    const rows = csv.trim().split("\n").map(r => r.split(","));
    const found = rows.find(r => String(r[0]).trim() == id && String(r[2]).trim() == pin);

    if (!found) {
      hideLoader('loginLoader');
      msg.className = "msg err";
      msg.style.display = "block";
      msg.textContent = "❌ البيانات غير صحيحة";
      showToast('بيانات الدخول غير صحيحة', 'error');
      return;
    }

    window.currentID = id;
    window.employeeName = (found[1] || '').trim() || 'موظف';

    $('employeeName').textContent = window.employeeName;
    $('employeeId').textContent = id;
    $('leaveEmpId').value = id;

    $('loginBox').style.display = "none";
    $('dash').style.display = "block";
    $('uaeHeader').style.display = "flex";

    showToast(`مرحباً ${window.employeeName}`, 'success');

    // set date minimum
    const today = ymd(new Date());
    $('leaveFrom').min = today;
    $('leaveTo').min = today;

    await refreshAll();
    enablePunchButtons();

  } catch (e) {
    console.error(e);
    showToast('خطأ في الاتصال بالخادم', 'error');
  } finally {
    hideLoader('loginLoader');
  }
}

function logout() {
  if (!confirm("هل تريد تسجيل الخروج؟")) return;
  window.currentID = null;
  window.employeeName = null;
  $('dash').style.display = "none";
  $('loginBox').style.display = "block";
  $('uaeHeader').style.display = "none";
  $('empId').value = "";
  $('empPin').value = "";
  $('locationStatus').style.display = "none";
  showToast('تم تسجيل الخروج', 'success');
}

function enablePunchButtons() {
  $('punchInBtn').disabled = false;
  $('punchOutBtn').disabled = false;
}

async function getTodayRows() {
  try {
    const csv = await (await fetch(PUNCH_CSV)).text();
    const rows = csv.trim().split("\n").map(r => r.split(","));
    const today = ymd(new Date());

    const mineToday = rows.filter(r =>
      String(r[0]).trim() == window.currentID &&
      String(r[2]).trim() == today
   
