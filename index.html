<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ù„Ø®Ù‘Øµ Ø§Ù„Ø¨ØµÙ…Ø© â€” Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#222222; --accent:#f4e733; --text:#ffffff; --muted:#cfcfcf;
      --panel:#000000; --border:#f4e733; --soft:#444;
      --ok:#2bd886; --warn:#ffc266; --bad:#ff6b6b;
      --radius:16px; --transition: all 0.3s ease;
    }
    html, body { height: 100%; }
    body{
      margin:0; font-family: "Tajawal","NotoKufiArabic",system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
      color:var(--text); background:var(--bg);
      background-image:
        repeating-linear-gradient(45deg, rgba(244,231,51,.08) 0px, rgba(244,231,51,.08) 2px, transparent 2px, transparent 14px),
        repeating-linear-gradient(-45deg, rgba(244,231,51,.06) 0px, rgba(244,231,51,.06) 1px, transparent 1px, transparent 16px),
        radial-gradient(circle at 20% 30%, rgba(244,231,51,.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(244,231,51,.04) 0%, transparent 40%);
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      background:#222; padding:16px 5%; width:90%; margin:0 auto;
      border-bottom:3px solid var(--accent); position:sticky; top:0; z-index:1001;
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .header-right{display:flex; align-items:center; gap:15px; flex:1; min-width:0}
    .header-right img.logo{height:64px; object-fit:contain; transition: var(--transition);}
    .header-right img.logo:hover { transform: scale(1.05); }
    .header-right .divider{width:1.5px; height:60px; background:var(--accent)}
    .header-info{text-align:right} .title{margin:0; font-weight:800; font-size:18px}
    .subtitle{margin:0; font-size:14px; color:var(--accent)}
    
    main{flex:1; width:90%; margin:20px auto; display:grid; gap:16px}
    @media (min-width:1100px){ main{grid-template-columns:1fr 2fr} }
    
    .panel{
      background:var(--panel); border:2px solid var(--border); border-radius:var(--radius);
      padding:20px; box-shadow:0 6px 20px rgba(0,0,0,.25);
      transition: var(--transition);
    }
    .panel:hover { box-shadow: 0 8px 25px rgba(244,231,51,0.15); }
    
    .controls-container { margin-bottom: 20px; }
    .controls-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--soft);
    }
    .controls-title { 
      font-size: 18px; 
      font-weight: 700; 
      color: var(--accent); 
      margin: 0;
    }
    .controls{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:16px; align-items:flex-end}
    .control{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:var(--muted); font-weight: 600;}
    input, select{
      padding:12px 14px; background:#0f0f0f; color:var(--text); 
      border:1px solid #333; border-radius:12px; outline:none;
      transition: var(--transition);
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(244,231,51,0.2);
    }
    input[type="file"]{padding:10px; background:transparent; border:1px dashed #555; cursor: pointer;}
    input[type="file"]:hover { border-color: var(--accent); }
    
    /* Button improvements */
    .btn{
      appearance:none; border:none; border-radius:12px; padding:12px 16px;
      background:var(--accent); color:#000; font-weight:800; cursor:pointer;
      transition:var(--transition); box-shadow:0 4px 0 #a88600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #a88600; }
    .btn:active{transform:translateY(1px); box-shadow:0 3px 0 #a88600}
    .btn.secondary{
      background:#1b1b1b; color:var(--text); border:1px solid #333; box-shadow:none;
    }
    .btn.secondary:hover {
      background: #2a2a2a;
      border-color: var(--accent);
    }
    
    .note{color:var(--muted); font-size:12px; line-height: 1.5;}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    
    .kpi-container { margin: 20px 0; }
    .grid-4{display:grid; gap:12px; margin-top: 15px;}
    @media (min-width:900px){ .grid-4{grid-template-columns:repeat(4,1fr)} }
    .kpi{
      background:#0f0f0f; border:1px solid #333; border-radius:12px; padding:16px;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .kpi:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .kpi .label{font-size:12px; color:#fffde0; margin-bottom: 8px;} 
    .kpi .value{font-size:22px; font-weight:800;}
    .kpi.ok{border-color:rgba(43,216,134,.4)} 
    .kpi.warn{border-color:rgba(255,194,102,.5)}
    .kpi.bad{border-color:rgba(255,107,107,.5)}
    
    .table-container { margin-top: 20px; }
    .table-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px;
    }
    .table-title { 
      font-size: 18px; 
      font-weight: 700; 
      color: var(--accent); 
      margin: 0;
    }
    .table-wrap{
      position:relative; overflow:auto; max-height:70vh; border-radius:12px; 
      outline:1px solid #2a2a2a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .table-wrap::before{
      content:""; position:absolute; inset:-1px; border-radius:12px; pointer-events:none;
      background:linear-gradient(90deg,transparent,rgba(244,231,51,.2),transparent) top/100% 2px no-repeat,
                 linear-gradient(90deg,transparent,rgba(244,231,51,.2),transparent) bottom/100% 2px no-repeat
    }
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:6px}
    thead th{
      position:sticky; top:0; background:#111; z-index:1; text-align:right; 
      padding:14px 12px; font-size:13px; color:#fff17a; border-bottom:1px solid var(--accent);
      font-weight: 700;
    }
    tbody td{padding:12px; border-bottom:1px solid #2a2a2a; vertical-align:top}
    tbody tr{
      transition: var(--transition);
    }
    tbody tr:hover{
      background:#1a1a1a;
      transform: scale(1.005);
    }
    .left{text-align:left} .center{text-align:center}
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px;
      font-weight: 600;
    }
    .pill.ok{background:rgba(43,216,134,.12); color:var(--ok)}
    .pill.warn{background:rgba(255,194,102,.12); color:var(--warn)}
    .pill.bad{background:rgba(255,107,107,.12); color:var(--bad)}
    
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.75); 
      display:none; align-items:center; justify-content:center; z-index:9999;
      backdrop-filter: blur(4px);
    }
    .modal{
      width:min(980px,94vw); max-height:86vh; overflow:auto; 
      background:#0f0f0f; border:2px solid var(--border); border-radius:16px; 
      box-shadow:0 10px 35px rgba(0,0,0,.65);
      animation: modalAppear 0.3s ease-out;
    }
    @keyframes modalAppear {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal header{
      position:sticky; top:0; background:#111; padding:16px 20px; 
      border-bottom:1px solid var(--accent); 
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal h3{margin:0; font-size:18px} 
    .modal .content{padding:16px 20px}
    .close{
      background:#1b1b1b; color:#eee; border:1px solid #333; border-radius:10px; 
      padding:8px 12px; cursor:pointer;
      transition: var(--transition);
    }
    .close:hover {
      background: #2a2a2a;
      border-color: var(--accent);
    }
    
    .muted{color:var(--muted)} 
    .mono{font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace}
    .hint{font-size:12px; color:#fffde0; line-height: 1.5;}
    
    @media (max-width:768px){ 
      .header-right img.logo{height:40px} 
      .header-right .divider{display:none} 
      .controls { grid-template-columns: 1fr; }
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      main { width: 95%; }
    }
    
    @media (max-width:480px) {
      .grid-4 { grid-template-columns: 1fr; }
      .panel { padding: 15px; }
    }
    
    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-ok { background-color: var(--ok); }
    .status-warn { background-color: var(--warn); }
    .status-bad { background-color: var(--bad); }
    
    .section-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--accent), transparent);
      margin: 20px 0;
    }
    
    .file-upload-area {
      border: 2px dashed #555;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      margin-bottom: 15px;
    }
    .file-upload-area:hover {
      border-color: var(--accent);
      background: rgba(244,231,51,0.05);
    }
    .file-upload-area.active {
      border-color: var(--accent);
      background: rgba(244,231,51,0.1);
    }
    .file-upload-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-right">
      <img src="Picture3.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø§Ø±Ù‚Ø©" class="logo">
      <div class="divider"></div>
      <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡" class="logo">
      <div class="header-info">
        <p class="title">Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</p>
        <p class="subtitle">Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ØµÙ…Ø© â€” ÙŠÙˆÙ…ÙŠ / Ø£Ø³Ø¨ÙˆØ¹ÙŠ / Ø´Ù‡Ø±ÙŠ</p>
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="controls-container">
        <div class="controls-header">
          <h2 class="controls-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
          <div class="flex">
            <button id="recalc" class="btn">
              <span class="loading" id="loadingIndicator" style="display:none"></span>
              ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨
            </button>
          </div>
        </div>
        
        <div class="file-upload-area" id="fileUploadArea">
          <div class="file-upload-icon">ğŸ“</div>
          <p>Ø§Ù†Ù‚Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ØµÙ…Ø© (Excel) Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
          <p class="note">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Employee ID, First Name, Date, Time</p>
        </div>
        <input id="file" type="file" accept=".xlsx,.xls" style="display: none;" />

        <div class="controls">
          <div class="control">
            <label>Ø§Ù„Ø¹Ø±Ø¶</label>
            <select id="view">
              <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
              <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
              <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
            </select>
          </div>

          <div class="control">
            <label>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©/Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø£Ø­Ø¯â€“Ø§Ù„Ø®Ù…ÙŠØ³)</label>
            <input id="expectedWD" type="number" min="0" step="0.25" value="7" />
          </div>

          <div class="control">
            <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø³Ø¨Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="expectedSat" type="number" min="0" step="0.25" value="3" />
          </div>

          <div class="control">
            <label>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø³Ø¨Øª</label>
            <select id="satPolicy">
              <option value="punch">Ø§Ø­ØªØ³Ø§Ø¨ ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¨ØµÙ…Ø©</option>
              <option value="calendar">Ø§Ø­ØªØ³Ø§Ø¨ ØªÙ‚ÙˆÙŠÙ…ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§</option>
              <option value="off">Ø¹Ø¯Ù… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø¨Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§</option>
            </select>
          </div>

          <div class="control">
            <label>Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰</label>
            <select id="expectedMode">
              <option value="calendar">Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ÙŠØ©</option>
              <option value="punched">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ Ø¨Ù‡Ø§ Ø¨ØµÙ…Ø©</option>
            </select>
          </div>

          <div class="control">
            <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
            <select id="weekStart">
              <option value="0">Ø§Ù„Ø£Ø­Ø¯</option>
              <option value="1" selected>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
              <option value="6">Ø§Ù„Ø³Ø¨Øª</option>
            </select>
          </div>

          <div class="control">
            <label>ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¯Ø¯</label>
            <select id="rounding">
              <option value="0" selected>Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨</option>
              <option value="1">1 Ø¯Ù‚ÙŠÙ‚Ø©</option>
              <option value="5">5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="10">10 Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="15">15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            </select>
          </div>

          <div class="control">
            <label>ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <input id="empFilter" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" />
          </div>

          <div class="control">
            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="control">
            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="toDate" type="date" />
          </div>
        </div>
        
        <div class="section-divider"></div>
        
        <div class="flex" style="justify-content: space-between; flex-wrap: wrap; gap: 10px;">
          <div>
            <p class="note">
              Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: <b>Employee ID</b>ØŒ <b>First Name</b>ØŒ <b>Date</b>ØŒ <b>Time</b> (Ø£ÙˆÙ‚Ø§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„: IN, OUT, IN, OUTâ€¦). ÙŠÙØªØ¬Ø§Ù‡Ù„ Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„ Ø¨Ù„Ø§ Ø®Ø±ÙˆØ¬.
            </p>
          </div>
          <div class="flex">
            <button id="downloadSummary" class="btn secondary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ CSV (Ø§Ù„Ù…Ù„Ø®Øµ)</button>
            <button id="downloadDetails" class="btn secondary">ğŸ“Š ØªÙ†Ø²ÙŠÙ„ CSV (ØªÙØµÙŠÙ„ÙŠ)</button>
          </div>
        </div>
      </div>

      <div class="kpi-container">
        <h3 class="controls-title">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</h3>
        <div class="grid-4" id="kpis">
          <div class="kpi">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„</div>
            <div class="value" id="kpiWorked">00:00</div>
          </div>
          <div class="kpi">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹</div>
            <div class="value" id="kpiExpected">00:00</div>
          </div>
          <div class="kpi ok">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</div>
            <div class="value" id="kpiOver">00:00</div>
          </div>
          <div class="kpi bad">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Øµ</div>
            <div class="value" id="kpiShort">00:00</div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="table-container">
        <div class="table-header">
          <h2 class="table-title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨ØµÙ…Ø©</h2>
          <div class="note"><span id="meta">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø­Ù…Ù‘Ù„.</span></div>
        </div>

        <div class="table-wrap">
          <table id="table">
            <thead>
              <tr>
                <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ÙØªØ±Ø©</th>
                <th class="left">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th>
                <th class="left">Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹</th>
                <th class="left">Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</th>
                <th class="left">Ø§Ù„Ù†Ù‚Øµ</th>
                <th class="center">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="8" class="note" style="text-align: center; padding: 40px;">Ø­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</td></tr>
            </tbody>
          </table>
        </div>
        <p class="hint" id="hintPolicy" style="margin-top:12px"></p>
      </div>
    </section>
  </main>

  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø©</h3>
        <button class="close" id="closeModal">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
      </header>
      <div class="content">
        <div class="muted" id="modalMeta"></div>
        <div class="table-wrap" style="margin-top:16px; max-height:60vh">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ (Ø¯Ø®ÙˆÙ„ â†’ Ø®Ø±ÙˆØ¬)</th>
                <th class="left">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…</th>
              </tr>
            </thead>
            <tbody id="detailsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const fileInput = $('file'), viewSel = $('view'), weekStartSel = $('weekStart');
  const expectedWDInp = $('expectedWD'), expectedSatInp = $('expectedSat'), satPolicySel = $('satPolicy');
  const expectedModeSel = $('expectedMode'), roundingSel = $('rounding');
  const empFilterInp = $('empFilter'), fromDateInp = $('fromDate'), toDateInp = $('toDate');
  const metaEl = $('meta'), tbody = $('tbody'), hintPolicy = $('hintPolicy');
  const kpiWorked = $('kpiWorked'), kpiExpected = $('kpiExpected'), kpiOver = $('kpiOver'), kpiShort = $('kpiShort');
  const recalcBtn = $('recalc'), dlSumBtn = $('downloadSummary'), dlDetBtn = $('downloadDetails');
  const fileUploadArea = $('fileUploadArea'), loadingIndicator = $('loadingIndicator');

  const modalBackdrop = $('modalBackdrop'), closeModalBtn = $('closeModal'), modalTitle = $('modalTitle'), modalMeta = $('modalMeta'), detailsBody = $('detailsBody');

  let rawRows = [];
  let groupedDetails = new Map();
  let lastSummaryCSV = '', lastDetailedCSV = '';

  // File upload area interaction
  fileUploadArea.addEventListener('click', () => fileInput.click());
  fileUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadArea.classList.add('active');
  });
  fileUploadArea.addEventListener('dragleave', () => {
    fileUploadArea.classList.remove('active');
  });
  fileUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadArea.classList.remove('active');
    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      handleFile();
    }
  });

  fileInput.addEventListener('change', handleFile);
  [recalcBtn, viewSel, weekStartSel, expectedWDInp, expectedSatInp, satPolicySel, expectedModeSel, roundingSel, empFilterInp, fromDateInp, toDateInp]
    .forEach(el => el.addEventListener('change', render));
  closeModalBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', e => { if(e.target===modalBackdrop) closeModal(); });
  dlSumBtn.addEventListener('click', ()=> downloadCSV(lastSummaryCSV, 'timecard_summary.csv'));
  dlDetBtn.addEventListener('click', ()=> downloadCSV(lastDetailedCSV, 'timecard_details.csv'));

  // Set default dates (current month)
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  fromDateInp.value = formatDateForInput(firstDay);
  toDateInp.value = formatDateForInput(lastDay);

  function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
  }

  function downloadCSV(text, filename){
    if (!text){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„ Ø¨Ø¹Ø¯.'); return; }
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = filename; 
    document.body.appendChild(a); 
    a.click(); 
    a.remove();
  }

  function handleFile(){
    const f = fileInput.files?.[0]; 
    if (!f) return;
    
    // Update file upload area text
    fileUploadArea.innerHTML = `
      <div class="file-upload-icon">âœ…</div>
      <p>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${f.name}</p>
      <p class="note">Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    `;
    
    loadingIndicator.style.display = 'inline-block';
    
    const reader = new FileReader();
    reader.onload = evt => {
      try{
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});

        // Find header row - more flexible approach
        let headerIdx = -1;
        let headerRow = null;
        
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (row && row.some(cell => 
            String(cell).toLowerCase().includes('employee') && 
            String(cell).toLowerCase().includes('id')
          )) {
            headerIdx = i;
            headerRow = row;
            break;
          }
        }

        if (headerIdx === -1) { 
          alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ "Employee ID". ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù.'); 
          resetFileUploadArea();
          loadingIndicator.style.display = 'none';
          return; 
        }

        // Map columns more flexibly
        const header = headerRow.map(h => String(h).toLowerCase().trim());
        const colIdx = {
          empId: header.findIndex(h => h.includes('employee') && h.includes('id')),
          name:  header.findIndex(h => h.includes('first') && h.includes('name')),
          date:  header.findIndex(h => h.includes('date')),
          timeList: header.findIndex(h => h.includes('time')),
        };

        // Fallback searches if exact matches not found
        if (colIdx.empId === -1) colIdx.empId = header.findIndex(h => h.includes('id'));
        if (colIdx.name === -1) colIdx.name = header.findIndex(h => h.includes('name'));
        if (colIdx.date === -1) colIdx.date = header.findIndex(h => h.includes('date'));
        if (colIdx.timeList === -1) colIdx.timeList = header.findIndex(h => h.includes('time'));

        console.log('Found columns:', colIdx);

        const out = [];
        for (let i = headerIdx + 1; i < rows.length; i++){
          const r = rows[i]; 
          if (!r || r.length === 0) continue;
          
          const empId = String(r[colIdx.empId] ?? '').trim();
          const name = String(r[colIdx.name] ?? '').trim();
          const dateCell = r[colIdx.date];
          const timesStr = String(r[colIdx.timeList] ?? '').trim();
          
          if (!empId || empId === 'undefined' || !name || name === 'undefined') continue;

          const d = parseExcelDate(dateCell); 
          if (!d) continue;

          const pairs = pairsFromCSV(timesStr);
          const workedSec = sumPairs(pairs, parseInt(roundingSel.value,10)||0);
          out.push({empId, name, date: d, pairs, workedSec});
        }
        
        rawRows = out;
        metaEl.textContent = `${f.name} â€” ØªÙ… ØªØ­Ù„ÙŠÙ„ ${out.length} Ø³Ø¬Ù„ Ø¨ØµÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­`;
        
        fileUploadArea.innerHTML = `
          <div class="file-upload-icon">âœ…</div>
          <p>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${f.name}</p>
          <p class="note">ØªÙ… ØªØ­Ù„ÙŠÙ„ ${out.length} Ø³Ø¬Ù„ Ø¨ØµÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­</p>
        `;
        
        loadingIndicator.style.display = 'none';
        render();
      }catch(err){ 
        console.error('Error processing file:', err); 
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message); 
        resetFileUploadArea();
        loadingIndicator.style.display = 'none';
      }
    };
    reader.readAsArrayBuffer(f);
  }

  function resetFileUploadArea() {
    fileUploadArea.innerHTML = `
      <div class="file-upload-icon">ğŸ“</div>
      <p>Ø§Ù†Ù‚Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ØµÙ…Ø© (Excel) Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
      <p class="note">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Employee ID, First Name, Date, Time</p>
    `;
  }

  function render(){
    if (!rawRows.length){
      tbody.innerHTML = `<tr><td colspan="8" class="note" style="text-align: center; padding: 40px;">Ø­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</td></tr>`;
      lastSummaryCSV = lastDetailedCSV = '';
      updateKPIs(0,0,0,0);
      hintPolicy.textContent = '';
      return;
    }

    // Show loading indicator
    loadingIndicator.style.display = 'inline-block';
    
    // Use setTimeout to allow UI to update before heavy processing
    setTimeout(() => {
      try {
        // filters
        const empFilter = (empFilterInp.value||'').trim().toLowerCase();
        const fromDate = fromDateInp.value ? new Date(fromDateInp.value) : null;
        const toDate = toDateInp.value ? new Date(toDateInp.value) : null;
        const view = viewSel.value;
        const weekStart = parseInt(weekStartSel.value,10);
        const expectedWD = (+expectedWDInp.value||0) * 3600;
        const expectedSat = (+expectedSatInp.value||0) * 3600;
        const satPolicy = satPolicySel.value;
        const expectedMode = expectedModeSel.value;
        const rounding = parseInt(roundingSel.value,10)||0;

        // group data
        const map = new Map();
        for (const row of rawRows){
          if (empFilter && !(row.empId.toLowerCase().includes(empFilter) || row.name.toLowerCase().includes(empFilter))) continue;
          if (fromDate && row.date < fromDate) continue;
          if (toDate && row.date > toDate) continue;

          let periodKey = '';
          if (view === 'daily'){ 
            periodKey = ymd(row.date); 
          } else if (view === 'weekly'){ 
            periodKey = 'W:'+ymd(getWeekStart(row.date, weekStart)); 
          } else { 
            periodKey = 'M:'+ym(row.date); 
          }

          const key = `${row.empId}||${row.name}||${periodKey}`;
          if (!map.has(key)){
            map.set(key, {
              empId: row.empId, 
              name: row.name, 
              period: periodKey, 
              workedSec: 0, 
              days: new Map()
            });
          }
          const obj = map.get(key);
          obj.workedSec += row.workedSec;
          obj.days.set(ymd(row.date), {
            pairs: row.pairs, 
            workedSec: row.workedSec, 
            dow: row.date.getDay()
          });
        }

        // compute expected time and differences
        const summaryRows = [];
        let totalWorked = 0, totalExpected = 0, totalOver = 0, totalShort = 0;
        
        for (const obj of map.values()){
          let expectedSec = 0;

          if (view === 'daily'){
            // For daily view, use the specific day
            const dkey = [...obj.days.keys()][0];
            const info = obj.days.get(dkey);
            expectedSec = calculateExpectedForDay(info.dow, expectedWD, expectedSat, satPolicy, expectedMode, info.pairs.length > 0);
          } else {
            // For weekly/monthly views
            const range = getPeriodRange(obj.period, weekStart);
            if (expectedMode === 'calendar'){
              // Count calendar days
              expectedSec += expectedWD * countWeekdays(range.start, range.end, [0,1,2,3,4]); // Sun-Thu
              if (satPolicy === 'calendar') {
                expectedSec += expectedSat * countWeekdays(range.start, range.end, [6]); // Saturday
              }
            } else {
              // Only count days with punches
              for (const [dkey, info] of obj.days){
                expectedSec += calculateExpectedForDay(info.dow, expectedWD, expectedSat, satPolicy, expectedMode, info.pairs.length > 0);
              }
            }
          }

          const delta = obj.workedSec - expectedSec;
          const over = Math.max(0, delta);
          const short = Math.max(0, -delta);

          totalWorked += obj.workedSec;
          totalExpected += expectedSec;
          totalOver += over;
          totalShort += short;

          summaryRows.push({
            key: `${obj.empId}||${obj.name}||${obj.period}`,
            empId: obj.empId, 
            name: obj.name,
            period: formatPeriodDisplay(obj.period, weekStart),
            workedSec: obj.workedSec,
            expectedSec: expectedSec,
            overSec: over,
            shortSec: short,
            days: obj.days
          });
        }

        // Sort rows
        summaryRows.sort((a,b) => a.empId.localeCompare(b.empId) || a.period.localeCompare(b.period));

        // Render table
        renderTable(summaryRows);

        // Update KPIs
        updateKPIs(totalWorked, totalExpected, totalOver, totalShort);

        // Update policy hint
        updatePolicyHint(expectedMode, satPolicy);

        // Prepare CSV data
        prepareCSVData(summaryRows);

        // Store for modal
        groupedDetails = map;
        
      } catch (error) {
        console.error('Error in render:', error);
        tbody.innerHTML = `<tr><td colspan="8" class="note" style="text-align: center; padding: 40px; color: var(--bad);">Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}</td></tr>`;
      } finally {
        // Hide loading indicator
        loadingIndicator.style.display = 'none';
      }
    }, 50);
  }

  function renderTable(rows) {
    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8" class="note" style="text-align: center; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(row => `
      <tr>
        <td class="mono">${escapeHtml(row.empId)}</td>
        <td>${escapeHtml(row.name)}</td>
        <td>${escapeHtml(row.period)}</td>
        <td class="left">${secondsToHhMm(row.workedSec)}</td>
        <td class="left">${secondsToHhMm(row.expectedSec)}</td>
        <td class="left">${row.overSec > 0 ? `<span class="pill ok">${secondsToHhMm(row.overSec)}</span>` : `<span class="pill">00:00</span>`}</td>
        <td class="left">${row.shortSec > 0 ? `<span class="pill bad">-${secondsToHhMm(row.shortSec)}</span>` : `<span class="pill ok">00:00</span>`}</td>
        <td class="center"><button class="btn secondary" data-key="${escapeHtml(row.key)}">ØªÙØ§ØµÙŠÙ„</button></td>
      </tr>
    `).join('');

    // Add event listeners to detail buttons
    tbody.querySelectorAll('button[data-key]').forEach(btn => {
      btn.addEventListener('click', () => openDetails(btn.getAttribute('data-key')));
    });
  }

  function updateKPIs(worked, expected, over, short){
    kpiWorked.textContent = secondsToHhMm(worked);
    kpiExpected.textContent = secondsToHhMm(expected);
    kpiOver.textContent = secondsToHhMm(over);
    kpiShort.textContent = secondsToHhMm(short);
  }

  function updatePolicyHint(expectedMode, satPolicy) {
    const modeText = expectedMode === 'calendar' ? 'Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ÙŠØ©' : 'Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ Ø¨Ù‡Ø§ Ø¨ØµÙ…Ø©';
    const satText = 
      satPolicy === 'punch' ? 'Ø§Ù„Ø³Ø¨Øª ÙŠÙØ­ØªØ³Ø¨ ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¨ØµÙ…Ø©' :
      satPolicy === 'calendar' ? 'Ø§Ù„Ø³Ø¨Øª ÙŠÙØ­ØªØ³Ø¨ ØªÙ‚ÙˆÙŠÙ…ÙŠÙ‹Ø§ Ø¯Ø§Ø¦Ù…Ù‹Ø§' :
      'Ø§Ù„Ø³Ø¨Øª Ù„Ø§ ÙŠÙØ­ØªØ³Ø¨';
    
    hintPolicy.textContent = `Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: ${modeText} â€” ${satText}. Ø§Ù„Ø¬Ù…Ø¹Ø© Ù…Ø³ØªØ¨Ø¹Ø¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹.`;
  }

  function prepareCSVData(rows) {
    // Summary CSV
    const summaryHeader = ['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„ÙØªØ±Ø©', 'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„', 'Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹', 'Ø§Ù„Ø²ÙŠØ§Ø¯Ø©', 'Ø§Ù„Ù†Ù‚Øµ'];
    const summaryData = rows.map(r => [
      r.empId, r.name, r.period, 
      secondsToHhMm(r.workedSec), 
      secondsToHhMm(r.expectedSec),
      secondsToHhMm(r.overSec),
      r.shortSec > 0 ? `-${secondsToHhMm(r.shortSec)}` : '00:00'
    ]);
    lastSummaryCSV = [summaryHeader, ...summaryData]
      .map(row => row.map(csvEscape).join(','))
      .join('\n');

    // Detailed CSV
    const detailHeader = ['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„ÙØªØ±Ø©', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙŠÙˆÙ…', 'Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ (Ø¯Ø®ÙˆÙ„â†’Ø®Ø±ÙˆØ¬)', 'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„'];
    const detailData = [];
    
    for (const row of rows) {
      const days = [...row.days.keys()].sort();
      for (const dateStr of days) {
        const dayInfo = row.days.get(dateStr);
        const date = parseYmd(dateStr);
        const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        const pairsStr = dayInfo.pairs.map(p => `${p.in}â†’${p.out}`).join('; ');
        
        detailData.push([
          row.empId,
          row.name,
          row.period,
          dateStr,
          dayNames[date.getDay()],
          pairsStr,
          secondsToHhMm(dayInfo.workedSec)
        ]);
      }
    }
    
    lastDetailedCSV = [detailHeader, ...detailData]
      .map(row => row.map(csvEscape).join(','))
      .join('\n');
  }

  function openDetails(key){
    const obj = groupedDetails.get(key);
    if (!obj) return;
    
    modalTitle.textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø© â€” ${obj.name} (${obj.empId})`;
    modalMeta.innerHTML = `Ø§Ù„ÙØªØ±Ø©: <b>${escapeHtml(formatPeriodDisplay(obj.period, parseInt(weekStartSel.value,10)))}</b> â€” Ø£ÙŠØ§Ù… Ù…ØºØ·Ù‘Ø§Ø©: ${obj.days.size}`;

    const days = [...obj.days.keys()].sort();
    detailsBody.innerHTML = days.map(dateStr => {
      const day = obj.days.get(dateStr);
      const pairsHtml = day.pairs.length ? 
        day.pairs.map(p => pairToHtml(p)).join(' &nbsp; ') : 
        '<span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø²ÙˆØ§Ø¬</span>';
      
      const dayNames = ['Ø£Ø­Ø¯', 'Ø§Ø«Ù†ÙŠÙ†', 'Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø®Ù…ÙŠØ³', 'Ø¬Ù…Ø¹Ø©', 'Ø³Ø¨Øª'];
      const dayColor = day.dow === 6 ? 'rgba(255,194,102,.18)' : 
                      day.dow === 5 ? 'rgba(255,107,107,.18)' : 
                      'rgba(244,231,51,.14)';
      
      return `<tr>
        <td>${escapeHtml(dateStr)} <span class="pill" style="background:${dayColor}; color:#fff">${dayNames[day.dow]}</span></td>
        <td>${pairsHtml}</td>
        <td class="left">${secondsToHhMm(day.workedSec)}</td>
      </tr>`;
    }).join('');
    
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden','false');
  }

  function closeModal(){ 
    modalBackdrop.style.display = 'none'; 
    modalBackdrop.setAttribute('aria-hidden','true'); 
  }

  // ========== UTILITY FUNCTIONS ==========

  function parseExcelDate(v){
    if (v instanceof Date) return new Date(v.getFullYear(), v.getMonth(), v.getDate());
    if (typeof v === 'number') {
      // Excel date (number of days since 1900-01-01)
      const excelEpoch = new Date(1899, 11, 30);
      return new Date(excelEpoch.getTime() + v * 86400000);
    }
    if (typeof v === 'string') {
      const parsed = new Date(v);
      return isNaN(parsed.getTime()) ? null : new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate());
    }
    return null;
  }

  function pairsFromCSV(csv){
    if (!csv) return [];
    const parts = csv.split(',').map(s => s.trim()).filter(Boolean);
    const pairs = [];
    for (let i = 0; i < parts.length; i += 2) {
      pairs.push({
        in: parts[i] || '',
        out: parts[i + 1] || ''
      });
    }
    return pairs;
  }

  function sumPairs(pairs, roundingMin){
    let total = 0;
    for (const p of pairs) {
      if (!p.in || !p.out) continue;
      const inSec = timeToSeconds(p.in);
      const outSec = timeToSeconds(p.out);
      if (inSec === null || outSec === null) continue;
      
      let duration = outSec - inSec;
      if (duration < 0) duration += 24 * 3600; // Cross midnight
      
      if (roundingMin > 0) {
        const roundingSec = roundingMin * 60;
        duration = Math.round(duration / roundingSec) * roundingSec;
      }
      
      total += Math.max(0, duration);
    }
    return total;
  }

  function timeToSeconds(timeStr){
    if (!timeStr) return null;
    const match = timeStr.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if (!match) return null;
    const hours = parseInt(match[1], 10);
    const minutes = parseInt(match[2], 10);
    const seconds = match[3] ? parseInt(match[3], 10) : 0;
    return hours * 3600 + minutes * 60 + seconds;
  }

  function secondsToHhMm(seconds){
    const absSeconds = Math.abs(seconds);
    const h = Math.floor(absSeconds / 3600);
    const m = Math.floor((absSeconds % 3600) / 60);
    return `${seconds < 0 ? '-' : ''}${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
  }

  function ymd(d){ 
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  }

  function ym(d){ 
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
  }

  function parseYmd(ymdStr){
    const parts = ymdStr.split('-');
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  }

  function getWeekStart(date, startDay){
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day - startDay + 7) % 7;
    d.setDate(d.getDate() - diff);
    return d;
  }

  function getPeriodRange(periodKey, weekStart){
    if (periodKey.startsWith('W:')) {
      const startDate = parseYmd(periodKey.substring(2));
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 6);
      return { start: startDate, end: endDate };
    } else if (periodKey.startsWith('M:')) {
      const [year, month] = periodKey.substring(2).split('-').map(Number);
      const startDate = new Date(year, month - 1, 1);
      const endDate = new Date(year, month, 0);
      return { start: startDate, end: endDate };
    } else {
      const date = parseYmd(periodKey);
      return { start: date, end: date };
    }
  }

  function formatPeriodDisplay(periodKey, weekStart){
    if (periodKey.startsWith('W:')) {
      const startDate = parseYmd(periodKey.substring(2));
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 6);
      return `Ø£Ø³Ø¨ÙˆØ¹ ${ymd(startDate)} â†’ ${ymd(endDate)}`;
    } else if (periodKey.startsWith('M:')) {
      const [year, month] = periodKey.substring(2).split('-').map(Number);
      const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
      return `${monthNames[month - 1]} ${year}`;
    } else {
      return periodKey;
    }
  }

  function countWeekdays(start, end, targetDays){
    let count = 0;
    const current = new Date(start);
    while (current <= end) {
      if (targetDays.includes(current.getDay())) {
        count++;
      }
      current.setDate(current.getDate() + 1);
    }
    return count;
  }

  function calculateExpectedForDay(dayOfWeek, expectedWD, expectedSat, satPolicy, expectedMode, hasPunch){
    // 0=Sunday, 1=Monday, ..., 5=Friday, 6=Saturday
    if (dayOfWeek >= 0 && dayOfWeek <= 4) {
      // Sunday to Thursday
      if (expectedMode === 'punched' && !hasPunch) return 0;
      return expectedWD;
    } else if (dayOfWeek === 5) {
      // Friday - always off
      return 0;
    } else if (dayOfWeek === 6) {
      // Saturday
      if (satPolicy === 'off') return 0;
      if (satPolicy === 'punch' && !hasPunch) return 0;
      return expectedSat;
    }
    return 0;
  }

  function pairToHtml(pair){
    const inPill = `<span class="pill" style="background:rgba(244,231,51,.16); color:#000; border:1px solid #f4e733;">Ø¯Ø®ÙˆÙ„ ${escapeHtml(pair.in)}</span>`;
    const outPill = pair.out ? 
      `<span class="pill" style="background:rgba(255,255,255,.08)">Ø®Ø±ÙˆØ¬ ${escapeHtml(pair.out)}</span>` : 
      `<span class="pill warn">Ø®Ø±ÙˆØ¬ ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>`;
    
    const duration = pair.out ? secondsToHhMm(timeToSeconds(pair.out) - timeToSeconds(pair.in)) : '00:00';
    
    return `<span class="mono">${inPill} â†’ ${outPill}</span> <span class="muted">(Ø§Ù„Ù…Ø¯Ø©: ${duration})</span>`;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function csvEscape(field) {
    if (field === null || field === undefined) return '';
    const string = String(field);
    if (string.includes(',') || string.includes('"') || string.includes('\n')) {
      return '"' + string.replace(/"/g, '""') + '"';
    }
    return string;
  }
})();
</script>
</body>
</html>
