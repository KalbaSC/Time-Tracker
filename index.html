<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Timecard Summary — Kalba Sports & Cultural Club</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#222222;
      --accent:#f4e733;
      --text:#ffffff;
      --muted:#cfcfcf;
      --panel:#000000;
      --border:#f4e733;
      --soft:#444;
      --ok:#2bd886;
      --warn:#ffc266;
      --bad:#ff6b6b;
      --radius:16px;
    }

    @font-face {
      font-family: 'NotoKufiArabic';
      src: url('NotoKufiArabic.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    @font-face {
      font-family: 'NotoKufiArabic';
      src: url('NotoKufiArabic-Light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
    }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "NotoKufiArabic", Arial, sans-serif;
      color: var(--text);
      background-color: var(--bg);
      background-image:
        repeating-linear-gradient(45deg, rgba(244,231,51,.08) 0px, rgba(244,231,51,.08) 2px, transparent 2px, transparent 14px),
        repeating-linear-gradient(-45deg, rgba(244,231,51,.06) 0px, rgba(244,231,51,.06) 1px, transparent 1px, transparent 16px),
        radial-gradient(circle at 20% 30%, rgba(244,231,51,.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(244,231,51,.04) 0%, transparent 40%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      background:#222222;
      padding:16px 5%;
      width:90%;
      margin:0 auto;
      border-bottom:3px solid var(--accent);
      position:sticky; top:0; z-index:1001;
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .header-right{display:flex; align-items:center; gap:15px; flex:1; min-width:0}
    .header-right img.logo{height:70px; object-fit:contain}
    .header-right .divider{width:1.5px; height:65px; background:var(--accent)}
    .header-info{text-align:left; min-width:0}
    .header-info .title{margin:0; font-weight:800; font-size:18px; color:#fff}
    .header-info .subtitle{margin:0; font-size:14px; color:var(--accent)}

    main{flex:1; width:90%; margin:20px auto; display:grid; gap:16px}
    @media (min-width:980px){ main{grid-template-columns:1.05fr 2fr} }

    .panel{
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }

    .controls{display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end}
    .control{display:flex; flex-direction:column; gap:6px; min-width:180px}
    label{font-size:12px; color:var(--muted)}
    input[type="number"], select, input[type="file"]{
      padding:10px 12px; background:#0f0f0f; color:var(--text);
      border:1px solid #333; border-radius:12px; outline:none;
    }
    input[type="file"]{padding:8px; background:transparent; border:none}

    .btn{
      appearance:none; border:none; border-radius:12px; padding:10px 14px;
      background:var(--accent); color:#000; font-weight:800; cursor:pointer;
      transition:transform .06s ease, box-shadow .2s ease;
      box-shadow: 0 4px 0 #a88600;
    }
    .btn:active{ transform: translateY(1px); box-shadow:0 3px 0 #a88600; }
    .btn.secondary{background:#1b1b1b; color:var(--text); border:1px solid #333; box-shadow:none}

    .note{color:var(--muted); font-size:12px}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .table-wrap{
      position:relative; overflow:auto; max-height:70vh; border-radius:12px; outline:1px solid #2a2a2a
    }
    .table-wrap::before{
      content:""; position:absolute; inset:-1px; border-radius:12px; pointer-events:none;
      background:
        linear-gradient(90deg, transparent, rgba(244,231,51,.2), transparent) top/100% 2px no-repeat,
        linear-gradient(90deg, transparent, rgba(244,231,51,.2), transparent) bottom/100% 2px no-repeat;
    }
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:6px}
    thead th{
      position:sticky; top:0; background:#111; z-index:1;
      text-align:left; padding:10px; font-size:12px; color:#fff17a;
      border-bottom:1px solid var(--accent);
    }
    tbody td{padding:10px; border-bottom:1px solid #2a2a2a; vertical-align:top}
    tbody tr:hover{background:#0f0f0f}
    .right{text-align:right}
    .center{text-align:center}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px}
    .pill.ok{background:rgba(43,216,134,.12); color:var(--ok)}
    .pill.warn{background:rgba(255,194,102,.12); color:var(--warn)}
    .pill.bad{background:rgba(255,107,107,.12); color:var(--bad)}

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      width:min(980px, 94vw); max-height:86vh; overflow:auto; background:#0f0f0f;
      border:2px solid var(--border); border-radius:16px; box-shadow:0 10px 35px rgba(0,0,0,.45);
    }
    .modal header{position:sticky; top:0; background:#111; padding:12px 16px; border-bottom:1px solid var(--accent); display:flex; justify-content:space-between; align-items:center}
    .modal h3{margin:0; font-size:18px}
    .modal .content{padding:12px 16px}
    .close{background:#1b1b1b; color:#eee; border:1px solid #333; border-radius:10px; padding:6px 10px; cursor:pointer}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}

    @media (max-width:768px){
      .header-right img.logo{height:40px}
      .header-right .divider{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-right">
      <img src="Picture3.png" alt="Sharjah emblem" class="logo">
      <div class="divider"></div>
      <img src="logo.png" alt="Kalba SC logo" class="logo">
      <div class="header-info">
        <p class="title">Kalba Sports & Cultural Club</p>
        <p class="subtitle">Timecard Summary — Daily / Weekly / Monthly</p>
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="control">
        <label>Upload timecard (Excel)</label>
        <input id="file" type="file" accept=".xlsx,.xls" />
      </div>

      <div class="controls" style="margin-top:10px">
        <div class="control">
          <label>View</label>
          <select id="view">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <div class="control">
          <label>Expected hours per day</label>
          <input id="expected" type="number" min="0" step="0.25" value="7" />
        </div>

        <div class="control">
          <label>Week starts on</label>
          <select id="weekStart">
            <option value="1" selected>Monday</option>
            <option value="0">Sunday</option>
            <option value="6">Saturday</option>
          </select>
        </div>

        <div class="control">
          <label>&nbsp;</label>
          <button id="download" class="btn secondary">Download CSV</button>
        </div>
      </div>

      <p class="note" style="margin-top:8px">
        Columns expected: <b>Employee ID</b>, <b>First Name</b>, <b>Date</b>, <b>Time</b>.
        The <b>Time</b> cell contains comma-separated times for the day like
        <span class="mono">08:30:01, 13:10:16, 16:31:21, 19:51:08</span>.
        We pair them as <em>IN/OUT</em>. If there’s a trailing IN without OUT, it’s ignored.
      </p>
    </section>

    <section class="panel" style="min-height:460px">
      <div class="flex" style="justify-content:space-between; margin-bottom:6px">
        <div class="note"><span id="meta">No file loaded.</span></div>
        <div class="flex">
          <button id="recalc" class="btn">Recalculate</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="table">
          <thead>
            <tr>
              <th>Employee ID</th>
              <th>Name</th>
              <th>Period</th>
              <th class="right">Worked</th>
              <th class="right">Expected</th>
              <th class="right">Overtime</th>
              <th class="right">Shortfall</th>
              <th class="center">Punches</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="8" class="note">Upload a file to see results.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3 id="modalTitle">Punch Details</h3>
        <button class="close" id="closeModal">Close</button>
      </header>
      <div class="content">
        <div class="muted" id="modalMeta"></div>
        <div class="table-wrap" style="margin-top:10px; max-height:60vh">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>IN → OUT pairs</th>
                <th class="right">Day total</th>
              </tr>
            </thead>
            <tbody id="detailsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const fileInput = $('file');
  const viewSel = $('view');
  const weekStartSel = $('weekStart');
  const expectedInp = $('expected');
  const metaEl = $('meta');
  const tbody = $('tbody');
  const recalcBtn = $('recalc');
  const dlBtn = $('download');

  const modalBackdrop = $('modalBackdrop');
  const closeModalBtn = $('closeModal');
  const modalTitle = $('modalTitle');
  const modalMeta = $('modalMeta');
  const detailsBody = $('detailsBody');

  let rawRows = []; 
  let byKeyDetails = new Map(); 
  let lastCSV = '';

  fileInput.addEventListener('change', handleFile, false);
  recalcBtn.addEventListener('click', render);
  viewSel.addEventListener('change', render);
  expectedInp.addEventListener('change', render);
  weekStartSel.addEventListener('change', render);
  dlBtn.addEventListener('click', handleDownload);
  closeModalBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

  function handleDownload(){
    if (!lastCSV) { alert('No data to download yet.'); return; }
    const blob = new Blob([lastCSV], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'timecard_summary.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function handleFile() {
    const f = fileInput.files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try{
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const firstSheet = wb.SheetNames[0];
        const ws = wb.Sheets[firstSheet];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});

        let headerIdx = rows.findIndex(r => String(r[0]).trim().toLowerCase() === 'employee id');
        if (headerIdx === -1) headerIdx = rows.findIndex(r => r.some(c => String(c).trim().toLowerCase() === 'employee id'));
        if (headerIdx === -1) { alert('Could not find a header row containing "Employee ID".'); return; }

        const header = rows[headerIdx];
        const colIdx = {
          empId: header.findIndex(h => String(h).trim().toLowerCase().includes('employee id')),
          name:  header.findIndex(h => String(h).trim().toLowerCase().includes('first name')),
          date:  header.findIndex(h => String(h).trim().toLowerCase() === 'date'),
          timeList: header.findIndex(h => String(h).trim().toLowerCase() === 'time'),
        };
        if (colIdx.empId === -1) colIdx.empId = 0;
        if (colIdx.name  === -1) colIdx.name  = 1;
        if (colIdx.date  === -1) colIdx.date  = 2;
        if (colIdx.timeList === -1) colIdx.timeList = 4;

        const out = [];
        for (let i = headerIdx + 1; i < rows.length; i++) {
          const r = rows[i];
          if (!r || r.length === 0) continue;
          const empId = String(r[colIdx.empId] ?? '').trim();
          const name = String(r[colIdx.name] ?? '').trim();
          const dateCell = r[colIdx.date];
          const timesStr = String(r[colIdx.timeList] ?? '').trim();
          if (!empId || !name || !dateCell || !timesStr) continue;

          const d = parseExcelDate(dateCell);
          if (!d) continue;

          const pairs = pairsFromCSV(timesStr);
          const workedSec = pairs.reduce((acc,p)=> acc + diffSec(p.in, p.out), 0);
          out.push({empId, name, date: d, workedSec, pairs});
        }

        rawRows = out;
        metaEl.textContent = `${f.name} — ${out.length} rows parsed`;
        render();
      }catch(err){
        console.error(err);
        alert('Error while reading the file.');
      }
    };
    reader.readAsArrayBuffer(f);
  }

  function parseExcelDate(v){
    if (v instanceof Date && !isNaN(v)) return normalizeDate(v);
    if (typeof v === 'number') {
      const epoch = new Date(Date.UTC(1899,11,30));
      const d = new Date(epoch.getTime() + v*86400000);
      return normalizeDate(d);
    }
    const s = String(v).trim();
    const t = Date.parse(s);
    if (!isNaN(t)) return normalizeDate(new Date(t));
    return null;
  }
  function normalizeDate(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

  function pairsFromCSV(csv){
    const parts = csv.split(',').map(x => x.trim()).filter(Boolean);
    const out = [];
    for (let i = 0; i < parts.length; i += 2) {
      const a = parts[i];
      const b = parts[i+1] ?? null;
      if (!/^\d{1,2}:\d{2}(:\d{2})?$/.test(a)) continue;
      if (b && !/^\d{1,2}:\d{2}(:\d{2})?$/.test(b)) { out.push({in:a, out:null}); continue; }
      out.push({in:a, out:b});
    }
    return out;
  }

  function hmsToSec(hms){
    if (!hms) return 0;
    const m = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/.exec(hms);
    if (!m) return 0;
    const h = parseInt(m[1],10)||0;
    const mm = parseInt(m[2],10)||0;
    const s = parseInt(m[3]||'0',10)||0;
    return h*3600 + mm*60 + s;
  }
  function diffSec(a, b){
    if (!a || !b) return 0;
    let d = hmsToSec(b) - hmsToSec(a);
    if (d < 0) d += 24*3600; 
    return d;
  }
  function secToHHMM(sec){
    const sign = sec < 0 ? '-' : '';
    const v = Math.abs(sec);
    const h = Math.floor(v/3600);
    const m = Math.floor((v%3600)/60);
    return `${sign}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }

  function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function ym(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function getWeekStart(d, startDow){
    const date = normalizeDate(d);
    const dow = date.getDay(); 
    const diff = (dow - startDow + 7) % 7;
    date.setDate(date.getDate() - diff);
    return date;
  }
  function prettyPeriod(p, ws){
    if (p.startsWith('W:')){
      const d = new Date(p.slice(2));
      const end = new Date(d); end.setDate(end.getDate()+6);
      const weekNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      return `Week ${ymd(d)} → ${ymd(end)} (starts ${weekNames[ws]})`;
    }
    if (p.startsWith('M:')) return p.slice(2);
    return p;
  }

  function render(){
    if (!rawRows.length){
      tbody.innerHTML = `<tr><td colspan="8" class="note">Upload a file to see results.</td></tr>`;
      lastCSV = '';
      return;
    }
    const expectedPerDayHrs = parseFloat(expectedInp.value || '0');
    const expectedPerDaySec = Math.max(0, expectedPerDayHrs) * 3600;
    const view = viewSel.value; // daily | weekly | monthly
    const weekStart = parseInt(weekStartSel.value, 10);

    const map = new Map(); // key -> {empId,name,period, workedSec, days:Set, dayDetails: Map(ymd -> {pairs, workedSec})}
    for (const r of rawRows) {
      let keyPeriod = '';
      if (view === 'daily') {
        keyPeriod = ymd(r.date);
      } else if (view === 'weekly') {
        const ws = getWeekStart(r.date, weekStart);
        keyPeriod = `W:${ymd(ws)}`;
      } else {
        keyPeriod = `M:${ym(r.date)}`;
      }
      const key = `${r.empId}||${r.name}||${keyPeriod}`;
      if (!map.has(key)) {
        map.set(key, {empId:r.empId, name:r.name, period:keyPeriod, workedSec:0, days:new Set(), dayDetails:new Map()});
      }
      const obj = map.get(key);
      obj.workedSec += r.workedSec;
      const dayKey = ymd(r.date);
      obj.days.add(dayKey);
      obj.dayDetails.set(dayKey, {pairs: r.pairs.slice(), workedSec: r.workedSec});
    }
    byKeyDetails = map;

    const rows = [];
    for (const obj of map.values()) {
      const daysCount = (view === 'daily') ? 1 : obj.days.size;
      const expected = expectedPerDaySec * daysCount;
      const delta = obj.workedSec - expected;
      const overtime = Math.max(0, delta);
      const short = Math.max(0, -delta);
      rows.push({
        key: `${obj.empId}||${obj.name}||${obj.period}`,
        empId: obj.empId,
        name: obj.name,
        period: prettyPeriod(obj.period, weekStart),
        worked: obj.workedSec,
        expected,
        overtime,
        short
      });
    }

    rows.sort((a,b)=> (a.empId.localeCompare(b.empId) || a.period.localeCompare(b.period)));

    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHTML(r.empId)}</td>
        <td>${escapeHTML(r.name)}</td>
        <td>${escapeHTML(r.period)}</td>
        <td class="right">${secToHHMM(r.worked)}</td>
        <td class="right">${secToHHMM(r.expected)}</td>
        <td class="right">${r.overtime ? `<span class="pill ok">${secToHHMM(r.overtime)}</span>` : `<span class="pill">00:00</span>`}</td>
        <td class="right">${r.short ? `<span class="pill bad">-${secToHHMM(r.short)}</span>` : `<span class="pill ok">00:00</span>`}</td>
        <td class="center"><button class="btn secondary" data-key="${escapeHTML(r.key)}">Details</button></td>
      </tr>
    `).join('');

    [...tbody.querySelectorAll('button[data-key]')].forEach(btn=>{
      btn.addEventListener('click', ()=> openDetails(btn.getAttribute('data-key')));
    });

    const csv = [
      ['Employee ID','Name','Period','Worked (HH:MM)','Expected (HH:MM)','Overtime (HH:MM)','Shortfall (HH:MM)'],
      ...rows.map(r=>[
        r.empId, r.name, r.period,
        secToHHMM(r.worked), secToHHMM(r.expected),
        secToHHMM(r.overtime), (r.short ? `-${secToHHMM(r.short)}` : '00:00')
      ])
    ].map(row => row.map(csvEscape).join(',')).join('\n');
    lastCSV = csv;

    metaEl.textContent = `Records: ${rawRows.length} — View: ${viewSel.value} — Expected/day: ${expectedPerDayHrs} h`;
  }

  function openDetails(key){
    const obj = byKeyDetails.get(key);
    if (!obj) return;

    const [empId, name, period] = key.split('||');
    modalTitle.textContent = `Punch Details — ${name} (${empId})`;
    modalMeta.innerHTML = `Period: <b>${escapeHTML(prettyPeriod(period, parseInt(weekStartSel.value,10)))}</b> — Covered days: ${obj.days.size}`;

    const days = [...obj.dayDetails.keys()].sort();
    detailsBody.innerHTML = days.map(d=>{
      const day = obj.dayDetails.get(d);
      const pairsHtml = day.pairs.length
        ? day.pairs.map(p=> pairHTML(p)).join(' &nbsp; ')
        : '<span class="muted">No pairs</span>';
      return `
        <tr>
          <td>${escapeHTML(d)}</td>
          <td>${pairsHtml}</td>
          <td class="right">${secToHHMM(day.workedSec)}</td>
        </tr>
      `;
    }).join('');

    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden','false');
  }

  function pairHTML(p){
    const pin  = `<span class="pill" style="background:rgba(244,231,51,.16); color:${'#000'}; border:1px solid ${'#f4e733'};">IN ${escapeHTML(p.in)}</span>`;
    const pout = p.out ? `<span class="pill" style="background:rgba(255,255,255,.08)">OUT ${escapeHTML(p.out)}</span>` : `<span class="pill warn">OUT missing</span>`;
    const dur = p.out ? secToHHMM(diffSec(p.in, p.out)) : '00:00';
    return `<span class="mono">${pin} → ${pout}</span> <span class="muted">(duration: ${dur})</span>`;
  }

  function closeModal(){
    modalBackdrop.style.display = 'none';
    modalBackdrop.setAttribute('aria-hidden','true');
  }

  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }
  function csvEscape(s){
    s = String(s);
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
})();
</script>
</body>
</html>
