<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ù„Ø®Ù‘Øµ Ø§Ù„Ø¨ØµÙ…Ø© â€” Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#222222; --accent:#f4e733; --text:#ffffff; --muted:#cfcfcf;
      --panel:#000000; --border:#f4e733; --soft:#444;
      --ok:#2bd886; --warn:#ffc266; --bad:#ff6b6b;
      --radius:16px;
    }
    html, body { height: 100%; }
    body{
      margin:0; font-family: "Tajawal","NotoKufiArabic",system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
      color:var(--text); background:var(--bg);
      background-image:
        repeating-linear-gradient(45deg, rgba(244,231,51,.08) 0px, rgba(244,231,51,.08) 2px, transparent 2px, transparent 14px),
        repeating-linear-gradient(-45deg, rgba(244,231,51,.06) 0px, rgba(244,231,51,.06) 1px, transparent 1px, transparent 16px),
        radial-gradient(circle at 20% 30%, rgba(244,231,51,.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(244,231,51,.04) 0%, transparent 40%);
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      background:#222; padding:16px 5%; width:90%; margin:0 auto;
      border-bottom:3px solid var(--accent); position:sticky; top:0; z-index:1001;
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .header-right{display:flex; align-items:center; gap:15px; flex:1; min-width:0}
    .header-right img.logo{height:64px; object-fit:contain}
    .header-right .divider{width:1.5px; height:60px; background:var(--accent)}
    .header-info{text-align:right} .title{margin:0; font-weight:800; font-size:18px}
    .subtitle{margin:0; font-size:14px; color:var(--accent)}
    main{flex:1; width:90%; margin:20px auto; display:grid; gap:16px}
    @media (min-width:1100px){ main{grid-template-columns:1.15fr 2fr} }
    .panel{
      background:var(--panel); border:2px solid var(--border); border-radius:var(--radius);
      padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.25);
    }
    .controls{display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end}
    .control{display:flex; flex-direction:column; gap:6px; min-width:180px}
    label{font-size:12px; color:var(--muted)}
    input, select{padding:10px 12px; background:#0f0f0f; color:var(--text); border:1px solid #333; border-radius:12px; outline:none}
    input[type="file"]{padding:8px; background:transparent; border:none}
    .btn{appearance:none; border:none; border-radius:12px; padding:10px 14px;
      background:var(--accent); color:#000; font-weight:800; cursor:pointer;
      transition:transform .06s ease, box-shadow .2s ease; box-shadow:0 4px 0 #a88600}
    .btn:active{transform:translateY(1px); box-shadow:0 3px 0 #a88600}
    .btn.secondary{background:#1b1b1b; color:var(--text); border:1px solid #333; box-shadow:none}
    .note{color:var(--muted); font-size:12px}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grid-4{display:grid; gap:10px}
    @media (min-width:900px){ .grid-4{grid-template-columns:repeat(4,1fr)} }
    .kpi{background:#0f0f0f; border:1px solid #333; border-radius:12px; padding:12px}
    .kpi .label{font-size:12px; color:#fffde0} .kpi .value{font-size:20px; font-weight:800}
    .kpi.ok{border-color:rgba(43,216,134,.4)} .kpi.warn{border-color:rgba(255,194,102,.5)}
    .kpi.bad{border-color:rgba(255,107,107,.5)}
    .table-wrap{position:relative; overflow:auto; max-height:70vh; border-radius:12px; outline:1px solid #2a2a2a}
    .table-wrap::before{content:""; position:absolute; inset:-1px; border-radius:12px; pointer-events:none;
      background:linear-gradient(90deg,transparent,rgba(244,231,51,.2),transparent) top/100% 2px no-repeat,
                 linear-gradient(90deg,transparent,rgba(244,231,51,.2),transparent) bottom/100% 2px no-repeat}
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:6px}
    thead th{position:sticky; top:0; background:#111; z-index:1; text-align:right; padding:10px; font-size:12px; color:#fff17a; border-bottom:1px solid var(--accent)}
    tbody td{padding:10px; border-bottom:1px solid #2a2a2a; vertical-align:top}
    tbody tr:hover{background:#0f0f0f}
    .left{text-align:left} .center{text-align:center}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px}
    .pill.ok{background:rgba(43,216,134,.12); color:var(--ok)}
    .pill.warn{background:rgba(255,194,102,.12); color:var(--warn)}
    .pill.bad{background:rgba(255,107,107,.12); color:var(--bad)}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999}
    .modal{width:min(980px,94vw); max-height:86vh; overflow:auto; background:#0f0f0f; border:2px solid var(--border); border-radius:16px; box-shadow:0 10px 35px rgba(0,0,0,.45)}
    .modal header{position:sticky; top:0; background:#111; padding:12px 16px; border-bottom:1px solid var(--accent); display:flex; justify-content:space-between; align-items:center}
    .modal h3{margin:0; font-size:18px} .modal .content{padding:12px 16px}
    .close{background:#1b1b1b; color:#eee; border:1px solid #333; border-radius:10px; padding:6px 10px; cursor:pointer}
    .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace}
    .hint{font-size:12px; color:#fffde0}
    @media (max-width:768px){ .header-right img.logo{height:40px} .header-right .divider{display:none} }
  </style>
</head>
<body>
  <header>
    <div class="header-right">
      <img src="Picture3.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø§Ø±Ù‚Ø©" class="logo">
      <div class="divider"></div>
      <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡" class="logo">
      <div class="header-info">
        <p class="title">Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</p>
        <p class="subtitle">Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ØµÙ…Ø© â€” ÙŠÙˆÙ…ÙŠ / Ø£Ø³Ø¨ÙˆØ¹ÙŠ / Ø´Ù‡Ø±ÙŠ</p>
      </div>
    </div>
  </header>

  <main>
<section class="panel" id="punchPanel">
  <div class="controls-header" style="margin-bottom:12px">
    <h2 class="controls-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¨ØµÙ…Ø©</h2>
  </div>

  <!-- Login / Register -->
  <div id="authBox" class="controls" style="margin-bottom:12px">
    <div class="control">
      <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
      <input id="empIdLogin" type="text" placeholder="Ù…Ø«Ø§Ù„: 12034" />
    </div>
    <div class="control">
      <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)</label>
      <input id="empPinLogin" type="password" inputmode="numeric" placeholder="4â€“6 Ø£Ø±Ù‚Ø§Ù…" />
    </div>
    <div class="control">
      <label>Ø§Ù„Ø§Ø³Ù… (Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·)</label>
      <input id="empNameRegister" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
    </div>
    <div class="flex">
      <button id="btnLogin" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button id="btnRegister" class="btn secondary">ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <p class="note" id="authNote" style="margin-top:6px"></p>
  </div>

  <!-- After login -->
  <div id="punchBox" style="display:none">
    <div class="flex" style="justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div class="note">
        <span class="status-indicator status-ok"></span>
        Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b id="activeEmpName"></b> (<span class="mono" id="activeEmpId"></span>)
      </div>
      <div class="flex">
        <button id="btnLogout" class="btn secondary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="section-divider"></div>

    <div class="flex" style="gap:10px;flex-wrap:wrap">
      <button id="btnPunchIn" class="btn">â¬†ï¸ Ø¨ØµÙ…Ø© Ø¯Ø®ÙˆÙ„</button>
      <button id="btnPunchOut" class="btn secondary">â¬‡ï¸ Ø¨ØµÙ…Ø© Ø®Ø±ÙˆØ¬</button>
      <button id="btnExportMyCSV" class="btn secondary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø³Ø¬Ù„Ø§ØªÙŠ (CSV)</button>
      <span class="note" id="punchStatus"></span>
    </div>

    <div class="kpi-container">
      <h3 class="controls-title">Ù…Ù„Ø®ØµÙŠ</h3>
      <div class="grid-4">
        <div class="kpi">
          <div class="label">Ø§Ù„ÙŠÙˆÙ… â€” Ø¹Ù…Ù„Øª</div>
          <div class="value" id="me_today_worked">00:00</div>
        </div>
        <div class="kpi">
          <div class="label">Ø§Ù„ÙŠÙˆÙ… â€” Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹</div>
          <div class="value" id="me_today_expected">00:00</div>
        </div>
        <div class="kpi ok">
          <div class="label">Ø§Ù„ÙŠÙˆÙ… â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          <div class="value" id="me_today_left">00:00</div>
        </div>
        <div class="kpi">
          <div class="label">Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</div>
          <div class="value" id="me_last_action">â€”</div>
        </div>
      </div>

      <div class="grid-4" style="margin-top:12px">
        <div class="kpi">
          <div class="label">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ â€” Ø¹Ù…Ù„Øª</div>
          <div class="value" id="me_week_worked">00:00</div>
        </div>
        <div class="kpi">
          <div class="label">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ â€” Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹</div>
          <div class="value" id="me_week_expected">00:00</div>
        </div>
        <div class="kpi ok">
          <div class="label">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          <div class="value" id="me_week_left">00:00</div>
        </div>
        <div class="kpi">
          <div class="label">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± â€” Ø¹Ù…Ù„Øª</div>
          <div class="value" id="me_month_worked">00:00</div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h2 class="table-title">Ø¨ØµÙ…Ø§ØªÙŠ Ø§Ù„ÙŠÙˆÙ…</h2>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th class="left">Ø§Ù„Ù†ÙˆØ¹</th>
            </tr>
          </thead>
          <tbody id="me_today_table">
            <tr><td colspan="2" class="note" style="text-align:center;padding:20px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

    <section class="panel">
      <div class="controls">
        <div class="control">
          <label>ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ØµÙ…Ø© (Excel)</label>
          <input id="file" type="file" accept=".xlsx,.xls" />
        </div>

        <div class="control">
          <label>Ø§Ù„Ø¹Ø±Ø¶</label>
          <select id="view">
            <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
            <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
            <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
          </select>
        </div>

        <div class="control">
          <label>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©/Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø£Ø­Ø¯â€“Ø§Ù„Ø®Ù…ÙŠØ³)</label>
          <input id="expectedWD" type="number" min="0" step="0.25" value="7" />
        </div>

        <div class="control">
          <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø³Ø¨Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="expectedSat" type="number" min="0" step="0.25" value="3" />
        </div>

        <div class="control">
          <label>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø³Ø¨Øª</label>
          <select id="satPolicy">
            <option value="punch">Ø§Ø­ØªØ³Ø§Ø¨ ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¨ØµÙ…Ø©</option>
            <option value="calendar">Ø§Ø­ØªØ³Ø§Ø¨ ØªÙ‚ÙˆÙŠÙ…ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§</option>
            <option value="off">Ø¹Ø¯Ù… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø¨Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§</option>
          </select>
        </div>

        <div class="control">
          <label>Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰</label>
          <select id="expectedMode">
            <option value="calendar">Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ÙŠØ©</option>
            <option value="punched">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ Ø¨Ù‡Ø§ Ø¨ØµÙ…Ø©</option>
          </select>
        </div>

        <div class="control">
          <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
          <select id="weekStart">
            <option value="0">Ø§Ù„Ø£Ø­Ø¯</option>
            <option value="1" selected>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
            <option value="6">Ø§Ù„Ø³Ø¨Øª</option>
          </select>
        </div>

        <div class="control">
          <label>ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¯Ø¯</label>
          <select id="rounding">
            <option value="0" selected>Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨</option>
            <option value="1">1 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="5">5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="10">10 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="15">15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
          </select>
        </div>

        <div class="control">
          <label>ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <input id="empFilter" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" />
        </div>

        <div class="control">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input id="fromDate" type="date" />
        </div>
        <div class="control">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input id="toDate" type="date" />
        </div>

        <div class="control">
          <label>&nbsp;</label>
          <button id="recalc" class="btn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        </div>
        <div class="control">
          <label>&nbsp;</label>
          <button id="downloadSummary" class="btn secondary">ØªÙ†Ø²ÙŠÙ„ CSV (Ø§Ù„Ù…Ù„Ø®Øµ)</button>
        </div>
        <div class="control">
          <label>&nbsp;</label>
          <button id="downloadDetails" class="btn secondary">ØªÙ†Ø²ÙŠÙ„ CSV (ØªÙØµÙŠÙ„ÙŠ)</button>
        </div>
      </div>

      <p class="note" style="margin-top:8px">
        Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: <b>Employee ID</b>ØŒ <b>First Name</b>ØŒ <b>Date</b>ØŒ <b>Time</b> (Ø£ÙˆÙ‚Ø§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„: IN, OUT, IN, OUTâ€¦). ÙŠÙØªØ¬Ø§Ù‡Ù„ Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„ Ø¨Ù„Ø§ Ø®Ø±ÙˆØ¬.
      </p>

      <!-- KPIs -->
      <div class="grid-4" style="margin-top:10px" id="kpis">
        <div class="kpi"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„</div><div class="value" id="kpiWorked">00:00</div></div>
        <div class="kpi"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹</div><div class="value" id="kpiExpected">00:00</div></div>
        <div class="kpi ok"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</div><div class="value" id="kpiOver">00:00</div></div>
        <div class="kpi bad"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Øµ</div><div class="value" id="kpiShort">00:00</div></div>
      </div>
    </section>

    <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <section class="panel" style="min-height:480px">
      <div class="flex" style="justify-content:space-between; margin-bottom:6px">
        <div class="note"><span id="meta">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø­Ù…Ù‘Ù„.</span></div>
      </div>

      <div class="table-wrap">
        <table id="table">
          <thead>
            <tr>
              <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„ÙØªØ±Ø©</th>
              <th class="left">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th>
              <th class="left">Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹</th>
              <th class="left">Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</th>
              <th class="left">Ø§Ù„Ù†Ù‚Øµ</th>
              <th class="center">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="8" class="note">Ø­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</td></tr>
          </tbody>
        </table>
      </div>
      <p class="hint" id="hintPolicy" style="margin-top:8px"></p>
    </section>
  </main>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø©</h3>
        <button class="close" id="closeModal">Ø¥ØºÙ„Ø§Ù‚</button>
      </header>
      <div class="content">
        <div class="muted" id="modalMeta"></div>
        <div class="table-wrap" style="margin-top:10px; max-height:60vh">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ (Ø¯Ø®ÙˆÙ„ â†’ Ø®Ø±ÙˆØ¬)</th>
                <th class="left">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…</th>
              </tr>
            </thead>
            <tbody id="detailsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const fileInput = $('file'), viewSel = $('view'), weekStartSel = $('weekStart');
  const expectedWDInp = $('expectedWD'), expectedSatInp = $('expectedSat'), satPolicySel = $('satPolicy');
  const expectedModeSel = $('expectedMode'), roundingSel = $('rounding');
  const empFilterInp = $('empFilter'), fromDateInp = $('fromDate'), toDateInp = $('toDate');
  const metaEl = $('meta'), tbody = $('tbody'), hintPolicy = $('hintPolicy');
  const kpiWorked = $('kpiWorked'), kpiExpected = $('kpiExpected'), kpiOver = $('kpiOver'), kpiShort = $('kpiShort');
  const recalcBtn = $('recalc'), dlSumBtn = $('downloadSummary'), dlDetBtn = $('downloadDetails');

  const modalBackdrop = $('modalBackdrop'), closeModalBtn = $('closeModal'), modalTitle = $('modalTitle'), modalMeta = $('modalMeta'), detailsBody = $('detailsBody');

  let rawRows = []; // {empId, name, date: Date, pairs:[{in,out}], workedSec:number}
  let groupedDetails = new Map(); // key -> {empId,name,period, workedSec, expectedSec, over, short, days: Map(ymd -> {pairs, workedSec})}
  let lastSummaryCSV = '', lastDetailedCSV = '';

  fileInput.addEventListener('change', handleFile);
  [recalcBtn, viewSel, weekStartSel, expectedWDInp, expectedSatInp, satPolicySel, expectedModeSel, roundingSel, empFilterInp, fromDateInp, toDateInp]
    .forEach(el => el.addEventListener('change', render));
  closeModalBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', e => { if(e.target===modalBackdrop) closeModal(); });
  dlSumBtn.addEventListener('click', ()=> downloadCSV(lastSummaryCSV, 'timecard_summary.csv'));
  dlDetBtn.addEventListener('click', ()=> downloadCSV(lastDetailedCSV, 'timecard_details.csv'));

  function downloadCSV(text, filename){
    if (!text){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„ Ø¨Ø¹Ø¯.'); return; }
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  }

  function handleFile(){
    const f = fileInput.files?.[0]; if (!f) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try{
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});

        // locate header
        let headerIdx = rows.findIndex(r => String(r[0]).trim().toLowerCase() === 'employee id');
        if (headerIdx === -1) headerIdx = rows.findIndex(r => r.some(c => String(c).trim().toLowerCase() === 'employee id'));
        if (headerIdx === -1) { alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ "Employee ID".'); return; }

        const header = rows[headerIdx];
        const colIdx = {
          empId: header.findIndex(h => String(h).trim().toLowerCase().includes('employee id')),
          name:  header.findIndex(h => String(h).trim().toLowerCase().includes('first name')),
          date:  header.findIndex(h => String(h).trim().toLowerCase() === 'date'),
          timeList: header.findIndex(h => String(h).trim().toLowerCase() === 'time'),
        };
        if (colIdx.empId === -1) colIdx.empId = 0;
        if (colIdx.name  === -1) colIdx.name  = 1;
        if (colIdx.date  === -1) colIdx.date  = 2;
        if (colIdx.timeList === -1) colIdx.timeList = 4;

        const out = [];
        for (let i = headerIdx + 1; i < rows.length; i++){
          const r = rows[i]; if (!r || r.length===0) continue;
          const empId = String(r[colIdx.empId] ?? '').trim();
          const name = String(r[colIdx.name] ?? '').trim();
          const dateCell = r[colIdx.date];
          const timesStr = String(r[colIdx.timeList] ?? '').trim();
          if (!empId || !name || !dateCell) continue;

          const d = parseExcelDate(dateCell); if (!d) continue;

          const pairs = pairsFromCSV(timesStr);
          const workedSec = sumPairs(pairs, parseInt(roundingSel.value,10)||0);
          out.push({empId, name, date: d, pairs, workedSec});
        }
        rawRows = out;
        metaEl.textContent = `${f.name} â€” ØªÙ… ØªØ­Ù„ÙŠÙ„ ${out.length} ØµÙÙ‹Ø§`;
        render();
      }catch(err){ console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.'); }
    };
    reader.readAsArrayBuffer(f);
  }

  function render(){
    if (!rawRows.length){
      tbody.innerHTML = `<tr><td colspan="8" class="note">Ø­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</td></tr>`;
      lastSummaryCSV = lastDetailedCSV = '';
      updateKPIs(0,0,0,0);
      hintPolicy.textContent = '';
      return;
    }

    // filters
    const empFilter = (empFilterInp.value||'').trim().toLowerCase();
    const fromDate = fromDateInp.value ? new Date(fromDateInp.value) : null;
    const toDate = toDateInp.value ? new Date(toDateInp.value) : null;
    const view = viewSel.value;
    const weekStart = parseInt(weekStartSel.value,10);
    const expectedWD = (+expectedWDInp.value||0) * 3600;
    const expectedSat = (+expectedSatInp.value||0) * 3600;
    const satPolicy = satPolicySel.value; // 'punch'|'calendar'|'off'
    const expectedMode = expectedModeSel.value; // 'calendar'|'punched'

    // group
    const map = new Map(); // key -> obj
    for (const row of rawRows){
      if (empFilter && !(row.empId.toLowerCase().includes(empFilter) || row.name.toLowerCase().includes(empFilter))) continue;
      if (fromDate && row.date < fromDate) continue;
      if (toDate && row.date > toDate) continue;

      let periodKey = '';
      if (view === 'daily'){ periodKey = ymd(row.date); }
      else if (view === 'weekly'){ periodKey = 'W:'+ymd(getWeekStart(row.date, weekStart)); }
      else { periodKey = 'M:'+ym(row.date); }

      const key = `${row.empId}||${row.name}||${periodKey}`;
      if (!map.has(key)){
        map.set(key, {empId:row.empId, name:row.name, period:periodKey, workedSec:0, days:new Map()});
      }
      const obj = map.get(key);
      obj.workedSec += row.workedSec;
      obj.days.set(ymd(row.date), {pairs:row.pairs, workedSec:row.workedSec, dow:row.date.getDay()});
    }

    // compute expected per group
    const rows = [];
    let totalWorked=0, totalExpected=0, totalOver=0, totalShort=0;
    for (const obj of map.values()){
      let expectedSec = 0;

      if (view === 'daily'){
        // one date only
        const dkey = [...obj.days.keys()][0];
        const info = obj.days.get(dkey);
        expectedSec = expectedForDayKey(dkey, info.dow, expectedWD, expectedSat, satPolicy, expectedMode, !!info.pairs?.length);
      } else {
        // compute range
        const range = periodRange(obj.period, weekStart);
        if (expectedMode === 'calendar'){
          // calendar working days in full period
          expectedSec += expectedWD * countWeekdays(range.start, range.end, [0,1,2,3,4]); // Sun..Thu
          if (satPolicy === 'calendar') expectedSec += expectedSat * countWeekdays(range.start, range.end, [6]); // Saturday
          // Friday always off
        } else {
          // only days with punches
          for (const [dkey, info] of obj.days){
            expectedSec += expectedForDayKey(dkey, info.dow, expectedWD, expectedSat, satPolicy, 'punch', !!info.pairs?.length);
          }
        }
      }

      const delta = obj.workedSec - expectedSec;
      const over = Math.max(0, delta);
      const short = Math.max(0, -delta);

      totalWorked += obj.workedSec; totalExpected += expectedSec; totalOver += over; totalShort += short;

      rows.push({
        key: `${obj.empId}||${obj.name}||${obj.period}`,
        empId: obj.empId, name: obj.name,
        period: prettyPeriod(obj.period, weekStart),
        worked: obj.workedSec, expected: expectedSec, overtime: over, short
      });

      // store details for modal + CSV
      groupedDetails.set(`${obj.empId}||${obj.name}||${obj.period}`, {
        ...obj, expectedSec, over, short
      });
    }

    rows.sort((a,b)=> (a.empId.localeCompare(b.empId,'ar') || a.period.localeCompare(b.period,'ar')));
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${esc(r.empId)}</td>
        <td>${esc(r.name)}</td>
        <td>${esc(r.period)}</td>
        <td class="left">${secToHHMM(r.worked)}</td>
        <td class="left">${secToHHMM(r.expected)}</td>
        <td class="left">${r.overtime ? `<span class="pill ok">${secToHHMM(r.overtime)}</span>` : `<span class="pill">00:00</span>`}</td>
        <td class="left">${r.short ? `<span class="pill bad">-${secToHHMM(r.short)}</span>` : `<span class="pill ok">00:00</span>`}</td>
        <td class="center"><button class="btn secondary" data-key="${esc(r.key)}">ØªÙØ§ØµÙŠÙ„</button></td>
      </tr>
    `).join('');

    // details buttons
    [...tbody.querySelectorAll('button[data-key]')].forEach(btn => btn.addEventListener('click', ()=> openDetails(btn.getAttribute('data-key'))));

    // KPIs
    updateKPIs(totalWorked, totalExpected, totalOver, totalShort);

    // policy hint
    const modeText = expectedMode==='calendar' ? 'Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ÙŠØ©' : 'Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ Ø¨Ù‡Ø§ Ø¨ØµÙ…Ø©';
    const satText = satPolicy==='punch' ? 'Ø§Ù„Ø³Ø¨Øª ÙŠÙØ­ØªØ³Ø¨ ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¨ØµÙ…Ø©'
                 : satPolicy==='calendar' ? 'Ø§Ù„Ø³Ø¨Øª ÙŠÙØ­ØªØ³Ø¨ ØªÙ‚ÙˆÙŠÙ…ÙŠØ§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹'
                 : 'Ø§Ù„Ø³Ø¨Øª Ù„Ø§ ÙŠÙØ­ØªØ³Ø¨';
    hintPolicy.textContent = `Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: ${modeText} â€” ${satText}. Ø§Ù„Ø¬Ù…Ø¹Ø© Ù…Ø³ØªØ¨Ø¹Ø¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹.`;

    // CSVs
    lastSummaryCSV = buildSummaryCSV(rows);
    lastDetailedCSV = buildDetailedCSV();
  }

  /* === Helpers & business rules === */

  function expectedForDayKey(dkey, dow, expectedWD, expectedSat, satPolicy, expectedMode, hasPunch){
    // JS dow: 0=Ø§Ù„Ø£Ø­Ø¯,1=Ø§Ù„Ø§Ø«Ù†ÙŠÙ†,...,5=Ø§Ù„Ø¬Ù…Ø¹Ø©,6=Ø§Ù„Ø³Ø¨Øª
    if (dow >= 0 && dow <= 4) return expectedWD; // Sun..Thu
    if (dow === 5) return 0; // Friday off
    if (dow === 6){
      if (satPolicy === 'off') return 0;
      if (satPolicy === 'calendar') return expectedSat;
      // 'punch' â€” only if punched
      return hasPunch ? expectedSat : 0;
    }
    return 0;
  }

  function buildSummaryCSV(rows){
    const header = ['Employee ID','Name','Period','Worked (HH:MM)','Expected (HH:MM)','Overtime (HH:MM)','Shortfall (HH:MM)'];
    const data = rows.map(r => [r.empId, r.name, r.period, secToHHMM(r.worked), secToHHMM(r.expected), secToHHMM(r.overtime), (r.short?`-${secToHHMM(r.short)}`:'00:00')]);
    return [header, ...data].map(row => row.map(csvEsc).join(',')).join('\n');
    function csvEsc(s){ s=String(s); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
  }

  function buildDetailedCSV(){
    const header = ['Employee ID','Name','Period','Date','Pair #','IN','OUT','Duration (HH:MM)','Day Total (HH:MM)'];
    const lines = [header];
    for (const [key, obj] of groupedDetails){
      const [empId, name, period] = key.split('||');
      const days = [...obj.days.keys()].sort();
      for (const d of days){
        const info = obj.days.get(d);
        const pairs = info.pairs || [];
        const dayTotal = secToHHMM(info.workedSec);
        if (pairs.length === 0){
          lines.push([empId, name, prettyPeriod(obj.period, parseInt(weekStartSel.value,10)), d, '', '', '', '00:00', dayTotal]);
        } else {
          pairs.forEach((p, idx)=>{
            const dur = p.out ? secToHHMM(diffSec(p.in, p.out)) : '00:00';
            lines.push([empId, name, prettyPeriod(obj.period, parseInt(weekStartSel.value,10)), d, idx+1, p.in||'', p.out||'', dur, dayTotal]);
          });
        }
      }
    }
    return lines.map(row => row.map(csvEsc).join(',')).join('\n');
    function csvEsc(s){ s=String(s); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
  }

  function openDetails(key){
    const obj = groupedDetails.get(key); if (!obj) return;
    const [empId, name, period] = key.split('||');
    modalTitle.textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø© â€” ${name} (${empId})`;
    modalMeta.innerHTML = `Ø§Ù„ÙØªØ±Ø©: <b>${esc(prettyPeriod(period, parseInt(weekStartSel.value,10)))}</b> â€” Ø£ÙŠØ§Ù… Ù…ØºØ·Ù‘Ø§Ø©: ${obj.days.size}`;

    const days = [...obj.days.keys()].sort();
    detailsBody.innerHTML = days.map(d=>{
      const day = obj.days.get(d);
      const pairsHtml = day.pairs.length ? day.pairs.map(p=> pairHTML(p)).join(' &nbsp; ') : '<span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø²ÙˆØ§Ø¬</span>';
      return `<tr>
        <td>${esc(d)} ${dowBadge(day.dow)}</td>
        <td>${pairsHtml}</td>
        <td class="left">${secToHHMM(day.workedSec)}</td>
      </tr>`;
    }).join('');
    modalBackdrop.style.display = 'flex'; modalBackdrop.setAttribute('aria-hidden','false');
  }

  function dowBadge(dow){
    const names = ['Ø£Ø­Ø¯','Ø§Ø«Ù†ÙŠÙ†','Ø«Ù„Ø§Ø«Ø§Ø¡','Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø®Ù…ÙŠØ³','Ø¬Ù…Ø¹Ø©','Ø³Ø¨Øª'];
    const color = (dow===6)?'rgba(255,194,102,.18)':(dow===5?'rgba(255,107,107,.18)':'rgba(244,231,51,.14)');
    return ` <span class="pill" style="background:${color}; color:#fff">${names[dow]}</span>`;
  }

  function closeModal(){ modalBackdrop.style.display = 'none'; modalBackdrop.setAttribute('aria-hidden','true'); }

  function parseExcelDate(v){
    if (v instanceof Date && !isNaN(v)) return normalizeDate(v);
    if (typeof v === 'number'){
      const epoch = new Date(Date.UTC(1899,11,30));
      return normalizeDate(new Date(epoch.getTime() + v*86400000));
    }
    const t = Date.parse(String(v).trim()); return isNaN(t) ? null : normalizeDate(new Date(t));
  }
  function normalizeDate(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function pairsFromCSV(csv){
    const parts = (csv||'').split(',').map(x=>x.trim()).filter(Boolean);
    const out = []; for (let i=0;i<parts.length;i+=2){
      const a=parts[i], b=parts[i+1] ?? null;
      if (!/^\d{1,2}:\d{2}(:\d{2})?$/.test(a)) continue;
      if (b && !/^\d{1,2}:\d{2}(:\d{2})?$/.test(b)) { out.push({in:a, out:null}); continue; }
      out.push({in:a, out:b});
    } return out;
  }
  function sumPairs(pairs, roundingMin){
    let total=0;
    for (const p of pairs){
      if (!p.in || !p.out) continue;
      let sec = diffSec(p.in, p.out);
      if (roundingMin>0) sec = roundSeconds(sec, roundingMin*60);
      total += sec;
    }
    return total;
  }
  function roundSeconds(sec, step){ return Math.round(sec/step)*step; }
  function hmsToSec(hms){
    const m = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/.exec(hms||''); if (!m) return 0;
    return (+m[1])*3600 + (+m[2])*60 + (+(m[3]||0));
  }
  function diffSec(a,b){
    let d = hmsToSec(b) - hmsToSec(a);
    if (d<0) d += 24*3600; // Ø¹Ø¨ÙˆØ± Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„
    return d;
  }
  function secToHHMM(sec){
    const sign = sec<0?'-':''; const v=Math.abs(sec); const h=Math.floor(v/3600); const m=Math.floor((v%3600)/60);
    return `${sign}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }
  function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function ym(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function getWeekStart(d, startDow){
    const date = normalizeDate(d); const dow = date.getDay(); const diff = (dow - startDow + 7) % 7;
    date.setDate(date.getDate() - diff); return date;
  }
  function prettyPeriod(p, ws){
    if (p.startsWith('W:')){ const d=new Date(p.slice(2)); const end=new Date(d); end.setDate(end.getDate()+6);
      const names=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
      return `Ø£Ø³Ø¨ÙˆØ¹ ${ymd(d)} â†’ ${ymd(end)} (Ø¨Ø¯Ø§ÙŠØ© ${names[ws]})`; }
    if (p.startsWith('M:')) return p.slice(2);
    return p;
  }
  function periodRange(period, weekStart){
    if (period.startsWith('W:')){ const s=new Date(period.slice(2)); const e=new Date(s); e.setDate(e.getDate()+6); return {start:s,end:e}; }
    if (period.startsWith('M:')){ const [y,m]=period.slice(2).split('-').map(Number); const s=new Date(y,m-1,1); const e=new Date(y,m,0); return {start:s,end:e}; }
    const d=new Date(period); return {start:d,end:d};
  }
  function countWeekdays(start,end,allowedDows){
    const set = new Set(allowedDows); let cnt=0;
    const d = new Date(start.getFullYear(), start.getMonth(), start.getDate());
    const last = new Date(end.getFullYear(), end.getMonth(), end.getDate());
    for (; d<=last; d.setDate(d.getDate()+1)){ if (set.has(d.getDay())) cnt++; }
    return cnt;
  }
  function updateKPIs(worked, expected, over, short){
    kpiWorked.textContent = secToHHMM(worked);
    kpiExpected.textContent = secToHHMM(expected);
    kpiOver.textContent = secToHHMM(over);
    kpiShort.textContent = secToHHMM(short);
  }
  function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }
  function pairHTML(p){
    const pin  = `<span class="pill" style="background:rgba(244,231,51,.16); color:#000; border:1px solid #f4e733;">Ø¯Ø®ÙˆÙ„ ${esc(p.in)}</span>`;
    const pout = p.out ? `<span class="pill" style="background:rgba(255,255,255,.08)">Ø®Ø±ÙˆØ¬ ${esc(p.out)}</span>` : `<span class="pill warn">Ø®Ø±ÙˆØ¬ ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>`;
    const dur = p.out ? secToHHMM(diffSec(p.in,p.out)) : '00:00';
    return `<span class="mono">${pin} â†’ ${pout}</span> <span class="muted">(Ø§Ù„Ù…Ø¯Ø©: ${dur})</span>`;
  }

  const empIdLogin = $('empIdLogin');
  const empPinLogin = $('empPinLogin');
  const empNameRegister = $('empNameRegister');
  const btnLogin = $('btnLogin');
  const btnRegister = $('btnRegister');
  const authNote = $('authNote');

  const punchPanel = $('punchPanel');
  const authBox = $('authBox');
  const punchBox = $('punchBox');
  const btnLogout = $('btnLogout');
  const btnPunchIn = $('btnPunchIn');
  const btnPunchOut = $('btnPunchOut');
  const btnExportMyCSV = $('btnExportMyCSV');
  const punchStatus = $('punchStatus');

  const activeEmpName = $('activeEmpName');
  const activeEmpId = $('activeEmpId');

  const ME_today_worked = $('me_today_worked');
  const ME_today_expected = $('me_today_expected');
  const ME_today_left = $('me_today_left');
  const ME_last_action = $('me_last_action');

  const ME_week_worked = $('me_week_worked');
  const ME_week_expected = $('me_week_expected');
  const ME_week_left = $('me_week_left');
  const ME_month_worked = $('me_month_worked');

  const ME_today_table = $('me_today_table');

  const EMP_DB_KEY = 'kscEmployees';
  const ACTIVE_KEY = 'kscActiveEmp';

  function readDB(){
    try { return JSON.parse(localStorage.getItem(EMP_DB_KEY) || '{}'); }
    catch { return {}; }
  }
  function writeDB(db){ localStorage.setItem(EMP_DB_KEY, JSON.stringify(db)); }

  function getActive(){ 
    try { return JSON.parse(localStorage.getItem(ACTIVE_KEY) || 'null'); }
    catch { return null; }
  }
  function setActive(obj){ 
    if (obj) localStorage.setItem(ACTIVE_KEY, JSON.stringify(obj));
    else localStorage.removeItem(ACTIVE_KEY);
  }

  function nowHHMM(){
    const d = new Date();
    const h = String(d.getHours()).padStart(2,'0');
    const m = String(d.getMinutes()).padStart(2,'0');
    return `${h}:${m}`;
  }

  function ensureEmp(db, empId){
    if (!db[empId]) db[empId] = { name:'', pin:'', punches:{} };
    if (!db[empId].punches) db[empId].punches = {};
  }

  btnRegister.addEventListener('click', () => {
    const empId = (empIdLogin.value||'').trim();
    const pin = (empPinLogin.value||'').trim();
    const name = (empNameRegister.value||'').trim();

    if (!empId || !pin || !name){
      authNote.textContent = 'Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ÙˆØ§Ù„Ø§Ø³Ù… Ù„Ù„ØªØ³Ø¬ÙŠÙ„.';
      return;
    }
    const db = readDB();
    if (db[empId]){
      authNote.textContent = 'Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ø§Ø³ØªØ®Ø¯Ù…ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
      return;
    }
    db[empId] = { name, pin, punches:{} };
    writeDB(db);
    authNote.textContent = 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
  });

  btnLogin.addEventListener('click', () => {
    const empId = (empIdLogin.value||'').trim();
    const pin = (empPinLogin.value||'').trim();
    if (!empId || !pin){ authNote.textContent='Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ.'; return; }

    const db = readDB();
    if (!db[empId]){ authNote.textContent='Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…Ø³Ø¬Ù„.'; return; }
    if (db[empId].pin !== pin){ authNote.textContent='Ø±Ù…Ø² Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.'; return; }

    setActive({ empId });
    authNote.textContent = '';
    showPunchUI();
    refreshMyStats();
  });

  btnLogout.addEventListener('click', () => {
    setActive(null);
    authBox.style.display = '';
    punchBox.style.display = 'none';
  });

  function showPunchUI(){
    const active = getActive();
    if (!active){ authBox.style.display=''; punchBox.style.display='none'; return; }
    const db = readDB();
    const emp = db[active.empId];
    if (!emp){ setActive(null); authBox.style.display=''; punchBox.style.display='none'; return; }

    activeEmpName.textContent = emp.name;
    activeEmpId.textContent = active.empId;
    authBox.style.display = 'none';
    punchBox.style.display = '';
  }

  btnPunchIn.addEventListener('click', () => {
    const active = getActive(); if (!active) return;
    const db = readDB(); ensureEmp(db, active.empId);
    const emp = db[active.empId];

    const today = ymd(new Date());
    if (!emp.punches[today]) emp.punches[today] = [];

    const pairs = emp.punches[today];
    if (pairs.length && !pairs[pairs.length-1].out){
      punchStatus.textContent = 'Ø¹Ù†Ø¯Ùƒ Ø¯Ø®ÙˆÙ„ Ù„Ù… ÙŠÙØºÙ„Ù‚ Ø¨Ø¹Ø¯. Ø£ØºÙ„Ù‚ÙŠÙ‡ Ø¨Ø®Ø±ÙˆØ¬ Ø£ÙˆÙ„Ù‹Ø§.';
      return;
    }
    pairs.push({ in: nowHHMM(), out: '' });
    writeDB(db);
    punchStatus.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.';
    ME_last_action.textContent = `Ø¯Ø®ÙˆÙ„ ${pairs[pairs.length-1].in}`;
    refreshMyStats();
  });

  btnPunchOut.addEventListener('click', () => {
    const active = getActive(); if (!active) return;
    const db = readDB(); ensureEmp(db, active.empId);
    const emp = db[active.empId];

    const today = ymd(new Date());
    if (!emp.punches[today] || !emp.punches[today].length){
      punchStatus.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… Ù„Ø¥ØºÙ„Ø§Ù‚Ù‡.';
      return;
    }
    const pairs = emp.punches[today];
    const last = pairs[pairs.length-1];
    if (last.out){
      punchStatus.textContent = 'Ø¢Ø®Ø± Ø²ÙˆØ¬ Ù…ØºÙ„Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„.';
      return;
    }
    last.out = nowHHMM();
    writeDB(db);
    punchStatus.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬.';
    ME_last_action.textContent = `Ø®Ø±ÙˆØ¬ ${last.out}`;
    refreshMyStats();
  });

  btnExportMyCSV.addEventListener('click', () => {
    const active = getActive(); if (!active) return;
    const db = readDB(); const emp = db[active.empId];
    const rows = [['Date','Pairs (INâ†’OUT)','Worked (hh:mm)']];
    const allDays = Object.keys(emp.punches||{}).sort();
    for (const d of allDays){
      const pairs = emp.punches[d]||[];
      const pairsStr = pairs.map(p => `${p.in}â†’${p.out||''}`).join('; ');
      const worked = secondsToHhMm(sumPairs(pairs, parseInt(roundingSel.value,10)||0));
      rows.push([d, pairsStr, worked]);
    }
    const csv = rows.map(r => r.map(x => (`${x}`).includes(',')?`"${(`${x}`).replace(/"/g,'""')}"`:`${x}`).join(',')).join('\n');
    downloadCSV(csv, `punches_${active.empId}.csv`);
  });

  function getWorkedFromPairs(pairs){
    return sumPairs(pairs, parseInt(roundingSel.value,10)||0);
  }

  function computeWorked(emp, startDate, endDate){
    let total = 0;
    const current = new Date(startDate);
    while (current <= endDate){
      const key = ymd(current);
      const pairs = (emp.punches[key]||[]);
      total += getWorkedFromPairs(pairs);
      current.setDate(current.getDate()+1);
    }
    return total;
  }

  function computeExpectedRange(start, end){
    const expectedWD = (+expectedWDInp.value||0) * 3600;
    const expectedSat = (+expectedSatInp.value||0) * 3600;
    const satPolicy = satPolicySel.value;
    const expectedMode = expectedModeSel.value;

    let total = 0;
    const current = new Date(start);
    while (current <= end){
      const dow = current.getDay(); 
      const hasPunch = true; 
      total += calculateExpectedForDay(dow, expectedWD, expectedSat, satPolicy, expectedMode, hasPunch);
      current.setDate(current.getDate()+1);
    }
    return (expectedMode==='calendar') ? total : 0; 
  }

  function computeExpectedPunched(emp, start, end){
    const expectedWD = (+expectedWDInp.value||0) * 3600;
    const expectedSat = (+expectedSatInp.value||0) * 3600;
    const satPolicy = satPolicySel.value;

    let total = 0;
    const current = new Date(start);
    while (current <= end){
      const key = ymd(current);
      const pairs = (emp.punches[key]||[]);
      const dow = current.getDay();
      total += calculateExpectedForDay(dow, expectedWD, expectedSat, 'punch', 'punched', pairs.length>0);
      current.setDate(current.getDate()+1);
    }
    return total;
  }

  function refreshMyStats(){
    const active = getActive(); if (!active) return;
    const db = readDB(); const emp = db[active.empId]; if (!emp) return;

    const today = new Date();
    const todayKey = ymd(today);
    const todayPairs = emp.punches[todayKey] || [];
    const workedToday = getWorkedFromPairs(todayPairs);

    const expectedWD = (+expectedWDInp.value||0) * 3600;
    const expectedSat = (+expectedSatInp.value||0) * 3600;
    const satPolicy = satPolicySel.value;
    const expectedMode = expectedModeSel.value;
    const expectedToday = calculateExpectedForDay(
      today.getDay(), expectedWD, expectedSat, satPolicy, expectedMode, todayPairs.length>0
    );

    ME_today_worked.textContent   = secondsToHhMm(workedToday);
    ME_today_expected.textContent = secondsToHhMm(expectedToday);
    ME_today_left.textContent     = secondsToHhMm(Math.max(0, expectedToday - workedToday));

    if (todayPairs.length){
      const last = todayPairs[todayPairs.length-1];
      ME_last_action.textContent = last.out ? `Ø®Ø±ÙˆØ¬ ${last.out}` : `Ø¯Ø®ÙˆÙ„ ${last.in}`;
    } else {
      ME_last_action.textContent = 'â€”';
    }

    if (!todayPairs.length){
      ME_today_table.innerHTML = `<tr><td colspan="2" class="note" style="text-align:center;padding:20px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯.</td></tr>`;
    } else {
      ME_today_table.innerHTML = todayPairs.map(p => `
        <tr>
          <td class="mono">${p.in}${p.out?` â†’ ${p.out}`:''}</td>
          <td class="left">${p.out? 'Ø²ÙˆØ¬ Ù…ÙƒØªÙ…Ù„':'Ø¯Ø®ÙˆÙ„ Ù…ÙØªÙˆØ­'}</td>
        </tr>
      `).join('');
    }

    const ws = getWeekStart(today, parseInt(weekStartSel.value,10));
    const we = new Date(ws); we.setDate(ws.getDate()+6);
    const workedWeek = computeWorked(emp, ws, we);

    let expectedWeek = 0;
    if (expectedMode === 'calendar') expectedWeek = computeExpectedRange(ws, we);
    else expectedWeek = computeExpectedPunched(emp, ws, we);

    ME_week_worked.textContent   = secondsToHhMm(workedWeek);
    ME_week_expected.textContent = secondsToHhMm(expectedWeek);
    ME_week_left.textContent     = secondsToHhMm(Math.max(0, expectedWeek - workedWeek));

    const ms = new Date(today.getFullYear(), today.getMonth(), 1);
    const me = new Date(today.getFullYear(), today.getMonth()+1, 0);
    const workedMonth = computeWorked(emp, ms, me);
    ME_month_worked.textContent = secondsToHhMm(workedMonth);
  }

  [expectedWDInp, expectedSatInp, satPolicySel, expectedModeSel, roundingSel, weekStartSel]
    .forEach(el => el.addEventListener('change', refreshMyStats));

  showPunchUI();
  refreshMyStats(); 
})();
</script>
</body>
</html>
