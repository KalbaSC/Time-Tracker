<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ù„Ø®Ù‘Øµ Ø§Ù„Ø¨ØµÙ…Ø© â€” Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#222222; --accent:#f4e733; --text:#ffffff; --muted:#cfcfcf;
      --panel:#000000; --border:#f4e733; --soft:#444;
      --ok:#2bd886; --warn:#ffc266; --bad:#ff6b6b;
      --radius:16px; --transition: all 0.3s ease;
    }
    html, body { height: 100%; }
    body{
      margin:0; font-family: "Tajawal","NotoKufiArabic",system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
      color:var(--text); background:var(--bg);
      background-image:
        repeating-linear-gradient(45deg, rgba(244,231,51,.08) 0px, rgba(244,231,51,.08) 2px, transparent 2px, transparent 14px),
        repeating-linear-gradient(-45deg, rgba(244,231,51,.06) 0px, rgba(244,231,51,.06) 1px, transparent 1px, transparent 16px),
        radial-gradient(circle at 20% 30%, rgba(244,231,51,.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(244,231,51,.04) 0%, transparent 40%);
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      background:#222; padding:16px 5%; width:90%; margin:0 auto;
      border-bottom:3px solid var(--accent); position:sticky; top:0; z-index:1001;
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .header-right{display:flex; align-items:center; gap:15px; flex:1; min-width:0}
    .header-right img.logo{height:64px; object-fit:contain; transition: var(--transition);}
    .header-right img.logo:hover { transform: scale(1.05); }
    .header-right .divider{width:1.5px; height:60px; background:var(--accent)}
    .header-info{text-align:right} .title{margin:0; font-weight:800; font-size:18px}
    .subtitle{margin:0; font-size:14px; color:var(--accent)}
    
    main{flex:1; width:90%; margin:20px auto; display:grid; gap:16px}
    @media (min-width:1100px){ main{grid-template-columns:1fr 2fr} }
    
    .panel{
      background:var(--panel); border:2px solid var(--border); border-radius:var(--radius);
      padding:20px; box-shadow:0 6px 20px rgba(0,0,0,.25);
      transition: var(--transition);
    }
    .panel:hover { box-shadow: 0 8px 25px rgba(244,231,51,0.15); }
    
    .controls-container { margin-bottom: 20px; }
    .controls-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--soft);
    }
    .controls-title { 
      font-size: 18px; 
      font-weight: 700; 
      color: var(--accent); 
      margin: 0;
    }
    .controls{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:16px; align-items:flex-end}
    .control{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:var(--muted); font-weight: 600;}
    input, select{
      padding:12px 14px; background:#0f0f0f; color:var(--text); 
      border:1px solid #333; border-radius:12px; outline:none;
      transition: var(--transition);
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(244,231,51,0.2);
    }
    input[type="file"]{padding:10px; background:transparent; border:1px dashed #555; cursor: pointer;}
    input[type="file"]:hover { border-color: var(--accent); }
    
    /* Button improvements */
    .btn{
      appearance:none; border:none; border-radius:12px; padding:12px 16px;
      background:var(--accent); color:#000; font-weight:800; cursor:pointer;
      transition:var(--transition); box-shadow:0 4px 0 #a88600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #a88600; }
    .btn:active{transform:translateY(1px); box-shadow:0 3px 0 #a88600}
    .btn.secondary{
      background:#1b1b1b; color:var(--text); border:1px solid #333; box-shadow:none;
    }
    .btn.secondary:hover {
      background: #2a2a2a;
      border-color: var(--accent);
    }
    
    .note{color:var(--muted); font-size:12px; line-height: 1.5;}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    
    .kpi-container { margin: 20px 0; }
    .grid-4{display:grid; gap:12px; margin-top: 15px;}
    @media (min-width:900px){ .grid-4{grid-template-columns:repeat(4,1fr)} }
    .kpi{
      background:#0f0f0f; border:1px solid #333; border-radius:12px; padding:16px;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .kpi:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .kpi .label{font-size:12px; color:#fffde0; margin-bottom: 8px;} 
    .kpi .value{font-size:22px; font-weight:800;}
    .kpi.ok{border-color:rgba(43,216,134,.4)} 
    .kpi.warn{border-color:rgba(255,194,102,.5)}
    .kpi.bad{border-color:rgba(255,107,107,.5)}
    
    .table-container { margin-top: 20px; }
    .table-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px;
    }
    .table-title { 
      font-size: 18px; 
      font-weight: 700; 
      color: var(--accent); 
      margin: 0;
    }
    .table-wrap{
      position:relative; overflow:auto; max-height:70vh; border-radius:12px; 
      outline:1px solid #2a2a2a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .table-wrap::before{
      content:""; position:absolute; inset:-1px; border-radius:12px; pointer-events:none;
      background:linear-gradient(90deg,transparent,rgba(244,231,51,.2),transparent) top/100% 2px no-repeat,
                 linear-gradient(90deg,transparent,rgba(244,231,51,.2),transparent) bottom/100% 2px no-repeat
    }
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:6px}
    thead th{
      position:sticky; top:0; background:#111; z-index:1; text-align:right; 
      padding:14px 12px; font-size:13px; color:#fff17a; border-bottom:1px solid var(--accent);
      font-weight: 700;
    }
    tbody td{padding:12px; border-bottom:1px solid #2a2a2a; vertical-align:top}
    tbody tr{
      transition: var(--transition);
    }
    tbody tr:hover{
      background:#1a1a1a;
      transform: scale(1.005);
    }
    .left{text-align:left} .center{text-align:center}
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px;
      font-weight: 600;
    }
    .pill.ok{background:rgba(43,216,134,.12); color:var(--ok)}
    .pill.warn{background:rgba(255,194,102,.12); color:var(--warn)}
    .pill.bad{background:rgba(255,107,107,.12); color:var(--bad)}
    
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.75); 
      display:none; align-items:center; justify-content:center; z-index:9999;
      backdrop-filter: blur(4px);
    }
    .modal{
      width:min(980px,94vw); max-height:86vh; overflow:auto; 
      background:#0f0f0f; border:2px solid var(--border); border-radius:16px; 
      box-shadow:0 10px 35px rgba(0,0,0,.65);
      animation: modalAppear 0.3s ease-out;
    }
    @keyframes modalAppear {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal header{
      position:sticky; top:0; background:#111; padding:16px 20px; 
      border-bottom:1px solid var(--accent); 
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal h3{margin:0; font-size:18px} 
    .modal .content{padding:16px 20px}
    .close{
      background:#1b1b1b; color:#eee; border:1px solid #333; border-radius:10px; 
      padding:8px 12px; cursor:pointer;
      transition: var(--transition);
    }
    .close:hover {
      background: #2a2a2a;
      border-color: var(--accent);
    }
    
    .muted{color:var(--muted)} 
    .mono{font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace}
    .hint{font-size:12px; color:#fffde0; line-height: 1.5;}
    
    @media (max-width:768px){ 
      .header-right img.logo{height:40px} 
      .header-right .divider{display:none} 
      .controls { grid-template-columns: 1fr; }
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      main { width: 95%; }
    }
    
    @media (max-width:480px) {
      .grid-4 { grid-template-columns: 1fr; }
      .panel { padding: 15px; }
    }
    
    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-ok { background-color: var(--ok); }
    .status-warn { background-color: var(--warn); }
    .status-bad { background-color: var(--bad); }
    
    .section-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--accent), transparent);
      margin: 20px 0;
    }
    
    .file-upload-area {
      border: 2px dashed #555;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      margin-bottom: 15px;
    }
    .file-upload-area:hover {
      border-color: var(--accent);
      background: rgba(244,231,51,0.05);
    }
    .file-upload-area.active {
      border-color: var(--accent);
      background: rgba(244,231,51,0.1);
    }
    .file-upload-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-right">
      <img src="Picture3.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø§Ø±Ù‚Ø©" class="logo">
      <div class="divider"></div>
      <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡" class="logo">
      <div class="header-info">
        <p class="title">Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</p>
        <p class="subtitle">Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ØµÙ…Ø© â€” ÙŠÙˆÙ…ÙŠ / Ø£Ø³Ø¨ÙˆØ¹ÙŠ / Ø´Ù‡Ø±ÙŠ</p>
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="controls-container">
        <div class="controls-header">
          <h2 class="controls-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
          <div class="flex">
            <button id="recalc" class="btn">
              <span class="loading" id="loadingIndicator" style="display:none"></span>
              ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨
            </button>
          </div>
        </div>
        
        <div class="file-upload-area" id="fileUploadArea">
          <div class="file-upload-icon">ğŸ“</div>
          <p>Ø§Ù†Ù‚Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ØµÙ…Ø© (Excel) Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
          <p class="note">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Employee ID, First Name, Date, Time</p>
        </div>
        <input id="file" type="file" accept=".xlsx,.xls" style="display: none;" />

        <div class="controls">
          <div class="control">
            <label>Ø§Ù„Ø¹Ø±Ø¶</label>
            <select id="view">
              <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
              <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
              <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
            </select>
          </div>

          <div class="control">
            <label>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©/Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø£Ø­Ø¯â€“Ø§Ù„Ø®Ù…ÙŠØ³)</label>
            <input id="expectedWD" type="number" min="0" step="0.25" value="7" />
          </div>

          <div class="control">
            <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø³Ø¨Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="expectedSat" type="number" min="0" step="0.25" value="3" />
          </div>

          <div class="control">
            <label>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø³Ø¨Øª</label>
            <select id="satPolicy">
              <option value="punch">Ø§Ø­ØªØ³Ø§Ø¨ ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¨ØµÙ…Ø©</option>
              <option value="calendar">Ø§Ø­ØªØ³Ø§Ø¨ ØªÙ‚ÙˆÙŠÙ…ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§</option>
              <option value="off">Ø¹Ø¯Ù… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø¨Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§</option>
            </select>
          </div>

          <div class="control">
            <label>Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰</label>
            <select id="expectedMode">
              <option value="calendar">Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ÙŠØ©</option>
              <option value="punched">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ Ø¨Ù‡Ø§ Ø¨ØµÙ…Ø©</option>
            </select>
          </div>

          <div class="control">
            <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
            <select id="weekStart">
              <option value="0">Ø§Ù„Ø£Ø­Ø¯</option>
              <option value="1" selected>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
              <option value="6">Ø§Ù„Ø³Ø¨Øª</option>
            </select>
          </div>

          <div class="control">
            <label>ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¯Ø¯</label>
            <select id="rounding">
              <option value="0" selected>Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨</option>
              <option value="1">1 Ø¯Ù‚ÙŠÙ‚Ø©</option>
              <option value="5">5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="10">10 Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="15">15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            </select>
          </div>

          <div class="control">
            <label>ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <input id="empFilter" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" />
          </div>

          <div class="control">
            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="control">
            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="toDate" type="date" />
          </div>
        </div>
        
        <div class="section-divider"></div>
        
        <div class="flex" style="justify-content: space-between; flex-wrap: wrap; gap: 10px;">
          <div>
            <p class="note">
              Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: <b>Employee ID</b>ØŒ <b>First Name</b>ØŒ <b>Date</b>ØŒ <b>Time</b> (Ø£ÙˆÙ‚Ø§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„: IN, OUT, IN, OUTâ€¦). ÙŠÙØªØ¬Ø§Ù‡Ù„ Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„ Ø¨Ù„Ø§ Ø®Ø±ÙˆØ¬.
            </p>
          </div>
          <div class="flex">
            <button id="downloadSummary" class="btn secondary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ CSV (Ø§Ù„Ù…Ù„Ø®Øµ)</button>
            <button id="downloadDetails" class="btn secondary">ğŸ“Š ØªÙ†Ø²ÙŠÙ„ CSV (ØªÙØµÙŠÙ„ÙŠ)</button>
          </div>
        </div>
      </div>

      <div class="kpi-container">
        <h3 class="controls-title">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</h3>
        <div class="grid-4" id="kpis">
          <div class="kpi">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„</div>
            <div class="value" id="kpiWorked">00:00</div>
          </div>
          <div class="kpi">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹</div>
            <div class="value" id="kpiExpected">00:00</div>
          </div>
          <div class="kpi ok">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</div>
            <div class="value" id="kpiOver">00:00</div>
          </div>
          <div class="kpi bad">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Øµ</div>
            <div class="value" id="kpiShort">00:00</div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="table-container">
        <div class="table-header">
          <h2 class="table-title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨ØµÙ…Ø©</h2>
          <div class="note"><span id="meta">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø­Ù…Ù‘Ù„.</span></div>
        </div>

        <div class="table-wrap">
          <table id="table">
            <thead>
              <tr>
                <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ÙØªØ±Ø©</th>
                <th class="left">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th>
                <th class="left">Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹</th>
                <th class="left">Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</th>
                <th class="left">Ø§Ù„Ù†Ù‚Øµ</th>
                <th class="center">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="8" class="note" style="text-align: center; padding: 40px;">Ø­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</td></tr>
            </tbody>
          </table>
        </div>
        <p class="hint" id="hintPolicy" style="margin-top:12px"></p>
      </div>
    </section>
  </main>

  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø©</h3>
        <button class="close" id="closeModal">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
      </header>
      <div class="content">
        <div class="muted" id="modalMeta"></div>
        <div class="table-wrap" style="margin-top:16px; max-height:60vh">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ (Ø¯Ø®ÙˆÙ„ â†’ Ø®Ø±ÙˆØ¬)</th>
                <th class="left">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…</th>
              </tr>
            </thead>
            <tbody id="detailsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const fileInput = $('file'), viewSel = $('view'), weekStartSel = $('weekStart');
  const expectedWDInp = $('expectedWD'), expectedSatInp = $('expectedSat'), satPolicySel = $('satPolicy');
  const expectedModeSel = $('expectedMode'), roundingSel = $('rounding');
  const empFilterInp = $('empFilter'), fromDateInp = $('fromDate'), toDateInp = $('toDate');
  const metaEl = $('meta'), tbody = $('tbody'), hintPolicy = $('hintPolicy');
  const kpiWorked = $('kpiWorked'), kpiExpected = $('kpiExpected'), kpiOver = $('kpiOver'), kpiShort = $('kpiShort');
  const recalcBtn = $('recalc'), dlSumBtn = $('downloadSummary'), dlDetBtn = $('downloadDetails');
  const fileUploadArea = $('fileUploadArea'), loadingIndicator = $('loadingIndicator');

  const modalBackdrop = $('modalBackdrop'), closeModalBtn = $('closeModal'), modalTitle = $('modalTitle'), modalMeta = $('modalMeta'), detailsBody = $('detailsBody');

  let rawRows = []; 
  let groupedDetails = new Map(); 
  let lastSummaryCSV = '', lastDetailedCSV = '';

  fileUploadArea.addEventListener('click', () => fileInput.click());
  fileUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadArea.classList.add('active');
  });
  fileUploadArea.addEventListener('dragleave', () => {
    fileUploadArea.classList.remove('active');
  });
  fileUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadArea.classList.remove('active');
    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      handleFile();
    }
  });

  fileInput.addEventListener('change', handleFile);
  [recalcBtn, viewSel, weekStartSel, expectedWDInp, expectedSatInp, satPolicySel, expectedModeSel, roundingSel, empFilterInp, fromDateInp, toDateInp]
    .forEach(el => el.addEventListener('change', render));
  closeModalBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', e => { if(e.target===modalBackdrop) closeModal(); });
  dlSumBtn.addEventListener('click', ()=> downloadCSV(lastSummaryCSV, 'timecard_summary.csv'));
  dlDetBtn.addEventListener('click', ()=> downloadCSV(lastDetailedCSV, 'timecard_details.csv'));

  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  fromDateInp.value = formatDateForInput(firstDay);
  toDateInp.value = formatDateForInput(lastDay);

  function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
  }

  function downloadCSV(text, filename){
    if (!text){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„ Ø¨Ø¹Ø¯.'); return; }
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  }

  function handleFile(){
    const f = fileInput.files?.[0]; if (!f) return;
    
    fileUploadArea.innerHTML = `
      <div class="file-upload-icon">âœ…</div>
      <p>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${f.name}</p>
      <p class="note">Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    `;
    
    loadingIndicator.style.display = 'inline-block';
    
    const reader = new FileReader();
    reader.onload = evt => {
      try{
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});

        let headerIdx = rows.findIndex(r => String(r[0]).trim().toLowerCase() === 'employee id');
        if (headerIdx === -1) headerIdx = rows.findIndex(r => r.some(c => String(c).trim().toLowerCase() === 'employee id'));
        if (headerIdx === -1) { 
          alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ "Employee ID".'); 
          fileUploadArea.innerHTML = `
            <div class="file-upload-icon">ğŸ“</div>
            <p>Ø§Ù†Ù‚Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ØµÙ…Ø© (Excel) Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
            <p class="note">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Employee ID, First Name, Date, Time</p>
          `;
          loadingIndicator.style.display = 'none';
          return; 
        }

        const header = rows[headerIdx];
        const colIdx = {
          empId: header.findIndex(h => String(h).trim().toLowerCase().includes('employee id')),
          name:  header.findIndex(h => String(h).trim().toLowerCase().includes('first name')),
          date:  header.findIndex(h => String(h).trim().toLowerCase() === 'date'),
          timeList: header.findIndex(h => String(h).trim().toLowerCase() === 'time'),
        };
        if (colIdx.empId === -1) colIdx.empId = 0;
        if (colIdx.name  === -1) colIdx.name  = 1;
        if (colIdx.date  === -1) colIdx.date  = 2;
        if (colIdx.timeList === -1) colIdx.timeList = 4;

        const out = [];
        for (let i = headerIdx + 1; i < rows.length; i++){
          const r = rows[i]; if (!r || r.length===0) continue;
          const empId = String(r[colIdx.empId] ?? '').trim();
          const name = String(r[colIdx.name] ?? '').trim();
          const dateCell = r[colIdx.date];
          const timesStr = String(r[colIdx.timeList] ?? '').trim();
          if (!empId || !name || !dateCell) continue;

          const d = parseExcelDate(dateCell); if (!d) continue;

          const pairs = pairsFromCSV(timesStr);
          const workedSec = sumPairs(pairs, parseInt(roundingSel.value,10)||0);
          out.push({empId, name, date: d, pairs, workedSec});
        }
        rawRows = out;
        metaEl.textContent = `${f.name} â€” ØªÙ… ØªØ­Ù„ÙŠÙ„ ${out.length} ØµÙÙ‹Ø§`;
        
        fileUploadArea.innerHTML = `
          <div class="file-upload-icon">âœ…</div>
          <p>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${f.name}</p>
          <p class="note">ØªÙ… ØªØ­Ù„ÙŠÙ„ ${out.length} Ø³Ø¬Ù„ Ø¨ØµÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­</p>
        `;
        
        loadingIndicator.style.display = 'none';
        render();
      }catch(err){ 
        console.error(err); 
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.'); 
        fileUploadArea.innerHTML = `
          <div class="file-upload-icon">ğŸ“</div>
          <p>Ø§Ù†Ù‚Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ØµÙ…Ø© (Excel) Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</p>
          <p class="note">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Employee ID, First Name, Date, Time</p>
        `;
        loadingIndicator.style.display = 'none';
      }
    };
    reader.readAsArrayBuffer(f);
  }

  function render(){
    if (!rawRows.length){
      tbody.innerHTML = `<tr><td colspan="8" class="note" style="text-align: center; padding: 40px;">Ø­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</td></tr>`;
      lastSummaryCSV = lastDetailedCSV = '';
      updateKPIs(0,0,0,0);
      hintPolicy.textContent = '';
      return;
    }

    loadingIndicator.style.display = 'inline-block';
    
    setTimeout(() => {
      const empFilter = (empFilterInp.value||'').trim().toLowerCase();
      const fromDate = fromDateInp.value ? new Date(fromDateInp.value) : null;
      const toDate = toDateInp.value ? new Date(toDateInp.value) : null;
      const view = viewSel.value;
      const weekStart = parseInt(weekStartSel.value,10);
      const expectedWD = (+expectedWDInp.value||0) * 3600;
      const expectedSat = (+expectedSatInp.value||0) * 3600;
      const satPolicy = satPolicySel.value; 
      const expectedMode = expectedModeSel.value; 

      const map = new Map(); 
      for (const row of rawRows){
        if (empFilter && !(row.empId.toLowerCase().includes(empFilter) || row.name.toLowerCase().includes(empFilter))) continue;
        if (fromDate && row.date < fromDate) continue;
        if (toDate && row.date > toDate) continue;

        let periodKey = '';
        if (view === 'daily'){ periodKey = ymd(row.date); }
        else if (view === 'weekly'){ periodKey = 'W:'+ymd(getWeekStart(row.date, weekStart)); }
        else { periodKey = 'M:'+ym(row.date); }

        const key = `${row.empId}||${row.name}||${periodKey}`;
        if (!map.has(key)){
          map.set(key, {empId:row.empId, name:row.name, period:periodKey, workedSec:0, days:new Map()});
        }
        const obj = map.get(key);
        obj.workedSec += row.workedSec;
        obj.days.set(ymd(row.date), {pairs:row.pairs, workedSec:row.workedSec, dow:row.date.getDay()});
      }

      const rows = [];
      let totalWorked=0, totalExpected=0, totalOver=0, totalShort=0;
      for (const obj of map.values()){
        let expectedSec = 0;

        if (view === 'daily'){
          const dkey = [...obj.days.keys()][0];
          const info = obj.days.get(dkey);
          expectedSec = expectedForDayKey(dkey, info.dow, expectedWD, expectedSat, satPolicy, expectedMode, !!info.pairs?.length);
        } else {
          const range = periodRange(obj.period, weekStart);
          if (expectedMode === 'calendar'){
            expectedSec += expectedWD * countWeekdays(range.start, range.end, [0,1,2,3,4]); 
            if (satPolicy === 'calendar') expectedSec += expectedSat * countWeekdays(range.start, range.end, [6]); 
          } else {
            for (const [dkey, info] of obj.days){
              expectedSec += expectedForDayKey(dkey, info.dow, expectedWD, expectedSat, satPolicy, 'punch', !!info.pairs?.length);
            }
          }
        }

        const delta = obj.workedSec - expectedSec;
        const over = Math.max(0, delta);
        const short = Math.max(0, -delta);

        totalWorked += obj.workedSec; totalExpected += expectedSec; totalOver += over; totalShort += short;

        rows.push({
          key: `${obj.empId}||${obj.name}||${obj.period}`,
          empId: obj.empId, name: obj.name,
          period: prettyPeriod(obj.period, weekStart),
          worked: secToHrsMins(obj.workedSec),
          expected: secToHrsMins(expectedSec),
          over: secToHrsMins(over),
          short: secToHrsMins(short),
          details: obj.days,
        });
      }

      rows.sort((a,b)=> a.empId.localeCompare(b.empId) || a.period.localeCompare(b.period));

      tbody.innerHTML = '';
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${r.empId}</td>
          <td>${r.name}</td>
          <td>${r.period}</td>
          <td class="left">${r.worked}</td>
          <td class="left">${r.expected}</td>
          <td class="left"><span class="pill ok">${r.over}</span></td>
          <td class="left"><span class="pill bad">${r.short}</span></td>
          <td class="center"><button class="btn secondary" data-key="${r.key}">ğŸ“‹ Ø¹Ø±Ø¶</button></td>
        `;
        tbody.appendChild(tr);
      }

      tbody.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', e => showDetails(e.target.dataset.key));
      });

      updateKPIs(totalWorked, totalExpected, totalOver, totalShort);

      hintPolicy.textContent = `Ø§Ù„Ø³ÙŠØ§Ø³Ø©: ${expectedMode==='calendar'?'Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ÙŠØ©':'Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ Ø¨Ù‡Ø§ Ø¨ØµÙ…Ø©'}ØŒ Ø§Ù„Ø³Ø¨Øª: ${satPolicy==='punch'?'Ø¨Ø§Ù„Ø¨ØµÙ…Ø©':satPolicy==='calendar'?'ØªÙ‚ÙˆÙŠÙ…ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§':'ØºÙŠØ± Ù…Ø­ØªØ³Ø¨'}.`;

      lastSummaryCSV = 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„ÙØªØ±Ø©,Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„,Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹,Ø§Ù„Ø²ÙŠØ§Ø¯Ø©,Ø§Ù„Ù†Ù‚Øµ\n'+
        rows.map(r => `${r.empId},${r.name},${r.period},${r.worked},${r.expected},${r.over},${r.short}`).join('\n');

      const detailRows = [];
      for (const r of rows){
        for (const [dkey, info] of r.details){
          const d = parseYmd(dkey);
          detailRows.push({
            empId: r.empId, name: r.name, period: r.period, date: dkey,
            dow: ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'][d.getDay()],
            pairs: info.pairs.map(p => `${p.in}â†’${p.out}`).join('; '),
            worked: secToHrsMins(info.workedSec),
          });
        }
      }
      lastDetailedCSV = 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„ÙØªØ±Ø©,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ÙŠÙˆÙ…,Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ (Ø¯Ø®ÙˆÙ„â†’Ø®Ø±ÙˆØ¬),Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„\n'+
        detailRows.map(r => `${r.empId},${r.name},${r.period},${r.date},${r.dow},"${r.pairs}",${r.worked}`).join('\n');

      groupedDetails = map;
      
      loadingIndicator.style.display = 'none';
    }, 50);
  }

  function updateKPIs(worked, expected, over, short){
    kpiWorked.textContent = secToHrsMins(worked);
    kpiExpected.textContent = secToHrsMins(expected);
    kpiOver.textContent = secToHrsMins(over);
    kpiShort.textContent = secToHrsMins(short);
  }

  function showDetails(key){
    const obj = groupedDetails.get(key);
    if (!obj) return;
    modalTitle.textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø© â€” ${obj.name} (${obj.empId})`;
    modalMeta.textContent = `Ø§Ù„ÙØªØ±Ø©: ${prettyPeriod(obj.period, parseInt(weekStartSel.value,10))}`;

    const days = [...obj.days.entries()].sort((a,b)=> a[0].localeCompare(b[0]));
    detailsBody.innerHTML = '';
    for (const [dkey, info] of days){
      const d = parseYmd(dkey);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${dkey} (${['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'][d.getDay()]})</td>
        <td>${info.pairs.length ? info.pairs.map(p => `${p.in} â†’ ${p.out}`).join('<br>') : '<span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø²ÙˆØ§Ø¬</span>'}</td>
        <td class="left">${secToHrsMins(info.workedSec)}</td>
      `;
      detailsBody.appendChild(tr);
    }
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden', 'false');
  }

  function closeModal(){
    modalBackdrop.style.display = 'none';
    modalBackdrop.setAttribute('aria-hidden', 'true');
  }

  function parseExcelDate(v){
    if (typeof v === 'number') return new Date(Math.round((v - 25569)*86400*1000));
    if (typeof v === 'string') return new Date(v);
    if (v instanceof Date) return v;
    return null;
  }

  function pairsFromCSV(timesStr){
    const parts = timesStr.split(',').map(s => s.trim()).filter(Boolean);
    const pairs = [];
    for (let i=0; i<parts.length; i+=2){
      if (i+1 < parts.length) pairs.push({in:parts[i], out:parts[i+1]});
    }
    return pairs;
  }

  function sumPairs(pairs, rounding){
    let totalSec = 0;
    for (const p of pairs){
      const inSec = timeToSec(p.in), outSec = timeToSec(p.out);
      if (inSec===null || outSec===null) continue;
      let diff = outSec - inSec;
      if (rounding > 0) diff = Math.round(diff / (rounding*60)) * (rounding*60);
      totalSec += Math.max(0, diff);
    }
    return totalSec;
  }

  function timeToSec(t){
    if (!t) return null;
    const m = String(t).match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*(AM|PM))?$/i);
    if (!m) return null;
    let h = +m[1], min = +m[2], sec = m[3] ? +m[3] : 0;
    const pm = m[4]?.toUpperCase() === 'PM';
    if (pm && h < 12) h += 12;
    if (!pm && h === 12) h = 0;
    return h*3600 + min*60 + sec;
  }

  function secToHrsMins(sec){
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
    return `${h}:${m<10?'0':''}${m}`;
  }

  function ymd(d){ return d.toISOString().split('T')[0]; }
  function ym(d){ return d.toISOString().substring(0,7); }
  function parseYmd(s){ return new Date(s); }

  function getWeekStart(d, weekStart){
    const day = d.getDay(); const diff = (day - weekStart + 7) % 7; const start = new Date(d); start.setDate(d.getDate() - diff); return start;
  }

  function periodRange(periodKey, weekStart){
    if (periodKey.includes('W:')){
      const start = parseYmd(periodKey.substring(2));
      const end = new Date(start); end.setDate(start.getDate() + 6);
      return {start, end};
    } else if (periodKey.includes('M:')){
      const [y,m] = periodKey.substring(2).split('-').map(Number);
      const start = new Date(y, m-1, 1);
      const end = new Date(y, m, 0);
      return {start, end};
    } else {
      const d = parseYmd(periodKey);
      return {start: d, end: d};
    }
  }

  function countWeekdays(start, end, daysOfWeek){
    let count = 0; const d = new Date(start);
    while (d <= end){
      if (daysOfWeek.includes(d.getDay())) count++;
      d.setDate(d.getDate() + 1);
    }
    return count;
  }

  function expectedForDayKey(dkey, dow, expectedWD, expectedSat, satPolicy, expectedMode, hasPunch){
    if (dow === 5) return 0; 
    if (dow === 6){ 
      if (satPolicy === 'off') return 0;
      if (satPolicy === 'punch' && !hasPunch) return 0;
      return expectedSat;
    }
    if (expectedMode === 'punch' && !hasPunch) return 0;
    return expectedWD;
  }

  function prettyPeriod(periodKey, weekStart){
    if (periodKey.includes('W:')){
      const start = parseYmd(periodKey.substring(2));
      const end = new Date(start); end.setDate(start.getDate() + 6);
      return `${ymd(start)} â†’ ${ymd(end)}`;
    } else if (periodKey.includes('M:')){
      const [y,m] = periodKey.substring(2).split('-').map(Number);
      return new Date(y, m-1, 1).toLocaleDateString('ar', {year:'numeric', month:'long'});
    } else {
      return periodKey;
    }
  }
})();
</script>
</body>
</html>
