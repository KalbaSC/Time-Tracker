
<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø© - Ù†Ø§Ø¯ÙŠ Ø§ØªØ­Ø§Ø¯ ÙƒÙ„Ø¨Ø§Ø¡</title>
  <link rel="stylesheet" href="ksc-shared.css" />
  <style>
    body{direction:rtl;text-align:right}
    .gate{max-width:720px;margin:60px auto}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f1f1f;border:1px solid #2a2a2a;color:#aaa;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .small{font-size:12px;color:#aaa}
    .btn-danger{background:#2a1212;border-color:#4a1e1e;color:#f4b4b4}
    .btn-ok{background:#0f2418;border-color:#205a3f;color:#9fe0bc}
    .hint{color:#aaa;font-size:12px;margin-top:6px}
    .mono{font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .table-wrap{max-height:340px;overflow:auto;border:1px solid #222;border-radius:12px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.two{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <img src="logo.png" class="brand-logo" style="width:40px;height:40px;border-radius:50%" alt="logo">
        <div class="brand-title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø©</div>
      </div>
      <nav class="nav">
        <a href="ksc-punch.html">Ø§Ù„Ø¨ØµÙ…Ø©</a>
        <a href="ksc-summary.html">Ù…Ù„Ø®ØµÙŠ</a>
        <button id="btnLogout" class="secondary">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </nav>
    </header>

    <!-- Admin Gate -->
    <section class="card gate" id="gateBox">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
      <div class="grid">
        <div class="col">
          <label>Ø±Ù…Ø² Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© (HR)</label>
          <input id="adminPass" type="password" placeholder="Ù…Ø«Ø§Ù„: kalbaHR2025">
          <div class="hint">ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>
        </div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="btnAdminLogin">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
      </div>
      <p id="gateMsg" class="note"></p>
    </section>

    <section class="card" id="adminBox" style="display:none">
      <div class="toolbar" style="justify-content:space-between">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
        <span class="badge">ÙˆØ¶Ø¹ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª: <b id="connState">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</b></span>
      </div>

      <div class="two">
        <!-- Employees -->
        <div class="card">
          <h2>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</h2>
          <div class="grid">
            <div class="col">
              <label>Ø§Ù„Ø§Ø³Ù…</label>
              <input id="empNameIn" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            </div>
            <div class="col">
              <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
              <input id="empIdIn" placeholder="Ù…Ø«Ø§Ù„: 12034" class="mono">
            </div>
            <div class="col">
              <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)</label>
              <input id="empPinIn" type="password" inputmode="numeric" placeholder="4â€“6 Ø£Ø±Ù‚Ø§Ù…">
            </div>
            <div class="col">
              <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select id="empActiveIn">
                <option value="1">Ù†Ø´Ø·</option>
                <option value="0">Ù…ÙˆÙ‚ÙˆÙ</option>
              </select>
            </div>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button id="btnAddEmp">â• Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ«</button>
            <button id="btnDelEmp" class="btn-danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <button id="btnSyncEmployees" class="secondary">â¤´ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ù„Ù‰ Google Sheet</button>
          </div>

          <div class="table-wrap" style="margin-top:10px">
            <table class="table">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
              <tbody id="empTable"><tr><td colspan="3" class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ø¨Ø¹Ø¯.</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- Work Hours / Settings -->
        <div class="card">
          <h2>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</h2>
          <div class="grid">
            <div class="col">
              <label>Ø§Ù„Ø£Ø­Ø¯ â€“ Ø§Ù„Ø®Ù…ÙŠØ³ (Ø³Ø§Ø¹Ø§Øª)</label>
              <input id="confWDDuration" value="7" type="number" min="0" step="0.5">
              <div class="hint">Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ 7 Ø³Ø§Ø¹Ø§Øª (9â€“1) + (4:30â€“7:30) Ø£Ùˆ (5â€“8).</div>
            </div>
            <div class="col">
              <label>Ø§Ù„Ø³Ø¨Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ø³Ø§Ø¹Ø§Øª Ø¥Ø°Ø§ Ø­Ø¶Ø±</label>
              <input id="confSatDuration" value="3" type="number" min="0" step="0.5">
            </div>
            <div class="col">
              <label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
              <input id="confAdminPass" type="password" placeholder="kalbaHR2025">
            </div>

          </div>
          <div class="toolbar" style="margin-top:10px">
            <button id="btnSaveSettings" class="btn-ok">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          </div>
          <p class="small">* ØªÙØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ/Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙˆÙ„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Google Sheets.</p>
        </div>
      </div>

      <!-- Leaves -->
      <div class="card">
        <h2>Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h2>
        <div class="grid">
          <div class="col">
            <label>Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ)</label>
            <input id="lvEmpId" class="mono" placeholder="1234">
          </div>
          <div class="col">
            <label>Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="lvType">
              <option value="Sick">Ù…Ø±Ø¶ÙŠØ©</option>
              <option value="Annual">Ø³Ù†ÙˆÙŠØ©</option>
              <option value="Unpaid">Ø¨Ø¯ÙˆÙ† Ø±Ø§ØªØ¨</option>
              <option value="Other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div class="col">
            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="lvFrom" type="date">
          </div>
          <div class="col">
            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="lvTo" type="date">
          </div>
          <div class="col">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <input id="lvNote" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          </div>
          <div class="col">
            <label>Ù…Ø±ÙÙ‚ (ØµÙˆØ±Ø©/ PDF)</label>
            <input id="lvFile" type="file" accept=".png,.jpg,.jpeg,.pdf">
          </div>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button id="btnAddLeave">â• ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø§Ø²Ø©</button>
          <button id="btnSyncLeaves" class="secondary">â¤´ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø¥Ù„Ù‰ Google Sheet</button>
        </div>
        <div class="table-wrap" style="margin-top:10px">
          <table class="table">
            <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…Ù†</th><th>Ø¥Ù„Ù‰</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
            <tbody id="lvTable"><tr><td colspan="5" class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>ØªÙ‚Ø§Ø±ÙŠØ±</h2>
        <div class="toolbar">
          <button id="btnExportEmployees" class="secondary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (CSV)</button>
          <button id="btnExportLeaves" class="secondary">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (CSV)</button>
          <button id="btnAskReport" class="btn-ok">ğŸ“Š Ø·Ù„Ø¨ ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª</button>
        </div>
        <p class="small">Ø²Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ±Ø³Ù„ Ø·Ù„Ø¨Ù‹Ø§ Ù„Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ø¥Ù†ØªØ§Ø¬ ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©/Ø´Ù‡Ø±ÙŠØ© Ø­Ø³Ø¨ Ù…Ø§ Ø³ØªØ¶Ø¨Ø·ÙˆÙ†Ù‡ Ù‡Ù†Ø§Ùƒ.</p>
      </div>
    </section>

    <div class="footer">Â© Ù†Ø§Ø¯ÙŠ Ø§ØªØ­Ø§Ø¯ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</div>
  </div>

  <script src="ksc-shared.js"></script>
  <script>
    const USE_PROXY = true; 
    const PROXY_URL = "https://YOUR-PROXY.example.workers.dev";
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3eJzO1iruN7NjYTkooV5f1kIukOXkLx_Mj9OWts8X3UTcXSrSWqiTZeHJPUums28J/exec"; 
    const DEFAULT_ADMIN = 'kalbaHR2025';

    const state = {
      employees: {},
      leaves: [],
      settings: {
        wdHours: 7,
        satHours: 3,
        adminPass: DEFAULT_ADMIN,
        scriptUrl: ''
      }
    };

    function loadState(){
      try{
        const s = JSON.parse(localStorage.getItem('kscAdminState')||'null');
        if(s){ Object.assign(state, s); }
      }catch(e){}
      $('confWDDuration').value = state.settings.wdHours;
      $('confSatDuration').value = state.settings.satHours;
      $('confAdminPass').value = state.settings.adminPass;
      $('confScriptUrl').value = state.settings.scriptUrl;
      renderEmployees();
      renderLeaves();
    }
    function saveState(){
      localStorage.setItem('kscAdminState', JSON.stringify(state));
    }

    function renderEmployees(){
      const tbody = $('empTable');
      const ids = Object.keys(state.employees);
      if(!ids.length){ tbody.innerHTML = '<tr><td colspan="3" class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ø¨Ø¹Ø¯.</td></tr>'; return; }
      tbody.innerHTML = ids.map(id => {
        const e = state.employees[id];
        return '<tr><td>'+e.name+'</td><td class="mono">'+id+'</td><td>'+(e.active?'Ù†Ø´Ø·':'Ù…ÙˆÙ‚ÙˆÙ')+'</td></tr>';
      }).join('');
    }
    function renderLeaves(){
      const tbody = $('lvTable');
      if(!state.leaves.length){ tbody.innerHTML = '<tr><td colspan="5" class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</td></tr>'; return; }
      tbody.innerHTML = state.leaves.map(l => (
        '<tr><td class="mono">'+l.id+'</td><td>'+l.type+'</td><td>'+l.from+'</td><td>'+l.to+'</td><td>'+(l.note||'')+'</td></tr>'
      )).join('');
    }

    // --- Gate ---
    $('btnAdminLogin').onclick = () => {
      const pass = $('adminPass').value.trim();
      const ok = pass && pass === state.settings.adminPass;
      if(ok){
        localStorage.setItem(LS_ADMIN,'1');
        $('gateBox').style.display = 'none';
        $('adminBox').style.display = '';
      }else{
        $('gateMsg').textContent = 'Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØºÙŠØ± ØµØ­ÙŠØ­.';
      }
    };
    $('btnLogout').onclick = () => {
      localStorage.removeItem(LS_ADMIN);
      KSC.setActive(null);
      location.href = 'ksc-auth.html';
    };

    // Auto open if already logged as admin
    if(localStorage.getItem(LS_ADMIN)==='1'){
      $('gateBox').style.display='none'; $('adminBox').style.display='';
    }

    // --- Employees actions ---
    $('btnAddEmp').onclick = () => {
      const name = $('empNameIn').value.trim();
      const id = $('empIdIn').value.trim();
      const pin = $('empPinIn').value.trim();
      const active = $('empActiveIn').value === '1';
      if(!name || !id || !pin){ alert('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆØ§Ù„Ù€ PIN.'); return; }
      state.employees[id] = { name, pin, active };
      saveState(); renderEmployees();

      // also store to user DB (used by punch pages)
      const db = KSC.readDB(); db[id] = db[id] || { name:'', pin:'', punches:{} };
      db[id].name = name; db[id].pin = pin; if(!db[id].punches) db[id].punches={};
      KSC.writeDB(db);
    };

    $('btnDelEmp').onclick = () => {
      const id = $('empIdIn').value.trim();
      if(!id){ alert('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡.'); return; }
      if(!state.employees[id]){ alert('Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§ØªÙ‡ Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ')) return;
      delete state.employees[id]; saveState(); renderEmployees();
      const db = KSC.readDB(); delete db[id]; KSC.writeDB(db);
    };

    // --- Settings ---
    $('btnSaveSettings').onclick = () => {
      state.settings.wdHours = +$('confWDDuration').value || 7;
      state.settings.satHours = +$('confSatDuration').value || 3;
      state.settings.adminPass = $('confAdminPass').value || DEFAULT_ADMIN;
      state.settings.scriptUrl = $('confScriptUrl').value.trim();
      saveState();
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
    };

    // --- Leaves ---
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = () => resolve(r.result.split(',')[1]); // remove data:...;base64,
        r.onerror = reject; r.readAsDataURL(file);
      });
    }

    $('btnAddLeave').onclick = async () => {
      const id = $('lvEmpId').value.trim();
      const type = $('lvType').value;
      const from = $('lvFrom').value;
      const to = $('lvTo').value || from;
      const note = $('lvNote').value.trim();
      const f = $('lvFile').files[0];

      if(!id || !from){ alert('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.'); return; }
      const entry = { id, type, from, to, note, fileName: f?f.name:'' };
      if(f){ entry.base64 = await fileToBase64(f); }
      state.leaves.push(entry); saveState(); renderLeaves();
    };

    $('btnExportEmployees').onclick = () => {
      const rows = [['EmpID','Name','PIN','Active']];
      Object.keys(state.employees).forEach(id => {
        const e = state.employees[id]; rows.push([id, e.name, e.pin, e.active?'1':'0']);
      });
      KSC.downloadCSV(rows, 'employees.csv');
    };
    $('btnExportLeaves').onclick = () => {
      const rows = [['EmpID','Type','From','To','Note','FileName']];
      state.leaves.forEach(l => rows.push([l.id,l.type,l.from,l.to,l.note||'',l.fileName||'']));
      KSC.downloadCSV(rows, 'leaves.csv');
    };

async function postToScript(action, payload) {
  const url = USE_PROXY ? PROXY_URL : APPS_SCRIPT_URL;

  if (!url) {
    alert('Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.');
    return { ok: false, error: 'No URL' };
  }

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, payload })
    });
    const text = await res.text();
    try { return JSON.parse(text); } catch { return { ok:false, error:'Bad JSON', raw:text }; }
  } catch (e) {
    return { ok:false, error: String(e) };
  }
}

    $('btnSyncEmployees').onclick = async () => {
      const payload = state.employees;
      const r = await postToScript('syncEmployees', payload);
      alert(r.ok? 'ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.' : ('ÙØ´Ù„: ' + (r.error||'')));
    };

    $('btnSyncLeaves').onclick = async () => {
      const payload = state.leaves;
      const r = await postToScript('syncLeaves', payload);
      alert(r.ok? 'ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª.' : ('ÙØ´Ù„: ' + (r.error||'')));
    };

    $('btnAskReport').onclick = async () => {
      const r = await postToScript('generateReport', {period:'weekly'});
      alert(r.ok? ('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + (r.url||'')) : ('ÙØ´Ù„: ' + (r.error||'')));
    };

    $('btnTestConn').onclick = async () => {
      const r = await postToScript('ping', {});
      $('connState').textContent = r.ok? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„';
      if(!r.ok && r.error) alert(r.error);
    };

    // boot
    loadState();
  </script>
</body>
</html>
