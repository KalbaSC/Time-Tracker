<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø© | Ù†Ø§Ø¯ÙŠ Ø§ØªØ­Ø§Ø¯ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</title>
  <link rel="stylesheet" href="ksc-shared.css" />
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: "Tajawal", "Noto Kufi Arabic", sans-serif;
      direction: rtl;
      text-align: right;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0b0b0b;
      padding: 10px 20px;
      border-bottom: 2px solid #f6c21a;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo img {
      height: 45px;
      width: 45px;
      border-radius: 50%;
    }
    .logo h1 {
      font-size: 20px;
      margin: 0;
      color: #f6c21a;
    }
    #btnLogout {
      background: #f6c21a;
      color: #000;
      font-weight: 700;
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    #btnLogout:hover { background: #ffda41; }

    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }

    .card {
      background: #111;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    .card h2 {
      color: #f6c21a;
      margin-bottom: 15px;
    }
    .info {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: space-between;
      align-items: center;
      background: #0f0f0f;
      border-radius: 12px;
      padding: 15px;
      border: 1px solid #222;
    }
    .info-item {
      flex: 1 1 250px;
    }
    .label {
      color: #aaa;
      font-size: 14px;
    }
    .value {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    button {
      font-size: 18px;
      padding: 14px 40px;
      border-radius: 14px;
      cursor: pointer;
      border: none;
      transition: 0.2s;
    }
    #btnIn {
      background: #f6c21a;
      color: #000;
      font-weight: bold;
    }
    #btnOut {
      background: #222;
      color: #fff;
      border: 1px solid #333;
    }
    #btnIn:hover { background: #ffda41; }
    #btnOut:hover { background: #444; }

    #punchMsg {
      text-align: center;
      font-size: 15px;
      padding: 10px;
      border-radius: 10px;
    }
    .msg-ok {
      background: rgba(20,184,106,0.15);
      border: 1px solid #14b86a;
      color: #14b86a;
    }
    .msg-err {
      background: rgba(239,68,68,0.15);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #222;
      text-align: center;
    }
    th { color: #f6c21a; }
    .footer {
      text-align: center;
      color: #888;
      font-size: 13px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">
      <img src="logo.png" alt="Kalba Club Logo">
      <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø© - Ù†Ø§Ø¯ÙŠ Ø§ØªØ­Ø§Ø¯ ÙƒÙ„Ø¨Ø§Ø¡</h1>
    </div>
    <button id="btnLogout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </header>

  <div class="container">

    <section class="card">
      <h2>Ø§Ù„Ø¨ØµÙ…Ø©</h2>
      <div class="info">
        <div class="info-item">
          <div class="label">Ø§Ù„Ù…ÙˆØ¸Ù</div>
          <div class="value" id="empName">â€”</div>
        </div>
        <div class="info-item">
          <div class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</div>
          <div class="value" id="empId">â€”</div>
        </div>
        <div class="info-item">
          <div class="label">Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</div>
          <div class="value" id="lastAction">â€”</div>
        </div>
      </div>

      <div class="buttons">
        <button id="btnIn">â¬†ï¸ Ø¨ØµÙ…Ø© Ø¯Ø®ÙˆÙ„</button>
        <button id="btnOut">â¬‡ï¸ Ø¨ØµÙ…Ø© Ø®Ø±ÙˆØ¬</button>
      </div>

      <div id="punchMsg"></div>
    </section>

    <section class="card">
      <h2>Ø¨ØµÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
      <table>
        <thead>
          <tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr>
        </thead>
        <tbody id="todayTable">
          <tr><td colspan="2" class="small note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</td></tr>
        </tbody>
      </table>
    </section>

    <div class="footer">Â© Ù†Ø§Ø¯ÙŠ Ø§ØªØ­Ø§Ø¯ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</div>

  </div>

<script src="ksc-shared.js"></script>
<script>
KSC.initNav('punch');
const active = KSC.getActive();
if (!active) { location.href = 'ksc-auth.html'; }

const allowedZones = [
  { name: 'Ø§Ù„Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', lat: 25.05962, lng: 56.348197, radius: 150 },
  { name: 'Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¹ÙŠ', lat: 25.045830, lng: 56.358105, radius: 150 },
];

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
  const Î”Ï† = (lat2 - lat1) * Math.PI/180;
  const Î”Î» = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function isInsideAllowed(lat, lng) {
  for (const z of allowedZones) {
    const dist = getDistance(lat, lng, z.lat, z.lng);
    if (dist <= z.radius) return { ok: true, zone: z.name, dist };
  }
  return { ok: false };
}
function requestLocation(cb) {
  if (!navigator.geolocation) {
    alert('âš ï¸ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => cb(true, pos.coords.latitude, pos.coords.longitude),
    err => {
      alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
      cb(false);
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

const db = KSC.readDB();
const emp = db[active.empId];
$('empName').textContent = emp.name;
$('empId').textContent = active.empId;

function refresh() {
  const today = KSC.ymd(new Date());
  const pairs = emp.punches[today] || [];
  if (!pairs.length) {
    $('todayTable').innerHTML = '<tr><td colspan="2" class="small note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</td></tr>';
    $('lastAction').textContent = 'â€”';
  } else {
    $('todayTable').innerHTML = pairs.map(p =>
      `<tr><td>${p.in}${p.out ? ' â†’ ' + p.out : ''}</td><td>${p.out ? 'Ø²ÙˆØ¬ Ù…ÙƒØªÙ…Ù„' : 'Ø¯Ø®ÙˆÙ„ Ù…ÙØªÙˆØ­'}</td></tr>`
    ).join('');
    const last = pairs[pairs.length-1];
    $('lastAction').textContent = last.out ? ('Ø®Ø±ÙˆØ¬ ' + last.out) : ('Ø¯Ø®ÙˆÙ„ ' + last.in);
  }
  KSC.writeDB(db);
}

function handlePunch(type) {
  requestLocation((ok, lat, lng) => {
    if (!ok) return;
    const check = isInsideAllowed(lat, lng);
    if (!check.ok) {
      $('punchMsg').className = 'msg-err';
      $('punchMsg').textContent = 'âŒ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡.';
      return;
    }

    const today = KSC.ymd(new Date());
    emp.punches[today] = emp.punches[today] || [];
    const ps = emp.punches[today];

    if (type === 'in') {
      if (ps.length && !ps[ps.length-1].out) {
        $('punchMsg').className = 'msg-err';
        $('punchMsg').textContent = 'âš ï¸ Ù„Ø¯ÙŠÙƒ Ø¯Ø®ÙˆÙ„ Ù…ÙØªÙˆØ­ Ù„Ù… ÙŠÙØºÙ„Ù‚ Ø¨Ø¹Ø¯.';
        return;
      }
      ps.push({ in: KSC.nowHHMM(), out: '' });
      $('punchMsg').className = 'msg-ok';
      $('punchMsg').textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ (' + check.zone + ')';
    } else {
      if (!ps.length) {
        $('punchMsg').className = 'msg-err';
        $('punchMsg').textContent = 'âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø®ÙˆÙ„ Ù„Ø¥ØºÙ„Ø§Ù‚Ù‡.';
        return;
      }
      const last = ps[ps.length-1];
      if (last.out) {
        $('punchMsg').className = 'msg-err';
        $('punchMsg').textContent = 'âš ï¸ Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„ Ù…ØºÙ„Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„.';
        return;
      }
      last.out = KSC.nowHHMM();
      $('punchMsg').className = 'msg-ok';
      $('punchMsg').textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ (' + check.zone + ')';
    }
    refresh();
  });
}

$('btnIn').onclick = () => handlePunch('in');
$('btnOut').onclick = () => handlePunch('out');
$('btnLogout').onclick = () => { KSC.setActive(null); location.href = 'ksc-auth.html'; };

refresh();
</script>

</body>
</html>
