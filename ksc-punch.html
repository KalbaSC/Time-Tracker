
<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ø¨ØµÙ…Ø© | Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</title>
  <link rel="stylesheet" href="ksc-shared.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="brand-logo">K</div>
        <div class="brand-title">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø© - Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡</div>
      </div>
      <nav class="nav">
        <a id="nav-punch" href="ksc-punch.html">Ø§Ù„Ø¨ØµÙ…Ø©</a>
        <a id="nav-summary" href="ksc-summary.html">Ù…Ù„Ø®ØµÙŠ</a>
        <button id="btnLogout" class="secondary" style="margin-right:10px">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </nav>
    </header>

    <section class="card">
      <h2>Ø§Ù„Ø¨ØµÙ…Ø©</h2>
      <div id="authState" class="alert error small" style="display:none"></div>
      <div class="row">
        <div class="col">
          <div class="kpi"><div class="label">Ø§Ù„Ù…ÙˆØ¸Ù</div><div class="value" id="empName">â€”</div></div>
        </div>
        <div class="col">
          <div class="kpi"><div class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</div><div class="value mono" id="empId">â€”</div></div>
        </div>
        <div class="col">
          <div class="kpi"><div class="label">Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</div><div class="value" id="lastAction">â€”</div></div>
        </div>
      </div>

      <div class="row">
        <div class="col"><button id="btnIn">â¬†ï¸ Ø¨ØµÙ…Ø© Ø¯Ø®ÙˆÙ„</button></div>
        <div class="col"><button class="secondary" id="btnOut">â¬‡ï¸ Ø¨ØµÙ…Ø© Ø®Ø±ÙˆØ¬</button></div>
        <div class="col"><button class="secondary" id="btnLogout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></div>
      </div>
      <p id="punchMsg" class="note"></p>
    </section>

    <section class="card">
      <h2>Ø¨ØµÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
      <table class="table">
        <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr></thead>
        <tbody id="todayTable"><tr><td colspan="2" class="small note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</td></tr></tbody>
      </table>
    </section>

    <div class="footer">Â© Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ</div>
  </div>

<script src="ksc-shared.js"></script>
<script>
KSC.initNav('punch');
const active = KSC.getActive();
const authState = $('authState');
if (!active) {
  authState.style.display = 'block';
  authState.textContent = 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.';
  setTimeout(() => location.href = 'ksc-auth.html', 1200);
}

const allowedZones = [
  { name: 'Ù†Ø§Ø¯ÙŠ Ø§ØªØ­Ø§Ø¯ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ', lat: 25.05962, lng: 56.348197, radius: 150 },
  { name: 'Ù†Ø§Ø¯ÙŠ Ø§ØªØ­Ø§Ø¯ ÙƒÙ„Ø¨Ø§Ø¡ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ', lat: 25.045830, lng: 56.358105, radius: 150 },
];

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
  const Î”Ï† = (lat2 - lat1) * Math.PI/180;
  const Î”Î» = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function isInsideAllowed(lat, lng) {
  for (const z of allowedZones) {
    const dist = getDistance(lat, lng, z.lat, z.lng);
    if (dist <= z.radius) return { ok: true, zone: z.name, dist };
  }
  return { ok: false };
}

function requestLocation(cb) {
  if (!navigator.geolocation) {
    alert('âš ï¸ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => cb(true, pos.coords.latitude, pos.coords.longitude),
    err => {
      alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS.');
      cb(false);
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

const db = KSC.readDB();
const emp = (active && db[active.empId]) || { name:'â€”', punches:{} };
$('empName').textContent = emp.name;
$('empId').textContent = active ? active.empId : 'â€”';

function refresh() {
  const todayKey = KSC.ymd(new Date());
  const pairs = emp.punches[todayKey] || [];
  if (!pairs.length) {
    $('todayTable').innerHTML = '<tr><td colspan="2" class="small note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</td></tr>';
    $('lastAction').textContent = 'â€”';
  } else {
    $('todayTable').innerHTML = pairs.map(p =>
      `<tr><td class="mono">${p.in}${p.out ? (' â†’ ' + p.out) : ''}</td><td>${p.out ? 'Ø²ÙˆØ¬ Ù…ÙƒØªÙ…Ù„' : 'Ø¯Ø®ÙˆÙ„ Ù…ÙØªÙˆØ­'}</td></tr>`
    ).join('');
    const last = pairs[pairs.length-1];
    $('lastAction').textContent = last.out ? ('Ø®Ø±ÙˆØ¬ ' + last.out) : ('Ø¯Ø®ÙˆÙ„ ' + last.in);
  }
  KSC.writeDB(db);
}

function handlePunch(type) {
  requestLocation((ok, lat, lng) => {
    if (!ok) return;
    const check = isInsideAllowed(lat, lng);
    if (!check.ok) {
      $('punchMsg').innerHTML = 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ ' + (type === 'in' ? 'Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø§Ù„Ø®Ø±ÙˆØ¬') +
        ' Ù„Ø£Ù†Ùƒ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù†Ø§Ø¯ÙŠ.';
      return;
    }

    const today = KSC.ymd(new Date());
    emp.punches[today] = emp.punches[today] || [];
    const ps = emp.punches[today];

    if (type === 'in') {
      if (ps.length && !ps[ps.length-1].out) {
        $('punchMsg').textContent = 'ÙŠÙˆØ¬Ø¯ Ø¯Ø®ÙˆÙ„ Ù…ÙØªÙˆØ­ Ù„Ù… ÙŠÙØºÙ„Ù‚ Ø¨Ø¹Ø¯.';
        return;
      }
      ps.push({ in: KSC.nowHHMM(), out: '' });
      $('punchMsg').innerHTML = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ (' + check.zone + ')';
    } else {
      if (!ps.length) { $('punchMsg').textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø®ÙˆÙ„ Ù„Ø¥ØºÙ„Ø§Ù‚Ù‡.'; return; }
      const last = ps[ps.length-1];
      if (last.out) { $('punchMsg').textContent = 'Ø¢Ø®Ø± Ø²ÙˆØ¬ Ù…ØºÙ„Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„.'; return; }
      last.out = KSC.nowHHMM();
      $('punchMsg').innerHTML = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ (' + check.zone + ')';
    }

    refresh();
  });
}

$('btnIn').onclick = () => handlePunch('in');
$('btnOut').onclick = () => handlePunch('out');
$('btnLogout').onclick = () => {
  KSC.setActive(null);
  location.href = 'ksc-auth.html';
};

refresh();
</script>

</body>
</html>
