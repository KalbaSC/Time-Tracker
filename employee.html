<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø© - Ù†Ø§Ø¯ÙŠ ÙƒÙ„Ø¨Ø§Ø¡ | Ø§Ù„Ù…ÙˆØ¸Ù</title>
  <!-- Tajawal -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0a0a;
      --card:#121212;
      --accent:#f6c21a;
      --accent-soft:#ffd24a;
      --text:#f5f5f5;
      --muted:#b7b7b7;
      --line:#202020;
      --ok:#22c55e;
      --bad:#ef4444;
      --radius:18px;
      --radius-lg:22px;
      --shadow:0 8px 25px rgba(0,0,0,.45);
      font-family:"Tajawal",sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .login-card{
      max-width:480px;
      margin:40px auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      padding:22px;
      box-shadow:var(--shadow);
      text-align:center;
    }
    .login-card h2{
      color:var(--accent);
      font-weight:900;
      margin-bottom:20px;
      font-size:22px;
    }
    label{color:var(--muted); display:block; text-align:right; margin-bottom:6px; font-weight:700;}
    input{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:1px solid #2a2a2a;
      background:#0e0e0e;
      color:#fff;
      margin-bottom:12px;
    }
    input:focus{outline:none;border-color:var(--accent);}

    .btn-yellow{
      width:100%;
      padding:16px;
      border-radius:14px;
      background:var(--accent);
      color:#111;
      font-weight:900;
      font-size:17px;
      border:none;
      cursor:pointer;
      transition:.2s;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      box-shadow:var(--shadow);
    }
    .btn-yellow:hover{background:var(--accent-soft);}

    .msg{
      margin-top:10px;
      font-size:14px;
      font-weight:700;
      padding:10px;
      border-radius:10px;
      display:none;
    }
    .msg.ok{
      display:block;
      background:rgba(34,197,94,.12);
      color:var(--ok);
      border:1px solid rgba(34,197,94,.4);
    }
    .msg.err{
      display:block;
      background:rgba(239,68,68,.12);
      color:var(--bad);
      border:1px solid rgba(239,68,68,.4);
    }

    /* Dashboard Hidden by Default */
    #dash{display:none;}

    /* Logout button */
    .logout-btn{
      background:var(--accent);
      color:#111;
      font-weight:900;
      border:none;
      padding:10px 18px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      position:absolute;
      top:20px;
      left:20px;
      box-shadow:var(--shadow);
      transition:.2s;
    }
    .logout-btn:hover{background:var(--accent-soft);}

    .hero{
      text-align:center;
      margin:20px 0 10px;
    }
    .hero h1{
      color:var(--accent);
      font-weight:900;
      font-size:30px;
    }
    .hero p{
      color:var(--muted);
      font-size:15px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:14px;
      margin-top:15px;
    }
    .card{
      background:linear-gradient(180deg,#151515,#0f0f0f);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:18px;
      text-align:center;
      box-shadow:var(--shadow);
    }
    .label{color:#d7d7d7;font-size:14px;font-weight:700;}
    .value{font-size:28px;font-weight:900;}

    .section{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:16px;
      margin-top:20px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }
    th, td{
      padding:12px;
      border-bottom:1px solid var(--line);
      text-align:right;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Login only -->
    <div id="loginBox" class="login-card">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

      <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
      <input id="empId" placeholder="Ù…Ø«Ø§Ù„: 1">

      <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)</label>
      <input id="empPin" type="password" inputmode="numeric" placeholder="4 Ø£Ø±Ù‚Ø§Ù…">

      <button class="btn-yellow" onclick="login()">Ø¯Ø®ÙˆÙ„</button>

      <div id="loginMsg" class="msg"></div>
    </div>

    <div id="dash">

      <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>

      <div class="hero">
        <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø©</h1>
        <p>Ù†Ø¸Ø§Ù… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù ÙˆØ¥Ø¯Ø§Ø±Ø© Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
      </div>

      <div class="grid">
        <div class="card">
          <div class="label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…</div>
          <div id="sToday" class="value">00:00</div>
        </div>

        <div class="card">
          <div class="label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙŠÙˆÙ…</div>
          <div id="sLeft" class="value">00:00</div>
        </div>

        <div class="card">
          <div class="label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
          <div id="sWeek" class="value">00:00</div>
        </div>

        <div class="card">
          <div class="label">Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</div>
          <div id="sLast" class="value">â€”</div>
        </div>
      </div>

      <button class="btn-yellow" onclick="punch('IN')">â¬†ï¸ Ø¨ØµÙ…Ø© Ø¯Ø®ÙˆÙ„</button>
      <button class="btn-yellow" onclick="punch('OUT')">â¬‡ï¸ Ø¨ØµÙ…Ø© Ø®Ø±ÙˆØ¬</button>

      <!-- Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© -->

      <!-- hidden iframe so the page doesn't navigate away -->
      <iframe name="hiddenFrame" style="display:none;"></iframe>

      <form id="leaveForm"
            action="https://script.google.com/macros/s/AKfycbykiqXB3d-qAQuUEw2PUg2_95LoMwa-BdJ6Ote7PiNXXOh4PlfVdOmIZpL8K0BZ4wJr/exec"
            method="POST"
            enctype="multipart/form-data"
            target="hiddenFrame"
            onsubmit="return beforeLeaveSubmit();">

        <!-- hidden fields required by Code.gs -->
        <input type="hidden" name="action" value="requestLeave">
        <input type="hidden" name="id" id="leaveEmpId">

        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</label>
        <select id="leaveType" name="type">
          <option value="Ù…Ø±Ø¶ÙŠØ©">Ù…Ø±Ø¶ÙŠØ©</option>
          <option value="Ø³Ù†ÙˆÙŠØ©">Ø³Ù†ÙˆÙŠØ©</option>
          <option value="Ø¨Ø¯ÙˆÙ† Ø±Ø§ØªØ¨">Ø¨Ø¯ÙˆÙ† Ø±Ø§ØªØ¨</option>
          <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>

        <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input id="leaveFrom" name="fromDate" type="date">

        <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input id="leaveTo" name="toDate" type="date">

        <label>Ù…Ù„Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© (ØµÙˆØ±Ø© Ø£Ùˆ PDF)</label>
        <input id="leaveFile" name="file" type="file" accept="image/*,application/pdf">

        <label>Ø§Ù„Ø³Ø¨Ø¨</label>
        <input id="leaveReason" name="reason" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©">

        <button type="submit" class="btn-yellow">ğŸ“„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</button>
      </form>

      <div id="leaveMsg" class="msg"></div>

      <div id="punchMsg" class="msg"></div>

      <div class="section">
        <h3 style="color:var(--accent);font-weight:900;">Ø¨ØµÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
        <table>
          <thead>
            <tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr>
          </thead>
          <tbody id="todayTable">
            <tr><td colspan="2" style="text-align:center;color:#777">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

<script>
/*** YOUR LINKS ***/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykiqXB3d-qAQuUEw2PUg2_95LoMwa-BdJ6Ote7PiNXXOh4PlfVdOmIZpL8K0BZ4wJr/exec";
const EMP_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?gid=0&single=true&output=csv";
const PUNCH_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?gid=817419268&single=true&output=csv";

/*** GEOFENCE (Kalba Club) ***/
const CLUB_LAT = 25.0599489;
const CLUB_LNG = 56.3467097;
const ALLOWED_RADIUS_M = 300;

/*** HELPERS ***/
const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2,'0');
const ymd = d => d.toISOString().slice(0,10);
const nowHHMM = () => { const d=new Date(); return pad(d.getHours())+':'+pad(d.getMinutes()); };
const timeToSec = hhmm => {
  if (!hhmm) return 0;
  const [h,m]=String(hhmm).split(":").map(Number);
  return h*3600+m*60;
};
const secToHHMM = sec => {
  sec=Math.max(0,Math.floor(sec));
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60);
  return pad(h)+':'+pad(m);
};

/*** Expected hours (optional display) ***/
const EXPECTED_DAY_SEC = 7*3600;

window.currentID = null;

/*** HAVERSINE DISTANCE (meters) ***/
function distanceMeters(lat1,lng1,lat2,lng2){
  const R = 6371000; // earth meters
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function insideClub(lat,lng){
  const d = distanceMeters(lat,lng,CLUB_LAT,CLUB_LNG);
  return { ok: d <= ALLOWED_RADIUS_M, dist: d };
}

/*** LOGIN (CSV VALIDATE) ***/
async function login(){
  const id = ($("empId").value||"").trim();
  const pin = ($("empPin").value||"").trim();
  const msg = $("loginMsg");
  msg.style.display="none";

  if(!id || !pin){
    msg.className="msg err"; msg.style.display="block";
    msg.textContent="âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
    return;
  }

  const csv = await (await fetch(EMP_CSV)).text();
  const rows = csv.trim().split("\n").map(r=>r.split(","));
  const found = rows.find(r => String(r[0]).trim()==id && String(r[2]).trim()==pin);

  if(!found){
    msg.className="msg err"; msg.style.display="block";
    msg.textContent="âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    return;
  }

  window.currentID = id;

  $("loginBox").style.display="none";
  $("dash").style.display="block";

  refreshAll();
}

/*** LOGOUT ***/
function logout(){
  window.currentID = null;
  $("dash").style.display="none";
  $("loginBox").style.display="block";
  $("empId").value="";
  $("empPin").value="";
}

/*** READ TODAY PUNCHES FROM CSV ***/
async function getTodayRows(){
  const csv = await (await fetch(PUNCH_CSV)).text();
  const rows = csv.trim().split("\n").map(r=>r.split(","));
  const today = ymd(new Date());

  // rows: ID | Name | Date | Type | Time | Lat | Lng | Zone | Dist | Maps
  const mineToday = rows.filter(r =>
    String(r[0]).trim()==window.currentID &&
    String(r[2]).trim()==today
  );

  // sort by time
  mineToday.sort((a,b)=>timeToSec((a[4]||"").slice(0,5)) - timeToSec((b[4]||"").slice(0,5)));
  return mineToday;
}

/*** VALIDATE SEQUENCE (no double IN/OUT) ***/
function canPunch(type, todayRows){
  if(todayRows.length === 0){
    if(type === "OUT") return { ok:false, error:"âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„." };
    return { ok:true };
  }
  const lastType = String(todayRows[todayRows.length-1][3]).trim(); // IN/OUT
  if(lastType === type){
    return { ok:false, error:`âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ ${type==="IN"?"Ø¯Ø®ÙˆÙ„":"Ø®Ø±ÙˆØ¬"} Ù…Ø±ØªÙŠÙ† Ù…ØªØªØ§Ù„ÙŠØªÙŠÙ†.` };
  }
  // also block OUT if last was OUT already handled above
  return { ok:true };
}

/*** PUNCH WITH GEO + SEQUENCE RULES ***/
async function punch(type){
  if(!window.currentID) return;
  const msg = $("punchMsg");
  msg.style.display="none";

  // 1) check sequence from CSV first
  const todayRows = await getTodayRows();
  const seq = canPunch(type, todayRows);
  if(!seq.ok){
    msg.className="msg err"; msg.style.display="block";
    msg.textContent = seq.error;
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    const geo = insideClub(lat,lng);
    if(!geo.ok){
      msg.className="msg err"; msg.style.display="block";
      msg.textContent = "âŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø§Ø¯ÙŠ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø©.";
      return;
    }

    const mapsLink = `https://maps.google.com/?q=${lat},${lng}`;

    fetch(SCRIPT_URL,{
      method:"POST",
      mode:"no-cors",
      body:JSON.stringify({
        action:"punch",
        payload:{
          id:window.currentID,
          type,
          lat, lng,
          zone:"Kalba Club",
          dist: Math.round(geo.dist),
          mapsLink
        }
      })
    });

    msg.className="msg ok"; msg.style.display="block";
    msg.textContent = `âœ” ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${type==="IN"?"Ø¯Ø®ÙˆÙ„":"Ø®Ø±ÙˆØ¬"} Ø¨Ù†Ø¬Ø§Ø­`;

    setTimeout(refreshAll, 900);
  },
  _=>{
    msg.className="msg err"; msg.style.display="block";
    msg.textContent="âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
  }, {enableHighAccuracy:true, timeout:10000});
}

async function refreshAll(){
  const todayRows = await getTodayRows();

  const table = $("todayTable");
  if(!todayRows.length){
    table.innerHTML = `<tr><td colspan="2" style="text-align:center;color:#777">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</td></tr>`;
  } else {
    table.innerHTML = todayRows.map(r=>{
      const t = (r[4]||"").slice(0,5);
      const type = (r[3]||"").trim()==="IN" ? "Ø¯Ø®ÙˆÙ„" : "Ø®Ø±ÙˆØ¬";
      return `<tr><td>${t}</td><td>${type}</td></tr>`;
    }).join("");
  }

  let workedToday = 0;
  let lastIn = null;
  todayRows.forEach(r=>{
    const type = (r[3]||"").trim();
    const t = (r[4]||"").slice(0,5);
    if(type==="IN") lastIn=t;
    if(type==="OUT" && lastIn){
      workedToday += Math.max(0, timeToSec(t)-timeToSec(lastIn));
      lastIn=null;
    }
  });
  if(lastIn){
    workedToday += Math.max(0, timeToSec(nowHHMM())-timeToSec(lastIn));
  }

  $("sToday").textContent = secToHHMM(workedToday);
  $("sLeft").textContent  = secToHHMM(Math.max(0, EXPECTED_DAY_SEC-workedToday));

  const csv = await (await fetch(PUNCH_CSV)).text();
  const rows = csv.trim().split("\n").map(r=>r.split(","));
  const mine = rows.filter(r=>String(r[0]).trim()==window.currentID);

  const now = new Date();
  const weekStart = new Date(now);
  weekStart.setDate(now.getDate() - now.getDay());
  const weekStartStr = ymd(weekStart);

  const byDate = {};
  mine.forEach(r=>{
    const d = String(r[2]).trim();
    if(!byDate[d]) byDate[d]=[];
    byDate[d].push(r);
  });

  let weekWorked=0;
  Object.keys(byDate).forEach(d=>{
    if(d < weekStartStr) return;
    const dayRows = byDate[d].sort((a,b)=>timeToSec((a[4]||"").slice(0,5)) - timeToSec((b[4]||"").slice(0,5)));
    let dayWorked=0,inT=null;
    dayRows.forEach(r=>{
      const type=(r[3]||"").trim();
      const t=(r[4]||"").slice(0,5);
      if(type==="IN") inT=t;
      if(type==="OUT" && inT){
        dayWorked += Math.max(0, timeToSec(t)-timeToSec(inT));
        inT=null;
      }
    });
    weekWorked += dayWorked;
  });
  $("sWeek").textContent = secToHHMM(weekWorked);

  if(mine.length){
    const last = mine
      .filter(r=>r[4])
      .sort((a,b)=>(a[2]+a[4]).localeCompare(b[2]+b[4]))[mine.length-1];
    const lastType = (last[3]||"").trim()==="IN" ? "Ø¯Ø®ÙˆÙ„" : "Ø®Ø±ÙˆØ¬";
    $("sLast").textContent = `${lastType} ${(last[4]||"").slice(0,5)}`;
  } else {
    $("sLast").textContent="â€”";
  }
}

function beforeLeaveSubmit() {
  const msg  = $("leaveMsg");
  const from = $("leaveFrom").value;
  const to   = $("leaveTo").value;

  msg.style.display = "none";

  // must be logged in
  if (!window.currentID) {
    alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    return false; // cancel form submit
  }

  // basic validation
  if (!from || !to) {
    msg.className = "msg err";
    msg.style.display = "block";
    msg.textContent = "âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©";
    return false; // cancel form submit
  }

  // put employee ID into hidden field so Code.gs can read e.parameter.id
  $("leaveEmpId").value = window.currentID;

  msg.className = "msg ok";
  msg.style.display = "block";
  msg.textContent = "âœ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©";

  return true;
}

</script>
</body>
</html>
