<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>الموظف | نظام البصمة</title>

  <style>
    body { background:#0b0b0b; color:#fff; font-family:Tajawal; padding:20px; }
    .card { background:#111; padding:20px; border-radius:14px; margin-bottom:20px; }
    input, button {
      width:100%; padding:12px; border-radius:12px;
      border:1px solid #333; background:#0f0f0f; color:#fff;
    }
    button { background:#f6c21a; color:#000; font-weight:bold; cursor:pointer; }
    button:hover { background:#ffda41; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:10px; border-bottom:1px solid #222; text-align:center; }
    .ok { color:#14b86a; } .err { color:#ef4444; }
  </style>
</head>
<body>

<div class="card">
  <h2>تسجيل الدخول</h2>
  <input id="empId" placeholder="الرقم الوظيفي">
  <input id="empPin" type="password" placeholder="PIN">
  <button onclick="login()">دخول</button>
  <p id="loginMsg"></p>
</div>

<div id="dash" style="display:none">

  <div class="card">
    <h2>لوحة الموظف</h2>
    <p><b>الاسم:</b> <span id="empName">—</span></p>
    <p><b>الرقم:</b> <span id="empIDText">—</span></p>

    <button onclick="punch('IN')">⬆️ بصمة دخول</button>
    <button onclick="punch('OUT')" style="margin-top:10px;background:#222;color:#fff">⬇️ بصمة خروج</button>

    <p id="punchMsg"></p>
  </div>

  <div class="card">
    <h2>بصمات اليوم</h2>
    <table>
      <thead>
        <tr><th>الوقت</th><th>النوع</th></tr>
      </thead>
      <tbody id="todayTable">
        <tr><td colspan="2">—</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
/*** URLs injected from your data ***/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzICdi_PWthlxiaZ7EA8NqZiUxUUK7XPgZNtyoTUO_ugPAZX-q9cTJ3LaIDEudlXPV0/exec";
const EMP_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?output=csv";
const PUNCH_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?gid=817419268&single=true&output=csv";

/*** LOGIN (NO CORS) ***/
async function login(){
  let id = document.getElementById("empId").value.trim();
  let pin = document.getElementById("empPin").value.trim();
  let msg = document.getElementById("loginMsg");

  if(!id || !pin){
    msg.textContent = "❌ يرجى إدخال البيانات";
    return;
  }

  // 1) Send login request to Apps Script (we won't get response)
  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      action: "login",
      payload: { id, pin }
    })
  });

  // 2) Validate using Employees CSV
  fetch(EMP_CSV)
    .then(res => res.text())
    .then(csv=>{
      let rows = csv.split("\n").map(r=>r.split(","));
      let found = rows.find(r => r[0] == id && r[2] == pin);

      if(found){
        msg.textContent = "✔ تم تسجيل الدخول";

        document.getElementById("dash").style.display = "block";

        document.getElementById("empName").textContent = found[1];
        document.getElementById("empIDText").textContent = id;

        window.currentID = id;
        window.currentName = found[1];

        loadToday();
      } else {
        msg.textContent = "❌ البيانات غير صحيحة";
      }
    });
}

/*** PUNCH (NO CORS) ***/
async function punch(type){
  if(!window.currentID) return;

  navigator.geolocation.getCurrentPosition(pos=>{
    let lat = pos.coords.latitude;
    let lng = pos.coords.longitude;
    let maps = `https://maps.google.com/?q=${lat},${lng}`;

    fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({
        action: "punch",
        payload: {
          id: window.currentID,
          type,
          lat, lng,
          zone: "Kalba Club",
          dist: "",
          mapsLink: maps
        }
      })
    });

    document.getElementById("punchMsg").textContent =
      "✔ تم تسجيل " + (type=="IN" ? "دخول" : "خروج");

    setTimeout(()=>loadToday(), 800);
  },
  _=>{
    document.getElementById("punchMsg").textContent = "❌ لم يتم السماح بالموقع";
  });
}

/*** LOAD TODAY'S PUNCHES FROM CSV ***/
function loadToday(){
  fetch(PUNCH_CSV)
    .then(res=>res.text())
    .then(csv=>{
      let rows = csv.split("\n").map(r=>r.split(","));
      let today = new Date().toISOString().slice(0,10);
      let filtered = rows.filter(r=>r[0]==window.currentID && r[2]==today);

      let html = "";
      filtered.forEach(r=>{
        html += `<tr><td>${r[4]}</td><td>${r[3]=="IN"?"دخول":"خروج"}</td></tr>`;
      });

      document.getElementById("todayTable").innerHTML =
        html || '<tr><td colspan="2">لا يوجد سجلات.</td></tr>';
    });
}
</script>

</body>
</html>
