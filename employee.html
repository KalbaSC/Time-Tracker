 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>نظام البصمة - نادي كلباء | الموظف</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#f6c21a">

  <style>
    :root {
      --bg: #0a0a0a;
      --card: #121212;
      --accent: #f6c21a;
      --accent-soft: #ffd24a;
      --text: #f5f5f5;
      --muted: #b7b7b7;
      --line: #202020;
      --ok: #22c55e;
      --bad: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --radius: 18px;
      --radius-lg: 22px;
      --shadow: 0 8px 25px rgba(0,0,0,.45);
      font-family: "Tajawal", sans-serif;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .uae-header {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px 20px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .uae-header .location {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--accent);
      font-weight: 700;
    }
    
    .uae-header .time {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-weight: 500;
    }

    .login-card {
      max-width: 480px;
      margin: 40px auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 22px;
      box-shadow: var(--shadow);
      text-align: center;
    }
    
    .login-card h2 {
      color: var(--accent);
      font-weight: 900;
      margin-bottom: 20px;
      font-size: 22px;
    }
    
    .login-card .uae-info {
      background: rgba(246, 194, 26, 0.1);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(246, 194, 26, 0.3);
      color: var(--accent);
      font-size: 14px;
    }

    label {
      color: var(--muted);
      display: block;
      text-align: right;
      margin-bottom: 6px;
      font-weight: 700;
    }
    
    input, select {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid #2a2a2a;
      background: #0e0e0e;
      color: #fff;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(246, 194, 26, 0.1);
    }

    .btn-yellow {
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      background: var(--accent);
      color: #111;
      font-weight: 900;
      font-size: 17px;
      border: none;
      cursor: pointer;
      transition: .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: var(--shadow);
    }
    
    .btn-yellow:hover {
      background: var(--accent-soft);
      transform: translateY(-2px);
    }
    
    .btn-yellow:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-punch {
      padding: 18px;
      font-size: 18px;
      margin: 10px 0;
    }

    .msg {
      margin-top: 10px;
      font-size: 14px;
      font-weight: 700;
      padding: 12px;
      border-radius: 10px;
      display: none;
    }
    
    .msg.ok {
      display: block;
      background: rgba(34, 197, 94, .12);
      color: var(--ok);
      border: 1px solid rgba(34, 197, 94, .4);
    }
    
    .msg.err {
      display: block;
      background: rgba(239, 68, 68, .12);
      color: var(--bad);
      border: 1px solid rgba(239, 68, 68, .4);
    }
    
    .msg.warning {
      display: block;
      background: rgba(245, 158, 11, .12);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, .4);
    }

    .toast {
      position: fixed;
      top: 20px;
      left: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--radius);
      background: var(--card);
      border-right: 4px solid var(--accent);
      box-shadow: var(--shadow);
      transform: translateY(-150%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .toast.show {
      transform: translateY(0);
    }
    
    .toast.success {
      border-right-color: var(--ok);
    }
    
    .toast.error {
      border-right-color: var(--bad);
    }
    
    .toast.warning {
      border-right-color: var(--warning);
    }

    #dash {
      display: none;
    }

    .logout-btn {
      background: var(--accent);
      color: #111;
      font-weight: 900;
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: var(--shadow);
      transition: .2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .logout-btn:hover {
      background: var(--accent-soft);
      transform: translateY(-2px);
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .hero {
      text-align: center;
      margin: 10px 0 20px;
    }
    
    .hero h1 {
      color: var(--accent);
      font-weight: 900;
      font-size: 28px;
    }
    
    .hero p {
      color: var(--muted);
      font-size: 15px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 15px;
    }
    
    .card {
      background: linear-gradient(180deg, #151515, #0f0f0f);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-3px);
    }
    
    .label {
      color: #d7d7d7;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .value {
      font-size: 28px;
      font-weight: 900;
    }
    
    .card .subtext {
      font-size: 12px;
      color: var(--muted);
      margin-top: 5px;
    }

    .section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-top: 25px;
    }
    
    .section h3 {
      color: var(--accent);
      font-weight: 900;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      padding: 14px;
      border-bottom: 1px solid var(--line);
      text-align: right;
    }
    
    th {
      background: rgba(32, 32, 32, 0.5);
      color: var(--accent);
      font-weight: 700;
    }
    
    tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .punch-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }

    .leave-status {
      background: rgba(59, 130, 246, 0.1);
      border-radius: var(--radius);
      padding: 15px;
      margin: 15px 0;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .leave-status h4 {
      color: var(--info);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .loader {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }
    
    .loader::after {
      content: "";
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--muted);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .location-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 15px;
    }
    
    .location-status.in {
      background: rgba(34, 197, 94, 0.1);
      color: var(--ok);
    }
    
    .location-status.out {
      background: rgba(239, 68, 68, 0.1);
      color: var(--bad);
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .punch-buttons {
        grid-template-columns: 1fr;
      }
      
      .header-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .uae-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      th, td {
        padding: 10px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 15px;
      }
      
      .value {
        font-size: 24px;
      }
    }
    
.leave-dates{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

@media (max-width: 768px){
  .leave-dates{
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .leave-dates input[type="date"]{
    width: 100%;
    min-height: 48px;
    font-size: 15px;
    padding: 12px 12px;
  }
}

.leave-dates{
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 15px;
}

.leave-dates > div{ min-width: 0; }

.leave-dates input[type="date"]{
  width: 100%;
  min-width: 0;
  max-width: 100%;
  -webkit-appearance: none;
}

@media (max-width: 520px){
  .leave-dates{
    grid-template-columns: 1fr;
    gap: 12px;
  }
}
    
  </style>
</head>
<body>
  <div id="toast" class="toast"></div>
  <div class="wrap">
    <div id="uaeHeader" class="uae-header" style="display: none;">
      <div class="location">
        <i class="fas fa-map-marker-alt"></i>
        <span>نادي كلباء - الإمارات العربية المتحدة</span>
      </div>
      <div class="time">
        <i class="fas fa-clock"></i>
        <span id="uaeTime">--:--</span>
      </div>
    </div>

    <div id="loginBox" class="login-card">
      <h2>تسجيل الدخول</h2>
      <div class="uae-info">
        <i class="fas fa-map-marker-alt"></i>
        <span>نادي كلباء - الإمارات العربية المتحدة</span>
        <div style="margin-top: 5px;">
          <i class="fas fa-clock"></i>
          <span id="loginUaeTime">--:--</span>
        </div>
      </div>

      <label><i class="fas fa-id-card"></i> الرقم الوظيفي</label>
      <input id="empId" placeholder="مثال: 1" autocomplete="off">

      <label><i class="fas fa-lock"></i> الرمز السري (PIN)</label>
      <input id="empPin" type="password" inputmode="numeric" placeholder="4 أرقام" maxlength="4" autocomplete="off">

      <button class="btn-yellow" onclick="login()">
        <i class="fas fa-sign-in-alt"></i> دخول
      </button>
      
      <div class="loader" id="loginLoader"></div>
      <div id="loginMsg" class="msg"></div>
    </div>

    <div id="dash">
      <div class="header-bar">
        <div>
          <h1 style="color: var(--accent); margin: 0;">مرحباً <span id="employeeName">...</span></h1>
          <p style="color: var(--muted); margin-top: 5px;">الرقم الوظيفي: <span id="employeeId">...</span></p>
         <p style="color: var(--muted); margin-top: 5px;">القسم: <span id="employeeDept">—</span></p>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> تسجيل خروج
        </button>
      </div>

      <div class="punch-buttons">
        <button class="btn-yellow btn-punch" onclick="punch('IN')" id="punchInBtn" disabled>
          <i class="fas fa-sign-in-alt"></i> بصمة دخول
        </button>
        <button class="btn-yellow btn-punch" onclick="punch('OUT')" id="punchOutBtn" disabled>
          <i class="fas fa-sign-out-alt"></i> بصمة خروج
        </button>
      </div>

            <div id="locationStatus" class="location-status" style="display: none;">
        <i class="fas fa-map-marker-alt"></i>
        <span>جاري التحقق من الموقع...</span>
      </div>

      <div id="punchMsg" class="msg"></div>
      
      <div class="grid">
        <div class="card">
          <div class="label"><i class="fas fa-clock"></i> ساعات العمل اليوم</div>
          <div id="sToday" class="value">00:00</div>
          <div class="subtext" id="todayProgress">0% من الوقت المطلوب</div>
        </div>

        <div class="card">
          <div class="label"><i class="fas fa-hourglass-half"></i> المتبقي اليوم</div>
          <div id="sLeft" class="value">00:00</div>
          <div class="subtext">لإكمال يوم العمل</div>
        </div>

        <div class="card">
          <div class="label"><i class="fas fa-calendar-week"></i> ساعات الأسبوع</div>
          <div id="sWeek" class="value">00:00</div>
          <div class="subtext" id="weekProgress">0 ساعة يومياً</div>
        </div>

        <div class="card">
          <div class="label"><i class="fas fa-history"></i> آخر حركة</div>
          <div id="sLast" class="value">—</div>
          <div class="subtext" id="lastType">—</div>
        </div>
      </div>

      <div class="loader" id="punchLoader"></div>

      <div class="section">
        <h3><i class="fas fa-calendar-plus"></i> طلب إجازة</h3>
        
        <div class="leave-status">
          <h4><i class="fas fa-info-circle"></i> معلومات الإجازة</h4>
          <p style="color: var(--muted); font-size: 14px;">
            يجب تقديم طلب الإجازة قبل 48 ساعة على الأقل من تاريخ بدايتها. سيتم مراجعة الطلب من قبل الإدارة.
          </p>
        </div>

        <form id="leaveForm" onsubmit="return submitLeaveForm(event);">
          <!-- hidden fields -->
          <input type="hidden" name="action" value="requestLeave">
          <input type="hidden" name="id" id="leaveEmpId">

          <label><i class="fas fa-calendar-alt"></i> نوع الإجازة</label>
          <select id="leaveType" name="type">
            <option value="مرضية">مرضية</option>
            <option value="سنوية">سنوية</option>
            <option value="بدون راتب">بدون راتب</option>
            <option value="أخرى">أخرى</option>
          </select>

<div class="leave-dates">
  <div>
    <label><i class="fas fa-calendar-day"></i> من تاريخ</label>
    <input id="leaveFrom" name="fromDate" type="date" min="">
  </div>

  <div>
    <label><i class="fas fa-calendar-day"></i> إلى تاريخ</label>
    <input id="leaveTo" name="toDate" type="date" min="">
  </div>
</div>

          <label><i class="fas fa-paperclip"></i> ملف الإجازة (صورة أو PDF - اختياري)</label>
          <input type="file" id="leaveFile" name="leaveFile" accept=".pdf,.jpg,.jpeg,.png" />

          <label><i class="fas fa-comment-alt"></i> السبب</label>
          <input id="leaveReason" name="reason" placeholder="اكتب سبب الإجازة">

          <button type="submit" class="btn-yellow" id="submitLeaveBtn">
            <i class="fas fa-paper-plane"></i> إرسال طلب الإجازة
          </button>
        </form>
        <div class="loader" id="leaveLoader"></div>
        <div id="leaveMsg" class="msg"></div>

       <hr style="margin:18px 0;border:0;border-top:1px solid var(--line);">

<h4 style="margin-bottom:10px;color:var(--accent);font-weight:900;">
  <i class="fas fa-clipboard-list"></i> طلباتي السابقة وحالتها
</h4>

<div style="overflow-x:auto;">
  <table>
    <thead>
      <tr>
        <th>النوع</th>
        <th>من</th>
        <th>إلى</th>
        <th>الحالة</th>
        <th>سبب الرفض/ملاحظة</th>
      </tr>
    </thead>
    <tbody id="myLeavesTable">
      <tr><td colspan="5" style="text-align:center;color:#777">لا يوجد طلبات.</td></tr>
    </tbody>
  </table>
</div>
 
      </div>

      <div class="section">
        <h3><i class="fas fa-list-alt"></i> بصمات اليوم</h3>
        <table>
          <thead>
            <tr><th>الوقت</th><th>النوع</th><th>الحالة</th></tr>
          </thead>
          <tbody id="todayTable">
            <tr><td colspan="3" style="text-align:center;color:#777">لا يوجد سجلات.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGSjc43X89ZJ2py8GndB-AfRrP38fI0mzHyr9rLLAcW_OZegive8D3u-eCOyroKElj/exec";
const EMP_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?gid=0&single=true&output=csv";
const PUNCH_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?gid=817419268&single=true&output=csv";

const UAE_TIMEZONE = 'Asia/Dubai';

const CLUB_LAT = 25.0599489;
const CLUB_LNG = 56.3467097;
const ALLOWED_RADIUS_M = 300;

let EXPECTED_DAY_SEC = 7 * 3600;
let EXPECTED_WEEK_SEC = 5 * EXPECTED_DAY_SEC;

async function applySettings(){
  const res = await fetchSettings();
  if (res.ok && res.dailyWorkHours) {
    EXPECTED_DAY_SEC = res.dailyWorkHours * 3600;
    EXPECTED_WEEK_SEC = 5 * EXPECTED_DAY_SEC;
  }
}

const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2, '0');

const SESSION_KEY = "kscc_emp_session_v1";

function saveSession_() {
  if (!window.currentID) return;
const data = {
  id: String(window.currentID),
  name: String(window.employeeName || ""),
  dept: String(window.employeeDept || ""),
  savedAt: Date.now()
};
  localStorage.setItem(SESSION_KEY, JSON.stringify(data));
}

function restoreSession_() {
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return false;

    const data = JSON.parse(raw);
    if (!data || !data.id) return false;

    window.currentID = data.id;
    window.employeeName = data.name || "موظف";
    window.employeeDept = data.dept || "";
    const deptEl = $('employeeDept');
    if (deptEl) deptEl.textContent = window.employeeDept || '—';

    $('employeeName').textContent = window.employeeName;
    $('employeeId').textContent = window.currentID;
    $('leaveEmpId').value = window.currentID;

    return true;
  } catch (e) {
    return false;
  }
}

function clearSession_() {
  localStorage.removeItem(SESSION_KEY);
}
  
function getUAETime() {
  const now = new Date();
  return now.toLocaleTimeString('ar-AE', {
    timeZone: UAE_TIMEZONE,
    hour12: true,
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

function getUAEDate() {
  const now = new Date();
  return now.toLocaleDateString('ar-AE', {
    timeZone: UAE_TIMEZONE,
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function updateUAETime() {
  const timeStr = getUAETime();
  const dateStr = getUAEDate();
  
  const uaeTimeElement = $('uaeTime');
  const loginUaeTimeElement = $('loginUaeTime');
  
  if (uaeTimeElement) uaeTimeElement.textContent = `${dateStr} - ${timeStr}`;
  if (loginUaeTimeElement) loginUaeTimeElement.textContent = `${dateStr} - ${timeStr}`;
}

const ymd = d => {
  const date = new Date(d);
  return date.toLocaleDateString('en-CA', { timeZone: UAE_TIMEZONE });
};

const nowHHMM = () => {
  const d = new Date();
  return d.toLocaleTimeString('en-US', {
    timeZone: UAE_TIMEZONE,
    hour12: false,
    hour: '2-digit',
    minute: '2-digit'
  }).replace(/^(\d{1,2}):(\d{2})$/, (match, h, m) => pad(h) + ':' + pad(m));
};

const timeToSec = hhmm => {
  if (!hhmm) return 0;
  const [h, m] = String(hhmm).split(":").map(Number);
  return h * 3600 + m * 60;
};

const secToHHMM = sec => {
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  return pad(h) + ':' + pad(m);
};

function parseCSVText(csvText) {
  const rows = [];
  let row = [];
  let cell = "";
  let inQuotes = false;

  const s = String(csvText || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");

  for (let i = 0; i < s.length; i++) {
    const ch = s[i];

    if (ch === '"') {
      if (inQuotes && s[i + 1] === '"') {
        cell += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (ch === "," && !inQuotes) {
      row.push(cell);
      cell = "";
      continue;
    }

    if (ch === "\n" && !inQuotes) {
      row.push(cell);
      rows.push(row);
      row = [];
      cell = "";
      continue;
    }

    cell += ch;
  }

  row.push(cell);
  rows.push(row);

  return rows.filter(r => r.some(c => String(c || "").trim() !== ""));
}
  
const distanceMeters = (lat1, lng1, lat2, lng2) => {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
};

const insideClub = (lat, lng) => {
  const d = distanceMeters(lat, lng, CLUB_LAT, CLUB_LNG);
  return { ok: d <= ALLOWED_RADIUS_M, dist: d };
};

function resetPunchUI() {
  const msg = $("punchMsg");
  if (msg) {
    msg.className = "msg";
    msg.style.display = "none";
    msg.textContent = "";
  }

  const loc = $("locationStatus");
  if (loc) loc.style.display = "none";

  if ($("sToday")) $("sToday").textContent = "00:00";
  if ($("sLeft")) $("sLeft").textContent = "00:00";
  if ($("sWeek")) $("sWeek").textContent = "00:00";
  if ($("sLast")) $("sLast").textContent = "—";
  if ($("lastType")) $("lastType").textContent = "—";
  if ($("todayProgress")) $("todayProgress").textContent = "0% من الوقت المطلوب";
  if ($("weekProgress")) $("weekProgress").textContent = "0 ساعة يومياً (0%)";

  const table = $("todayTable");
  if (table) table.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#777">لا يوجد سجلات.</td></tr>`;
}
  
function showToast(message, type = 'success', duration = 3000) {
  const toast = $('toast');
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

function showLoader(id) {
  const loader = $(id);
  if (loader) loader.style.display = 'block';
}

function hideLoader(id) {
  const loader = $(id);
  if (loader) loader.style.display = 'none';
}

function getPositionSmart() {
  if (!navigator.geolocation) {
    return Promise.reject({ code: -1, message: "Geolocation not supported" });
  }

  const optHigh = { enableHighAccuracy: true, timeout: 25000, maximumAge: 60000 };
  const optLow  = { enableHighAccuracy: false, timeout: 25000, maximumAge: 300000 };

  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(resolve, err1 => {
      if (err1 && (err1.code === err1.TIMEOUT || err1.code === err1.POSITION_UNAVAILABLE)) {
        navigator.geolocation.getCurrentPosition(resolve, reject, optLow);
      } else {
        reject(err1);
      }
    }, optHigh);
  });
}

function onlyDate(val){
  if (!val) return "—";
  const d = new Date(val);
  if (isNaN(d)) return val;
  return d.toISOString().slice(0, 10);
}
  
function checkLocationStatus() {
  const statusElement = $('locationStatus');
  if (!navigator.geolocation) {
    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>المتصفح لا يدعم خدمات الموقع</span>';
    statusElement.className = 'location-status out';
    statusElement.style.display = 'flex';
    $('punchInBtn').disabled = true;
    $('punchOutBtn').disabled = true;
    return;
  }

  statusElement.innerHTML = '<i class="fas fa-location-arrow"></i> <span>جاري تحديد الموقع...</span>';
  statusElement.className = 'location-status out';
  statusElement.style.display = 'flex';
  $('punchInBtn').disabled = true;
  $('punchOutBtn').disabled = true;

  getPositionSmart()
    .then(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const geo = insideClub(lat, lng);

      if (geo.ok) {
        statusElement.innerHTML = `<i class="fas fa-check-circle"></i> <span>داخل نادي كلباء (${Math.round(geo.dist)}م)</span>`;
        statusElement.className = 'location-status in';
        $('punchInBtn').disabled = false;
        $('punchOutBtn').disabled = false;
      } else {
        statusElement.innerHTML = `<i class="fas fa-times-circle"></i> <span>خارج نادي كلباء (${Math.round(geo.dist)}م)</span>`;
        statusElement.className = 'location-status out';
        $('punchInBtn').disabled = true;
        $('punchOutBtn').disabled = true;
      }

      statusElement.style.display = 'flex';
    })
    .catch(error => {
      let message = 'تعذر تحديد الموقع';
      if (error && typeof error.code !== "undefined") {
        switch (error.code) {
          case error.PERMISSION_DENIED:     message = 'تم رفض إذن الموقع'; break;
          case error.POSITION_UNAVAILABLE: message = 'معلومات الموقع غير متوفرة'; break;
          case error.TIMEOUT:              message = 'انتهت مهلة طلب الموقع'; break;
        }
      }
      statusElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>${message}</span>`;
      statusElement.className = 'location-status out';
      statusElement.style.display = 'flex';
      $('punchInBtn').disabled = true;
      $('punchOutBtn').disabled = true;
    });
}

let lastYMD_ = null;

async function handleDayRollover_() {
  if (!window.currentID) return;

  const today = ymd(new Date());
  if (lastYMD_ === null) lastYMD_ = today;

  if (today !== lastYMD_) {
    lastYMD_ = today;

    resetPunchUI();
    await refreshAll();
    checkLocationStatus();
    loadMyLeaves();
  }
}  

async function changeMyPin(){
  if (!window.currentID) return;

  const oldPin = prompt("أدخل الـرمز الحالي:");
  if (!oldPin) return;

  const newPin = prompt("أدخل رمز سري جديد (4 أرقام):");
  if (!newPin) return;

  if (!/^\d{4}$/.test(newPin)) {
    showToast("الرمز السري يجب ان يكون 4 أرقام", "warning");
    return;
  }

  try {
    showToast("⏳ جاري تغيير الرمز السري...", "info");

    const url =
      `${SCRIPT_URL}?action=changePassword` +
      `&id=${encodeURIComponent(window.currentID)}` +
      `&oldPassword=${encodeURIComponent(oldPin)}` +
      `&newPassword=${encodeURIComponent(newPin)}` +
      `&_=${Date.now()}`;

    const res = await jsonp(url);
    if (!res || !res.ok) throw new Error(res?.error || "فشل تغيير الرمز");

    const pinInput = document.getElementById("pin");
    if (pinInput) pinInput.value = "";

    showToast("✅ تم تغيير الرمز بنجاح", "success");
    forceLogoutAfterPinChange(
      "✅ تم تغيير الرمز بنجاح. الرجاء تسجيل الدخول مرة أخرى باستخدام الرمز الجديد."
    );
  } catch(e) {
    showToast("❌ " + e.message, "error");
  }
}

function forceLogoutAfterPinChange(message) {
  localStorage.removeItem("employeeSession");

  window.currentID = "";
  window.employeeName = "";
  window.employeeDept = "";
  window.employeePin = "";

  const msg = document.getElementById("loginMsg");
  if (msg) {
    msg.className = "msg ok";
    msg.style.display = "block";
    msg.textContent = message || "تم تغيير الرمز السري. الرجاء تسجيل الدخول مرة أخرى.";
  }

  const loginBox = document.getElementById("loginBox");
  const dash = document.getElementById("dash");
  const header = document.getElementById("uaeHeader");

  if (dash) dash.style.display = "none";
  if (header) header.style.display = "none";
  if (loginBox) loginBox.style.display = "block";
 setTimeout(() => {
  const pin = document.getElementById("pin");
  if (pin) pin.focus();
}, 200);
}
  
async function openPinChangeModal(){
  const oldPin = prompt("أدخل الرمز الحالي:");
  if (!oldPin) return;

  const newPin = prompt("أدخل رمز سري جديد (4 أرقام):");
  if (!newPin) return;

  if (!/^\d{4}$/.test(newPin)) {
    showToast("الرمز السري يجب ان يكون 4 أرقام", "warning");
    return;
  }

  try {
    showToast("⏳ جاري تغيير الرمز السري...", "info");

    const url =
      `${SCRIPT_URL}?action=changePassword` +
      `&id=${encodeURIComponent(window.currentID)}` +
      `&oldPassword=${encodeURIComponent(oldPin)}` +
      `&newPassword=${encodeURIComponent(newPin)}` +
      `&_=${Date.now()}`;

    const res = await jsonp(url);
    if (!res || !res.ok) {
      showToast(res?.error || "فشل تغيير الرمز السري", "error");
      return;
    }

    const pinInput = document.getElementById("pin");
    if (pinInput) pinInput.value = "";

    showToast("✅ تم تغيير الرمز بنجاح", "success");
    forceLogoutAfterPinChange(
      "✅ تم تغيير الرمز بنجاح. الرجاء تسجيل الدخول مرة أخرى باستخدام الرمز الجديد."
    );
  } catch (e) {
    showToast("❌ " + e.message, "error");
  }
}
  
async function login() {
  const id = ($("empId").value || "").trim();
  const pin = ($("empPin").value || "").trim();
  const msg = $("loginMsg");
  msg.style.display = "none";
  msg.textContent = "";

  showLoader('loginLoader');

  if (!id || !pin) {
    hideLoader('loginLoader');
    msg.className = "msg err";
    msg.style.display = "block";
    msg.textContent = "❌ يرجى إدخال البيانات";
    showToast('يرجى إدخال البيانات', 'error');
    return;
  }

  if (!/^\d{4}$/.test(pin)) {
    hideLoader('loginLoader');
    msg.className = "msg err";
    msg.style.display = "block";
    msg.textContent = "❌ الرمز السري يجب أن يكون 4 أرقام";
    showToast('الرمز السري يجب أن يكون 4 أرقام', 'error');
    return;
  }

  try {
    const url = `${SCRIPT_URL}?action=loginEmployee&id=${encodeURIComponent(id)}&pin=${encodeURIComponent(pin)}`;
    const data = await jsonp(url);

    if (!data || !data.ok) {
      msg.className = "msg err";
      msg.style.display = "block";
      msg.textContent = "❌ البيانات غير صحيحة";
      showToast(data?.error || 'بيانات الدخول غير صحيحة', 'error');
      return;
    }

    window.currentID = id;
    window.employeeName = (data.name || 'موظف').trim();
    window.employeePin = pin;
    window.employeeDept = (data.department || '').trim();
    saveSession_();

   if (!data.lastPinChange) {
    hideLoader('loginLoader');
    showToast('أول تسجيل دخول: يجب تغير كلمة المرور', 'warning');
    openPinChangeModal();
    return;
   }
    $('employeeName').textContent = window.employeeName;
    $('employeeId').textContent = id;
    $('leaveEmpId').value = id;

    const deptEl = $('employeeDept');
    if (deptEl) deptEl.textContent = window.employeeDept || '—';

    $("loginBox").style.display = "none";
    $("dash").style.display = "block";
    $("uaeHeader").style.display = "flex";

    showToast(`مرحباً ${window.employeeName}`, 'success');
    resetPunchUI();
    await refreshAll();
    checkLocationStatus();
    loadMyLeaves();

    const today = ymd(new Date());
    const leaveFrom = $('#leaveFrom');
    const leaveTo = $('#leaveTo');
    if (leaveFrom) leaveFrom.min = today;
    if (leaveTo) leaveTo.min = today;

  } catch (error) {
    console.error('Login error:', error);
    showToast('خطأ في الاتصال بالخادم', 'error');
  } finally {
    hideLoader('loginLoader');
  }
}

function logout() {
  if (confirm("هل تريد تسجيل الخروج؟")) {
    resetPunchUI();
    window.currentID = null;
    window.employeeName = null;
    $("dash").style.display = "none";
    clearSession_();
    $("loginBox").style.display = "block";
    $("uaeHeader").style.display = "none";
    $("empId").value = "";
    $("empPin").value = "";
    $("locationStatus").style.display = "none";
    showToast('تم تسجيل الخروج', 'success');
  }
}

async function getTodayRows() {
  const url = PUNCH_CSV + (PUNCH_CSV.includes("?") ? "&" : "?") + "_=" + Date.now();
  const csv = await (await fetch(url, { cache: "no-store" })).text();
  const rows = parseCSVText(csv);

  const today = ymd(new Date());

  return rows
    .filter(r =>
      String(r[1]).trim() === String(window.currentID) &&
      String(r[0]).trim() === today
    )
    .sort((a, b) => timeToSec((a[4] || "").slice(0, 5)) - timeToSec((b[4] || "").slice(0, 5)));
}

function canPunch(type, todayRows) {
  if (todayRows.length === 0) {
    if (type === "OUT") return { ok: false, error: "❌ لا يمكن تسجيل خروج قبل تسجيل دخول." };
    return { ok: true };
  }
  
  const lastType = String(todayRows[todayRows.length - 1][3]).trim();
  if (lastType === type) {
    return { ok: false, error: `❌ لا يمكن تسجيل ${type === "IN" ? "دخول" : "خروج"} مرتين متتاليتين.` };
  }
  
  return { ok: true };
}

async function punch(type) {
  if (!window.currentID) {
    showToast('يرجى تسجيل الدخول أولاً', 'error');
    return;
  }

  const msg = $("punchMsg");
  msg.style.display = "none";
  showLoader('punchLoader');

  try {
    const todayRows = await getTodayRows();
    const seq = canPunch(type, todayRows);

    if (!seq.ok) {
      hideLoader('punchLoader');
      msg.className = "msg err";
      msg.style.display = "block";
      msg.textContent = seq.error;
      showToast(seq.error, 'error');
      return;
    }

    const pos = await getPositionSmart();
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    const geo = insideClub(lat, lng);
    if (!geo.ok) {
      hideLoader('punchLoader');
      msg.className = "msg err";
      msg.style.display = "block";
      msg.textContent = "❌ يجب أن تكون داخل موقع النادي لإتمام البصمة.";
      showToast('يجب أن تكون داخل النادي', 'error');
      checkLocationStatus();
      return;
    }

    const mapsLink = `https://maps.google.com/?q=${lat},${lng}`;
    const beforeCount = todayRows.length;

    await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({
        action: "punch",
        payload: {
          id: window.currentID,
          name: window.employeeName,
          type,
          lat,
          lng,
          zone: "داخل نادي كلباء",
          dist: Math.round(geo.dist),
          mapsLink
        }
      })
    });

let afterRows = [];
let confirmed = false;

for (let i = 0; i < 4; i++) {
  await new Promise(r => setTimeout(r, 900));
  afterRows = await getTodayRows();
  if (afterRows.length > beforeCount) {
    confirmed = true;
    break;
  }
}

if (!confirmed) {
  hideLoader('punchLoader');

  msg.className = "msg warn";
  msg.style.display = "block";
  msg.textContent = "ℹ️ تم تسجيل البصمة بنجاح، وجاري تحديث البيانات.";

  showToast("ℹ️ تم تسجيل البصمة بنجاح", "info");

  await refreshAll();
  return;
}
    hideLoader('punchLoader');

    msg.className = "msg ok";
    msg.style.display = "block";
    msg.textContent = `✔ تم تسجيل ${type === "IN" ? "الدخول" : "الخروج"} بنجاح`;
    showToast('تم تسجيل البصمة بنجاح', 'success');
setTimeout(() => {
  msg.style.display = "none";
}, 4000);
    await refreshAll();
    checkLocationStatus();

  } catch (err) {
    console.error(err);
    hideLoader('punchLoader');
    msg.className = "msg err";
    msg.style.display = "block";
    msg.textContent = "❌ فشل تحديد الموقع";
    showToast('فشل تحديد الموقع', 'error');
    checkLocationStatus();
  }
}

async function fetchSettings(){
  const data = await jsonp(SCRIPT_URL + "?action=getSettings");
  return data; 
}
 
 function applyWorkHoursSettings_(){
  try{
    const h = Number(window.dailyWorkHours || 7);
    window.EXPECTED_DAY_SEC = Math.round(h * 3600);
    window.EXPECTED_WEEK_SEC = 5 * window.EXPECTED_DAY_SEC;
  }catch(e){
    window.EXPECTED_DAY_SEC = 7 * 3600;
    window.EXPECTED_WEEK_SEC = 5 * window.EXPECTED_DAY_SEC;
  }
}

async function refreshAll() {
  if (!window.currentID) return;
  applyWorkHoursSettings_();
  try {
    const todayRows = await getTodayRows();

    const table = $("todayTable");
    if (!todayRows.length) {
      table.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#777">لا يوجد سجلات.</td></tr>`;
    } else {
      table.innerHTML = todayRows.map(r => {
        const t = (r[4] || "").slice(0, 5);
        const type = (r[3] || "").trim() === "IN" ? "دخول" : "خروج";
        const status = (r[7] || "").includes("داخل") ? "✅ داخل" : "❌ خارج";
        return `<tr><td>${t}</td><td>${type}</td><td>${status}</td></tr>`;
      }).join("");
    }

    let workedToday = 0;
    let lastIn = null;
    
    todayRows.forEach(r => {
      const type = (r[3] || "").trim();
      const t = (r[4] || "").slice(0, 5);
      
      if (type === "IN") {
        lastIn = t;
      }
      
      if (type === "OUT" && lastIn) {
        workedToday += Math.max(0, timeToSec(t) - timeToSec(lastIn));
        lastIn = null;
      }
    });
    
    if (lastIn) {
      workedToday += Math.max(0, timeToSec(nowHHMM()) - timeToSec(lastIn));
    }

    $("sToday").textContent = secToHHMM(workedToday);
    
    const leftToday = Math.max(0, EXPECTED_DAY_SEC - workedToday);
    $("sLeft").textContent = secToHHMM(leftToday);
    
    const todayPercent = Math.min(100, Math.round((workedToday / EXPECTED_DAY_SEC) * 100));
    $("todayProgress").textContent = `${todayPercent}% من الوقت المطلوب`;

const csv = await (await fetch(PUNCH_CSV)).text();
const rows = parseCSVText(csv);
const mine = rows.filter(r => String(r[1]).trim() == window.currentID);

const nowUAE = new Date(new Date().toLocaleString('en-US', { timeZone: UAE_TIMEZONE }));
const weekStart = new Date(nowUAE);
weekStart.setDate(nowUAE.getDate() - nowUAE.getDay());
const weekStartStr = ymd(weekStart);

const todayStr = ymd(nowUAE);
const nowSec = timeToSec(nowHHMM()); 


    const byDate = {};
    mine.forEach(r => {
      const d = String(r[0]).trim();
      if (!byDate[d]) byDate[d] = [];
      byDate[d].push(r);
    });

    let weekWorked = 0;
    Object.keys(byDate).forEach(d => {
      if (d < weekStartStr) return;
      
      const dayRows = byDate[d].sort((a, b) => timeToSec((a[4] || "").slice(0, 5)) - timeToSec((b[4] || "").slice(0, 5)));
      let dayWorked = 0;
      let inT = null;
      
      dayRows.forEach(r => {
        const type = (r[3] || "").trim();
        const t = (r[4] || "").slice(0, 5);
        
        if (type === "IN") inT = t;
        if (type === "OUT" && inT) {
          dayWorked += Math.max(0, timeToSec(t) - timeToSec(inT));
          inT = null;
        }
      });
      if (inT && d === todayStr) {
  dayWorked += Math.max(0, nowSec - timeToSec(inT));
  inT = null;
}
      weekWorked += dayWorked;
    });

    $("sWeek").textContent = secToHHMM(weekWorked);
    
    const weekPercent = Math.min(100, Math.round((weekWorked / EXPECTED_WEEK_SEC) * 100));
    const avgPerDay = weekWorked / 5;
    $("weekProgress").textContent = `${Math.round(avgPerDay / 3600)} ساعة يومياً (${weekPercent}%)`;

    if (mine.length) {
const mineWithTime = mine.filter(r => r[0] && r[4]);
const last = mineWithTime
  .sort((a, b) => (String(a[0]).trim() + " " + String(a[4]).trim()).localeCompare(String(b[0]).trim() + " " + String(b[4]).trim()))
  [mineWithTime.length - 1];
      
      const lastType = (last[3] || "").trim() === "IN" ? "دخول" : "خروج";
      const lastTime = (last[4] || "").slice(0, 5);
      
      $("sLast").textContent = lastTime;
      $("lastType").textContent = lastType;
    } else {
      $("sLast").textContent = "—";
      $("lastType").textContent = "—";
    }

  } catch (error) {
    console.error('Refresh error:', error);
    showToast('خطأ في تحديث البيانات', 'error');
  }
}
 
async function submitLeaveForm(event) {
  event.preventDefault();

  const form = event.target;

  if (!window.currentID) {
    showToast('يرجى تسجيل الدخول أولاً', 'error');
    return false;
  }

  const fromInput = form.querySelector('#leaveFrom');
  const toInput   = form.querySelector('#leaveTo');
  const typeInput = form.querySelector('#leaveType');
  const reasonInp = form.querySelector('#leaveReason');
  const fileInput = form.querySelector('#leaveFile');

  const from = fromInput ? fromInput.value : '';
  const to   = toInput ? toInput.value : '';

  if (!from || !to) {
    showToast('يرجى اختيار تاريخ البداية والنهاية', 'error');
    return false;
  }

  if (new Date(to) < new Date(from)) {
    showToast('تاريخ النهاية يجب أن يكون بعد تاريخ البداية', 'error');
    return false;
  }

  const now = new Date();
  const fromDate = new Date(from);
  const hoursDiff = (fromDate - now) / (1000 * 60 * 60);
  if (hoursDiff < 48) {
    if (!confirm("warning: يجب تقديم طلب الإجازة قبل 48 ساعة على الأقل. هل تريد المتابعة؟")) {
      return false;
    }
  }

  const submitBtn  = form.querySelector('#submitLeaveBtn');
  const leaveLoader = $('#leaveLoader');
  const leaveMsg    = $('#leaveMsg');

  if (submitBtn) submitBtn.disabled = true;
  if (leaveLoader) leaveLoader.style.display = 'block';
  if (leaveMsg) {
    leaveMsg.style.display = 'none';
    leaveMsg.className = 'msg';
  }

  try {
    const payload = {
      id: String(window.currentID),
      type: typeInput ? (typeInput.value || '') : '',
      fromDate: from,
      toDate: to,
      reason: reasonInp ? (reasonInp.value || '') : ''
    };

    const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

    if (file) {
      const base64 = await readFileAsBase64_(file);
      payload.fileData = base64;
      payload.fileName = file.name || ("leave_" + payload.id + "_" + Date.now());
      payload.fileType = file.type || "application/octet-stream";
    }

    const body = JSON.stringify({
      action: "requestLeave",
      payload
    });
await fetch(SCRIPT_URL, {
  method: "POST",
  mode: "no-cors",
  body: body
});

    showToast('تم إرسال طلب الإجازة بنجاح ✅', 'success');

    if (leaveMsg) {
      leaveMsg.className = 'msg ok';
      leaveMsg.style.display = 'block';
      leaveMsg.textContent = '✔ تم إرسال طلب الإجازة بنجاح';
    }

    form.reset();

    const today = ymd(new Date());
    const fromElement = $('#leaveFrom');
    const toElement = $('#leaveTo');
    if (fromElement) fromElement.min = today;
    if (toElement) toElement.min = today;

    loadMyLeaves();
setTimeout(loadMyLeaves, 2000);

  } catch (error) {
    console.error('Form submission error:', error);
    showToast('خطأ في الاتصال بالخادم', 'error');

    if (leaveMsg) {
      leaveMsg.className = 'msg err';
      leaveMsg.style.display = 'block';
      leaveMsg.textContent = '❌ خطأ في الاتصال بالخادم';
    }

  } finally {
    if (leaveLoader) leaveLoader.style.display = 'none';
    if (submitBtn) submitBtn.disabled = false;
  }

  return false;
}

function statusBadgeHtml_(statusRaw, note){
  const s = String(statusRaw || "Pending").toLowerCase();
  let bg = "rgba(245,158,11,.12)", color = "#f59e0b", label = "قيد الانتظار";
  if (s === "approved") { bg = "rgba(34,197,94,.12)"; color = "#22c55e"; label = "مقبولة"; }
  if (s === "rejected") { bg = "rgba(239,68,68,.12)"; color = "#ef4444"; label = "مرفوضة"; }
  return `<span style="padding:4px 10px;border-radius:999px;background:${bg};color:${color};font-weight:800;font-size:12px;">${label}</span>`;
}

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*99999);
    window[cb] = (data) => { resolve(data); cleanup(); };

    const s = document.createElement("script");
    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    s.onerror = () => { reject(new Error("JSONP failed")); cleanup(); };

    function cleanup(){
      delete window[cb];
      if (s.parentNode) s.parentNode.removeChild(s);
    }
    document.body.appendChild(s);
  });
}
  
async function loadMyLeaves(){
  if (!window.currentID) return;

  const tbody = document.getElementById("myLeavesTable");
  if (!tbody) return;

  tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777">جاري التحميل...</td></tr>`;

  try{
    const url = `${SCRIPT_URL}?action=getLeavesByEmployee&id=${encodeURIComponent(window.currentID)}`;
    const data = await jsonp(url);

    if (!data.ok) throw new Error(data.error || "Server error");

    const leaves = data.leaves || [];
    if (!leaves.length){
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777">لا يوجد طلبات.</td></tr>`;
      return;
    }

    leaves.sort((a,b) => String(b.createdAt||"").localeCompare(String(a.createdAt||"")));

    tbody.innerHTML = leaves.map(lv => {
      const badge = statusBadgeHtml_(lv.status);
      const note = lv.note ? String(lv.note) : "—";
      return `
        <tr>
          <td>${lv.type || "—"}</td>
          <td>${onlyDate(lv.fromDate)}</td>
          <td>${onlyDate(lv.toDate)}</td>
          <td>${badge}</td>
          <td>${note}</td>
        </tr>
      `;
    }).join("");

  } catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777">تعذر تحميل الطلبات.</td></tr>`;
  }
}

function readFileAsBase64_(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = () => {
      const result = String(reader.result || "");
      const base64 = result.includes(",") ? result.split(",")[1] : result;
      resolve(base64);
    };

    reader.onerror = () => reject(reader.error || new Error("File read failed"));
    reader.readAsDataURL(file);
  });
}
  
function initialize() {
  updateUAETime();
  setInterval(updateUAETime, 1000);

  const restored = restoreSession_();

  const today = ymd(new Date());
  const leaveFrom = $("leaveFrom");
  const leaveTo   = $("leaveTo");
  if (leaveFrom) leaveFrom.min = today;
  if (leaveTo)   leaveTo.min = today;

  lastYMD_ = ymd(new Date());
  setInterval(handleDayRollover_, 10000);

  if (window.currentID) {
    $("loginBox").style.display = "none";
    $("dash").style.display = "block";
    $("uaeHeader").style.display = "flex";

    resetPunchUI();
    refreshAll();
    checkLocationStatus();
    loadMyLeaves();

    setInterval(checkLocationStatus, 30000);
    setInterval(() => {
      if (window.currentID) refreshAll();
    }, 60000);

    setInterval(loadMyLeaves, 30000);
  } else {
    $("dash").style.display = "none";
    $("uaeHeader").style.display = "none";
    $("loginBox").style.display = "block";
  }

  document.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && $("loginBox").style.display !== "none") {
      login();
    }
  });

  if (leaveFrom && leaveTo) {
    leaveFrom.addEventListener("change", function () {
      leaveTo.min = this.value;
    });
  }

  document.addEventListener("visibilitychange", () => {
    if (!document.hidden && window.currentID) {
      refreshAll();
      checkLocationStatus();
      handleDayRollover_();
    }
  });
}

window.onload = initialize;
</script>
</body>
</html>
