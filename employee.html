<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>نظام البصمة - نادي كلباء | الموظف</title>

  <!-- Tajawal -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0a0a;
      --card:#121212;
      --accent:#f6c21a;
      --accent-soft:#ffd24a;
      --text:#f5f5f5;
      --muted:#b7b7b7;
      --line:#202020;
      --ok:#22c55e;
      --bad:#ef4444;
      --radius:18px;
      --radius-lg:22px;
      --shadow:0 8px 25px rgba(0,0,0,.45);
      font-family:"Tajawal",sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    /* Login Card */
    .login-card{
      max-width:480px;
      margin:40px auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      padding:22px;
      box-shadow:var(--shadow);
      text-align:center;
    }
    .login-card h2{
      color:var(--accent);
      font-weight:900;
      margin-bottom:20px;
      font-size:22px;
    }
    label{color:var(--muted); display:block; text-align:right; margin-bottom:6px; font-weight:700;}
    input{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:1px solid #2a2a2a;
      background:#0e0e0e;
      color:#fff;
      margin-bottom:12px;
    }
    input:focus{outline:none;border-color:var(--accent);}

    .btn-yellow{
      width:100%;
      padding:16px;
      border-radius:14px;
      background:var(--accent);
      color:#111;
      font-weight:900;
      font-size:17px;
      border:none;
      cursor:pointer;
      transition:.2s;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      box-shadow:var(--shadow);
    }
    .btn-yellow:hover{background:var(--accent-soft);}

    .msg{
      margin-top:10px;
      font-size:14px;
      font-weight:700;
      padding:10px;
      border-radius:10px;
      display:none;
    }
    .msg.ok{
      display:block;
      background:rgba(34,197,94,.12);
      color:var(--ok);
      border:1px solid rgba(34,197,94,.4);
    }
    .msg.err{
      display:block;
      background:rgba(239,68,68,.12);
      color:var(--bad);
      border:1px solid rgba(239,68,68,.4);
    }

    /* Dashboard Hidden by Default */
    #dash{display:none;}

    /* Logout button */
    .logout-btn{
      background:var(--accent);
      color:#111;
      font-weight:900;
      border:none;
      padding:10px 18px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      position:absolute;
      top:20px;
      left:20px;
      box-shadow:var(--shadow);
      transition:.2s;
    }
    .logout-btn:hover{background:var(--accent-soft);}

    .hero{
      text-align:center;
      margin:20px 0 10px;
    }
    .hero h1{
      color:var(--accent);
      font-weight:900;
      font-size:30px;
    }
    .hero p{
      color:var(--muted);
      font-size:15px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:14px;
      margin-top:15px;
    }
    .card{
      background:linear-gradient(180deg,#151515,#0f0f0f);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:18px;
      text-align:center;
      box-shadow:var(--shadow);
    }
    .label{color:#d7d7d7;font-size:14px;font-weight:700;}
    .value{font-size:28px;font-weight:900;}

    .section{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:16px;
      margin-top:20px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }
    th, td{
      padding:12px;
      border-bottom:1px solid var(--line);
      text-align:right;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Login only -->
    <div id="loginBox" class="login-card">
      <h2>تسجيل الدخول</h2>

      <label>الرقم الوظيفي</label>
      <input id="empId" placeholder="مثال: 1">

      <label>الرمز السري (PIN)</label>
      <input id="empPin" type="password" inputmode="numeric" placeholder="4 أرقام">

      <button class="btn-yellow" onclick="login()">دخول</button>

      <div id="loginMsg" class="msg"></div>
    </div>

    <!-- Dashboard -->
    <div id="dash">

      <!-- Logout -->
      <button class="logout-btn" onclick="logout()">تسجيل خروج</button>

      <!-- Header -->
      <div class="hero">
        <h1>مرحباً بك في نظام البصمة</h1>
        <p>نظام لتسجيل الحضور والانصراف وإدارة ساعات العمل للموظفين</p>
      </div>

      <!-- Stats -->
      <div class="grid">
        <div class="card">
          <div class="label">ساعات العمل اليوم</div>
          <div id="sToday" class="value">00:00</div>
        </div>

        <div class="card">
          <div class="label">المتبقي اليوم</div>
          <div id="sLeft" class="value">00:00</div>
        </div>

        <div class="card">
          <div class="label">ساعات الأسبوع</div>
          <div id="sWeek" class="value">00:00</div>
        </div>

        <div class="card">
          <div class="label">آخر حركة</div>
          <div id="sLast" class="value">—</div>
        </div>
      </div>

      <!-- Punch buttons -->
      <button class="btn-yellow" onclick="punch('IN')">⬆️ بصمة دخول</button>
      <button class="btn-yellow" onclick="punch('OUT')">⬇️ بصمة خروج</button>

      <div id="punchMsg" class="msg"></div>

      <!-- Today table -->
      <div class="section">
        <h3 style="color:var(--accent);font-weight:900;">بصمات اليوم</h3>
        <table>
          <thead>
            <tr><th>الوقت</th><th>النوع</th></tr>
          </thead>
          <tbody id="todayTable">
            <tr><td colspan="2" style="text-align:center;color:#777">لا يوجد سجلات.</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

<script>
/*** YOUR LINKS ***/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzICdi_PWthlxiaZ7EA8NqZiUxUUK7XPgZNtyoTUO_ugPAZX-q9cTJ3LaIDEudlXPV0/exec";
const EMP_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?gid=0&single=true&output=csv";
const PUNCH_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbPiOqJCKgfP4hS_W1tmL1gP1ISn3e1ERUV61-WPzalHOXk0s1BLiAmTJT94hYeZyEG8NAZQgGGWm7/pub?gid=817419268&single=true&output=csv";

/*** GEOFENCE (Kalba Club) ***/
const CLUB_LAT = 25.0599489;
const CLUB_LNG = 56.3467097;
const ALLOWED_RADIUS_M = 300;

/*** HELPERS ***/
const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2,'0');
const ymd = d => d.toISOString().slice(0,10);
const nowHHMM = () => {
  const d=new Date();
  return pad(d.getHours())+":"+pad(d.getMinutes());
};
const timeToSec = hhmm => {
  if(!hhmm) return 0;
  const [h,m]=hhmm.split(":").map(Number);
  return h*3600 + m*60;
};
const secToHHMM = sec => {
  sec = Math.max(0, Math.floor(sec));
  const h=Math.floor(sec/3600);
  const m=Math.floor((sec%3600)/60);
  return pad(h)+":"+pad(m);
};

/*** HAVERSINE (meters) ***/
function distanceMeters(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const toRad = v => v*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function insideClub(lat,lng){
  const d = distanceMeters(lat,lng,CLUB_LAT,CLUB_LNG);
  return { ok:d <= ALLOWED_RADIUS_M, dist:d };
}

/*** LOGIN ***/
async function login(){
  const id = ($("empId").value||"").trim();
  const pin = ($("empPin").value||"").trim();
  const msg = $("loginMsg");

  if(!id || !pin){
    msg.className="msg err"; msg.style.display="block";
    msg.textContent="❌ يرجى إدخال البيانات";
    return;
  }

  const csv = await (await fetch(EMP_CSV)).text();
  const rows = csv.split("\n").map(r=>r.split(","));

  const found = rows.find(r => r[0]==id && r[2]==pin);

  if(!found){
    msg.className="msg err"; msg.style.display="block";
    msg.textContent="❌ البيانات غير صحيحة";
    return;
  }

  window.currentID = id;

  $("loginBox").style.display="none";
  $("dash").style.display="block";

  refreshAll();
}

/*** LOGOUT ***/
function logout(){
  window.currentID = null;
  $("dash").style.display="none";
  $("loginBox").style.display="block";
  $("empId").value="";
  $("empPin").value="";
}

async function getTodayRows() {
  const url = SCRIPT_URL + "?emp=" + window.currentID + "&view=today&nocache=" + Math.random();
  
  let txt = "";
  try {
    const res = await fetch(url, { method:"GET" });
    txt = await res.text();
  } catch(e){
    console.log("fallback to CSV");
    const csv = await (await fetch(PUNCH_CSV)).text();
    txt = csv;
  }

  const rows = txt.split("\n").map(r => r.split(","));
  const today = new Date().toISOString().slice(0,10);

  return rows.filter(r => r[0] == window.currentID && r[2] == today);
}

function canPunch(type, rows){
  if(rows.length === 0){
    if(type === "OUT") return { ok:false, error:"❌ لا يمكن تسجيل خروج قبل تسجيل دخول." };
    return { ok:true };
  }

  const lastType = rows[rows.length-1][3];

  if(lastType === type){
    return { ok:false, error:`❌ لا يمكن تسجيل ${type==="IN"?"دخول":"خروج"} مرتين.` };
  }

  return { ok:true };
}

async function punch(type){
  const msg = $("punchMsg");
  msg.style.display="none";

  const todayRows = await getTodayRows();
  const seq = canPunch(type, todayRows);

  if(!seq.ok){
    msg.className="msg err"; msg.style.display="block";
    msg.textContent = seq.error;
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    const geo = insideClub(lat,lng);
    if(!geo.ok){
      msg.className="msg err"; msg.style.display="block";
      msg.textContent="❌ يجب أن تكون داخل موقع النادي لإتمام البصمة.";
      return;
    }

    fetch(SCRIPT_URL,{
      method:"POST",
      mode:"no-cors",
      body:JSON.stringify({
        action:"punch",
        payload:{
          id:window.currentID,
          type,
          lat, lng,
          zone:"Kalba Club",
          dist:Math.round(geo.dist)
        }
      })
    });

    msg.className="msg ok"; msg.style.display="block";
    msg.textContent=`✔ تم تسجيل ${type==="IN"?"دخول":"خروج"}`;

    setTimeout(refreshAll, 900);

  }, _=>{
    msg.className="msg err"; msg.style.display="block";
    msg.textContent="❌ يرجى السماح بالموقع.";
  });
}

async function refreshAll(){
  const todayRows = await getTodayRows();

  const table = $("todayTable");
  if(!todayRows.length){
    table.innerHTML = `<tr><td colspan="2" style="color:#777;text-align:center;">لا يوجد سجلات.</td></tr>`;
  } else {
    table.innerHTML = todayRows.map(r=>{
      const t = (r[4]||"").slice(0,5);
      const tp = r[3]==="IN" ? "دخول" : "خروج";
      return `<tr><td>${t}</td><td>${tp}</td></tr>`;
    }).join("");
  }

  let work = 0;
  let lastIn = null;

  todayRows.forEach(r=>{
    const type = r[3];
    const t = (r[4]||"").slice(0,5);
    if(type==="IN") lastIn=t;
    else if(type==="OUT" && lastIn){
      work += timeToSec(t)-timeToSec(lastIn);
      lastIn=null;
    }
  });

  if(lastIn){
    work += timeToSec(nowHHMM()) - timeToSec(lastIn);
  }

  $("sToday").textContent = secToHHMM(work);
  $("sLeft").textContent  = secToHHMM(7*3600 - work);
}
</script>
</body>
</html>
